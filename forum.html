<!DOCTYPE html>
<html lang="fr">
<head>
    <!--
      Copyright (c) 2025 TLD - Tous droits reserves
      Toute copie, reproduction ou reutilisation non autorisee est interdite.
      Licence proprietaire - voir fichier LICENSE
    -->
    <meta charset="UTF-8">
    <meta http-equiv="content-language" content="fr">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8612974241235499"
         crossorigin="anonymous"></script>
    <meta name="author" content="TLD">
    <meta name="copyright" content="Copyright 2025 TLD. Tous droits reserves.">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
    <meta name="theme-color" content="#0a0a0f">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="img/1000074494.png">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="img/1000074494.png">
    <meta name="description" content="Forum communautaire TLD. Rejoignez des groupes de discussion sur l'IA, la tech et bien plus.">
    <meta property="og:title" content="Forum - TLD">
    <meta property="og:description" content="Rejoignez des groupes de discussion sur l'IA et la tech avec la communaute TLD.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://tino-le-doc.com/forum.html">
    <meta property="og:locale" content="fr_FR">
    <meta property="og:image" content="https://tino-le-doc.com/img/1000074494.png">
    <title>Forum üèõÔ∏è TLD</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;700&family=Syne:wght@700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/common.css">
    <style>
        :root{--bg:#0a0a0f;--cyan:#00f5ff;--magenta:#ff00aa;--yellow:#f5ff00;--orange:#ff9500;--green:#00ff88;--red:#ff4444;--text:#e8e8e8;--text-secondary:#a0a0a0;--glass:rgba(255,255,255,0.05);--glass-border:rgba(255,255,255,0.1)}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Space Grotesk',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;min-height:100dvh}
        .container{max-width:900px;margin:0 auto;padding:20px;position:relative;z-index:1}
        .logo{text-align:center;padding:15px 0}
        .logo img{max-width:150px;filter:drop-shadow(0 5px 20px rgba(255,165,0,0.4))}
        .back{color:var(--cyan);text-decoration:none;font-size:0.85rem}
        header{text-align:center;padding:15px 0}
        header h1{font-family:'Syne',sans-serif;font-size:1.8rem;background:linear-gradient(135deg,var(--magenta),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
        header p{color:var(--text-secondary);margin-top:8px;font-size:0.95rem}

        /* Auth section */
        .auth-section{background:var(--glass);border:1px solid var(--glass-border);border-radius:20px;padding:30px;text-align:center;margin:20px 0}
        .auth-section h2{font-family:'Syne',sans-serif;color:var(--cyan);margin-bottom:15px;font-size:1.2rem}
        .auth-section p{color:var(--text-secondary);margin-bottom:20px;font-size:0.9rem}
        .auth-btn{padding:12px 30px;background:linear-gradient(135deg,var(--magenta),var(--cyan));border:none;border-radius:12px;color:#fff;font-family:'Syne',sans-serif;font-size:1rem;font-weight:700;cursor:pointer;text-decoration:none;display:inline-block}
        .auth-btn:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(255,0,170,0.4)}

        /* Toolbar */
        .toolbar{display:flex;gap:10px;margin:20px 0;flex-wrap:wrap;align-items:center}
        .toolbar-left{display:flex;gap:10px;flex:1;flex-wrap:wrap}
        .search-input{flex:1;min-width:200px;padding:12px 18px;background:rgba(255,255,255,0.05);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-family:inherit;font-size:0.95rem}
        .search-input:focus{outline:none;border-color:var(--cyan)}
        .filter-select{padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-family:inherit;font-size:0.9rem;cursor:pointer;-webkit-appearance:none;appearance:none}
        .filter-select:focus{outline:none;border-color:var(--cyan)}
        .create-btn{padding:12px 20px;background:linear-gradient(135deg,var(--magenta),var(--cyan));border:none;border-radius:12px;color:#fff;font-family:'Syne',sans-serif;font-size:0.9rem;font-weight:700;cursor:pointer;white-space:nowrap}
        .create-btn:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(255,0,170,0.3)}

        /* Groups list */
        .groups-list{display:flex;flex-direction:column;gap:12px;margin:15px 0}
        .group-card{background:var(--glass);border:1px solid var(--glass-border);border-radius:16px;padding:20px;cursor:pointer;transition:all 0.3s}
        .group-card:hover{border-color:rgba(0,245,255,0.3);transform:translateY(-2px);box-shadow:0 8px 30px rgba(0,0,0,0.3)}
        .group-header{display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
        .group-info{flex:1}
        .group-name{font-family:'Syne',sans-serif;font-size:1.1rem;color:var(--text);margin-bottom:4px;display:flex;align-items:center;gap:8px}
        .group-name .lock{font-size:0.8rem}
        .group-desc{color:var(--text-secondary);font-size:0.85rem;line-height:1.4;margin-bottom:8px}
        .group-meta{display:flex;gap:15px;flex-wrap:wrap}
        .group-meta span{font-size:0.8rem;color:var(--text-secondary);display:flex;align-items:center;gap:4px}
        .group-category{padding:4px 10px;background:rgba(0,245,255,0.1);border:1px solid rgba(0,245,255,0.2);border-radius:20px;font-size:0.75rem;color:var(--cyan);white-space:nowrap}
        .group-card.joined{border-color:rgba(0,255,136,0.2)}
        .group-card.joined .group-category{background:rgba(0,255,136,0.1);border-color:rgba(0,255,136,0.2);color:var(--green)}

        /* Empty state */
        .empty-state{text-align:center;padding:60px 20px;color:var(--text-secondary)}
        .empty-state .icon{font-size:3rem;margin-bottom:15px}
        .empty-state p{margin-bottom:8px}

        /* Modal */
        .modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:10000;align-items:center;justify-content:center;padding:20px}
        .modal-overlay.active{display:flex}
        .modal{background:#12121a;border:1px solid var(--glass-border);border-radius:20px;padding:30px;max-width:500px;width:100%;max-height:90vh;overflow-y:auto;animation:slideIn 0.3s}
        .modal h2{font-family:'Syne',sans-serif;color:var(--cyan);margin-bottom:20px;font-size:1.2rem}
        .modal label{display:block;color:var(--text-secondary);font-size:0.85rem;margin-bottom:6px;margin-top:15px}
        .modal input,.modal textarea,.modal select{width:100%;padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-family:inherit;font-size:0.95rem}
        .modal input:focus,.modal textarea:focus,.modal select:focus{outline:none;border-color:var(--cyan)}
        .modal textarea{resize:vertical;min-height:80px}
        .modal-actions{display:flex;gap:10px;margin-top:25px;justify-content:flex-end}
        .modal-actions button{padding:10px 24px;border:none;border-radius:12px;font-family:'Syne',sans-serif;font-size:0.9rem;font-weight:700;cursor:pointer}
        .btn-cancel{background:rgba(255,255,255,0.1);color:var(--text)}
        .btn-cancel:hover{background:rgba(255,255,255,0.15)}
        .btn-confirm{background:linear-gradient(135deg,var(--magenta),var(--cyan));color:#fff}
        .btn-confirm:hover{transform:translateY(-1px)}

        /* Group view */
        .group-view{display:none}
        .group-view.active{display:block}
        .group-view-header{background:var(--glass);border:1px solid var(--glass-border);border-radius:16px;padding:20px;margin-bottom:15px;display:flex;align-items:center;gap:15px}
        .back-to-list{background:none;border:none;color:var(--cyan);font-size:1.2rem;cursor:pointer;padding:8px}
        .back-to-list:hover{transform:scale(1.1)}
        .group-view-info h2{font-family:'Syne',sans-serif;font-size:1.1rem;color:var(--text)}
        .group-view-info p{font-size:0.8rem;color:var(--text-secondary)}
        .group-view-actions{margin-left:auto;display:flex;gap:8px}
        .group-view-actions button{padding:8px 14px;background:rgba(255,255,255,0.08);border:1px solid var(--glass-border);border-radius:10px;color:var(--text);font-size:0.8rem;cursor:pointer;font-family:inherit}
        .group-view-actions button:hover{border-color:var(--cyan);color:var(--cyan)}

        /* Messages */
        .messages-container{background:var(--glass);border:1px solid var(--glass-border);border-radius:16px;overflow:hidden}
        .messages-list{padding:15px;min-height:300px;max-height:500px;overflow-y:auto;display:flex;flex-direction:column;gap:10px}
        .messages-list::-webkit-scrollbar{width:5px}
        .messages-list::-webkit-scrollbar-thumb{background:var(--cyan);border-radius:5px}
        .msg{display:flex;gap:10px;animation:slideIn 0.3s}
        .msg.own{flex-direction:row-reverse}
        .msg-avatar{width:36px;height:36px;background:linear-gradient(135deg,var(--orange),var(--yellow));border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--bg);font-size:0.9rem;flex-shrink:0}
        .msg.own .msg-avatar{background:linear-gradient(135deg,var(--magenta),var(--cyan))}
        .msg-bubble{max-width:75%;background:rgba(255,255,255,0.08);border-radius:16px 16px 16px 4px;padding:10px 14px}
        .msg.own .msg-bubble{background:linear-gradient(135deg,rgba(255,0,170,0.15),rgba(0,245,255,0.15));border-radius:16px 16px 4px 16px}
        .msg-bubble .name{font-weight:700;font-size:0.8rem;color:var(--orange);margin-bottom:3px}
        .msg.own .msg-bubble .name{color:var(--cyan)}
        .msg-bubble .text{line-height:1.4;word-wrap:break-word;font-size:0.92rem}
        .msg-bubble .time{font-size:0.7rem;color:rgba(255,255,255,0.35);margin-top:4px}
        .msg.pinned .msg-bubble{border:1px solid rgba(245,255,0,0.3);background:rgba(245,255,0,0.05)}
        .msg.pinned .pin-label{font-size:0.7rem;color:var(--yellow);margin-bottom:4px}
        .msg-empty{text-align:center;padding:50px 20px;color:var(--text-secondary)}
        .msg-empty .icon{font-size:2.5rem;margin-bottom:10px}
        .msg-input-area{padding:15px;border-top:1px solid var(--glass-border);display:flex;gap:10px}
        .msg-input-area input{flex:1;padding:12px 18px;background:rgba(255,255,255,0.05);border:1px solid var(--glass-border);border-radius:25px;color:var(--text);font-family:inherit;font-size:16px}
        .msg-input-area input:focus{outline:none;border-color:var(--cyan)}
        .msg-input-area button{padding:12px 18px;background:linear-gradient(135deg,var(--magenta),var(--cyan));border:none;border-radius:25px;color:#fff;font-size:1.1rem;cursor:pointer}
        .msg-input-area button:disabled{opacity:0.5;cursor:not-allowed}

        /* Members modal */
        .members-list{display:flex;flex-direction:column;gap:8px;margin-top:10px}
        .member-item{display:flex;align-items:center;gap:10px;padding:10px;background:rgba(255,255,255,0.03);border-radius:10px}
        .member-avatar{width:32px;height:32px;background:linear-gradient(135deg,var(--orange),var(--yellow));border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--bg);font-size:0.8rem}
        .member-name{font-size:0.9rem}
        .member-role{font-size:0.7rem;color:var(--cyan);margin-left:auto}

        /* Invites badge */
        .invites-btn{position:relative}
        .invites-badge{position:absolute;top:-4px;right:-4px;width:18px;height:18px;background:var(--red);border-radius:50%;font-size:0.65rem;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}

        /* Toast */
        .toast{position:fixed;bottom:20px;right:20px;padding:15px 25px;background:var(--green);color:var(--bg);border-radius:10px;font-weight:700;transform:translateX(150%);transition:transform 0.3s;z-index:10001}
        .toast.show{transform:translateX(0)}
        .toast.error{background:var(--red);color:#fff}

        /* Footer */
        footer{text-align:center;padding:30px 20px;color:var(--text-secondary);font-size:0.85rem;margin-top:30px}
        footer a{color:var(--cyan);text-decoration:none}
        footer a:hover{text-decoration:underline}
        .footer-links{display:flex;justify-content:center;gap:20px;margin-top:12px;flex-wrap:wrap}

        /* Responsive */
        @media(max-width:768px){
            .container{padding:12px}
            .logo img{max-width:80px}
            header h1{font-size:1.4rem}
            .toolbar{flex-direction:column}
            .toolbar-left{flex-direction:column}
            .search-input{min-width:unset}
            .group-header{flex-direction:column}
            .group-view-header{flex-direction:column;align-items:flex-start;gap:10px}
            .group-view-actions{margin-left:0;width:100%}
            .group-view-actions button{flex:1;text-align:center}
            .messages-list{max-height:400px}
            .msg-bubble{max-width:85%}
            .footer-links{gap:12px}
        }
        @media(max-width:380px){
            header h1{font-size:1.2rem}
            .group-name{font-size:1rem}
            .modal{padding:20px}
        }
    </style>
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Organization",
      "name": "TLD",
      "url": "https://tino-le-doc.com",
      "logo": "https://tino-le-doc.com/img/1000074494.png"
    }
    </script>
</head>
<body>
    <a href="appareils-connectes.html" class="tino-iot-banner" aria-label="Tino Assistant IoT">
        <span class="tino-iot-banner-icon">üì°</span>
        <span class="tino-iot-banner-text">
            <span class="tino-iot-banner-title">Tino Assistant IoT</span>
            <span class="tino-iot-banner-sub">Appareils connectes &amp; IA</span>
        </span>
        <span class="tino-iot-banner-dot"></span>
    </a>
    <a href="#main-content" class="skip-link">Aller au contenu</a>
    <nav class="nav-dropdown" aria-label="Navigation rapide">
        <select onchange="if(this.value) window.location.href=this.value" aria-label="Naviguer vers une page">
            <option value="">&#9776; Menu</option>
            <option value="index.html">&#127968; Accueil</option>
            <option value="veille-techno.html">&#128225; Veille Techno</option>
            <option value="quiz.html">&#129504; Quiz</option>
            <option value="sondages.html">&#128202; Sondages</option>
            <option value="debat.html">&#9876;&#65039; D&eacute;bat</option>
            <option value="tchat.html">&#128172; Tchat</option>
            <option value="messagerie.html">&#9993;&#65039; Messagerie</option>
            <option value="forum.html" selected>&#127963;&#65039; Forum</option>
            <option value="avis.html">&#11088; Avis</option>
            <option value="compte.html">&#128100; Compte</option>
            <option value="premium.html">&#128081; Premium</option>
            <option value="boutique.html">&#128722; Boutique</option>
            <option value="appareils-connectes.html">&#128225; Appareils IA</option>
            <option value="contact.html">&#128231; Contact</option>
            <option value="confidentialite.html">&#128274; Confidentialit&eacute;</option>
        </select>
    </nav>

<div class="container" id="main-content">
    <div class="logo"><img src="img/1000074494.png" alt="TLD"></div>
    <a href="index.html" class="back">‚Üê Retour</a>

    <header>
        <h1>üèõÔ∏è Forum</h1>
        <p>Rejoignez des groupes de discussion et partagez vos idees</p>
    </header>

    <!-- Auth required -->
    <section class="auth-section" id="authSection">
        <h2>üîí Connexion requise</h2>
        <p>Connectez-vous pour acceder au forum et rejoindre des groupes de discussion.</p>
        <a href="compte.html" class="auth-btn">Se connecter</a>
    </section>

    <!-- Forum content (hidden until auth) -->
    <div id="forumContent" style="display:none">

        <!-- Groups list view -->
        <div id="groupsListView">
            <div class="toolbar">
                <div class="toolbar-left">
                    <input type="text" class="search-input" id="searchInput" placeholder="üîç Rechercher un groupe..." maxlength="50">
                    <select class="filter-select" id="filterCategory">
                        <option value="">Toutes les categories</option>
                        <option value="ia">ü§ñ Intelligence Artificielle</option>
                        <option value="dev">üíª Developpement</option>
                        <option value="tech">üîß Tech & Gadgets</option>
                        <option value="science">üî¨ Science</option>
                        <option value="gaming">üéÆ Gaming</option>
                        <option value="autre">üí¨ Autre</option>
                    </select>
                </div>
                <button class="create-btn" id="createGroupBtn">+ Creer un groupe</button>
                <button class="create-btn invites-btn" id="invitesBtn" style="background:rgba(255,255,255,0.1)">
                    üì© Invitations <span class="invites-badge" id="invitesBadge" style="display:none">0</span>
                </button>
            </div>

            <div class="groups-list" id="groupsList">
                <div class="empty-state" id="emptyGroups">
                    <div class="icon">üèõÔ∏è</div>
                    <p>Aucun groupe pour le moment</p>
                    <p style="font-size:0.85rem">Soyez le premier a creer un groupe !</p>
                </div>
            </div>
        </div>

        <!-- Group detail view -->
        <div class="group-view" id="groupView">
            <div class="group-view-header">
                <button class="back-to-list" id="backToList">‚Üê</button>
                <div class="group-view-info">
                    <h2 id="groupViewName"></h2>
                    <p id="groupViewDesc"></p>
                </div>
                <div class="group-view-actions">
                    <button id="membersBtn">üë• Membres</button>
                    <button id="leaveGroupBtn">üö™ Quitter</button>
                </div>
            </div>
            <div class="messages-container">
                <div class="messages-list" id="messagesList">
                    <div class="msg-empty"><div class="icon">üí¨</div><p>Aucun message. Lancez la conversation !</p></div>
                </div>
                <div class="msg-input-area">
                    <input type="text" id="msgInput" placeholder="Ecrire un message..." maxlength="500" autocomplete="off">
                    <button id="sendMsgBtn" type="button">üì§</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create group modal -->
    <div class="modal-overlay" id="createModal">
        <div class="modal">
            <h2>‚ú® Creer un groupe</h2>
            <label for="groupNameInput">Nom du groupe</label>
            <input type="text" id="groupNameInput" placeholder="Ex: IA & Machine Learning" maxlength="50">
            <label for="groupDescInput">Description</label>
            <textarea id="groupDescInput" placeholder="Decrivez le theme du groupe..." maxlength="200"></textarea>
            <label for="groupCatInput">Categorie</label>
            <select id="groupCatInput">
                <option value="ia">ü§ñ Intelligence Artificielle</option>
                <option value="dev">üíª Developpement</option>
                <option value="tech">üîß Tech & Gadgets</option>
                <option value="science">üî¨ Science</option>
                <option value="gaming">üéÆ Gaming</option>
                <option value="autre">üí¨ Autre</option>
            </select>
            <label for="groupPublicInput">Visibilite</label>
            <select id="groupPublicInput">
                <option value="true">üåç Public - Tout le monde peut rejoindre</option>
                <option value="false">üîí Prive - Sur invitation uniquement</option>
            </select>
            <div class="modal-actions">
                <button class="btn-cancel" id="cancelCreate">Annuler</button>
                <button class="btn-confirm" id="confirmCreate">Creer</button>
            </div>
        </div>
    </div>

    <!-- Members modal -->
    <div class="modal-overlay" id="membersModal">
        <div class="modal">
            <h2>üë• Membres du groupe</h2>
            <div class="members-list" id="membersList"></div>
            <div class="modal-actions">
                <button class="btn-cancel" id="closeMembersModal">Fermer</button>
            </div>
        </div>
    </div>

    <!-- Invites modal -->
    <div class="modal-overlay" id="invitesModal">
        <div class="modal">
            <h2>üì© Invitations</h2>
            <div id="invitesList" style="margin-top:10px">
                <p style="color:var(--text-secondary);text-align:center;padding:20px">Aucune invitation</p>
            </div>
            <div class="modal-actions">
                <button class="btn-cancel" id="closeInvitesModal">Fermer</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <footer role="contentinfo">
        Cree avec ‚ù§Ô∏è par <strong>TLD</strong> | Propulse par <a href="https://claude.ai" target="_blank">Claude AI</a>
        <nav aria-label="Navigation principale">
        <div class="footer-links">
            <a href="index.html">üè† Accueil</a>
            <a href="quiz.html">üß† Quiz</a>
            <a href="sondages.html">üìä Sondages</a>
            <a href="debat.html">‚öîÔ∏è Debat</a>
            <a href="tchat.html">üí¨ Tchat</a>
            <a href="messagerie.html">‚úâÔ∏è Messagerie</a>
            <a href="avis.html">‚≠ê Avis</a>
            <a href="compte.html">üë§ Compte</a>
            <a href="premium.html">üëë Premium</a>
            <a href="boutique.html">üõí Boutique</a>
            <a href="appareils-connectes.html">üì° Appareils IA</a>
            <a href="contact.html">üìß Contact</a>
            <a href="confidentialite.html">üîí Confidentialite</a>
            <a href="veille-techno.html">üì° Veille Techno</a>
        </div>
        </nav>
    </footer>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="js/firebase-config.js"></script>
<script>
// ==================== INIT ====================
const auth = firebaseAuth;
const db = firebaseDb;
let currentUser = null;
let currentUserName = '';
let currentGroupId = null;
let messagesListener = null;

const CATEGORIES = {
    ia: 'ü§ñ IA',
    dev: 'üíª Dev',
    tech: 'üîß Tech',
    science: 'üî¨ Science',
    gaming: 'üéÆ Gaming',
    autre: 'üí¨ Autre'
};

// ==================== AUTH ====================
auth.onAuthStateChanged(async user => {
    if (user && !user.isAnonymous) {
        currentUser = user;
        try {
            const snap = await db.ref('users/' + user.uid).once('value');
            const profile = snap.val();
            currentUserName = (profile && profile.pseudo) || user.displayName || user.email.split('@')[0];
        } catch(e) {
            currentUserName = user.email ? user.email.split('@')[0] : 'Utilisateur';
        }
        document.getElementById('authSection').style.display = 'none';
        document.getElementById('forumContent').style.display = 'block';
        loadGroups();
        loadInvites();
    } else {
        currentUser = null;
        document.getElementById('authSection').style.display = 'block';
        document.getElementById('forumContent').style.display = 'none';
    }
});

// ==================== GROUPS ====================
function loadGroups() {
    const ref = db.ref('forumGroups');
    ref.orderByChild('createdAt').on('value', snap => {
        renderGroups(snap);
    });
}

function renderGroups(snap) {
    const container = document.getElementById('groupsList');
    const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
    const filterCat = document.getElementById('filterCategory').value;
    const groups = [];

    snap.forEach(child => {
        const g = child.val();
        g.id = child.key;
        groups.push(g);
    });

    groups.reverse();

    const filtered = groups.filter(g => {
        if (filterCat && g.category !== filterCat) return false;
        if (searchTerm && !(g.name || '').toLowerCase().includes(searchTerm) && !(g.description || '').toLowerCase().includes(searchTerm)) return false;
        return true;
    });

    if (filtered.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="icon">üèõÔ∏è</div><p>Aucun groupe trouve</p></div>';
        return;
    }

    container.innerHTML = filtered.map(g => {
        const catLabel = CATEGORIES[g.category] || g.category || '';
        const isPublic = g.isPublic !== false;
        const memberCount = g.memberCount || 0;
        const date = g.createdAt ? new Date(g.createdAt).toLocaleDateString('fr-FR') : '';
        return `
            <div class="group-card" data-id="${escapeHtml(g.id)}" onclick="openGroup('${escapeHtml(g.id)}')">
                <div class="group-header">
                    <div class="group-info">
                        <div class="group-name">
                            ${isPublic ? '' : '<span class="lock">üîí</span>'}
                            ${escapeHtml(g.name || 'Sans nom')}
                        </div>
                        <div class="group-desc">${escapeHtml(g.description || '')}</div>
                        <div class="group-meta">
                            <span>üë• ${memberCount} membre${memberCount > 1 ? 's' : ''}</span>
                            <span>üìÖ ${date}</span>
                        </div>
                    </div>
                    <div class="group-category">${catLabel}</div>
                </div>
            </div>`;
    }).join('');
}

// Search & filter
document.getElementById('searchInput').addEventListener('input', () => {
    db.ref('forumGroups').orderByChild('createdAt').once('value', snap => renderGroups(snap));
});
document.getElementById('filterCategory').addEventListener('change', () => {
    db.ref('forumGroups').orderByChild('createdAt').once('value', snap => renderGroups(snap));
});

// ==================== CREATE GROUP ====================
document.getElementById('createGroupBtn').addEventListener('click', () => {
    document.getElementById('createModal').classList.add('active');
});
document.getElementById('cancelCreate').addEventListener('click', () => {
    document.getElementById('createModal').classList.remove('active');
});
document.getElementById('createModal').addEventListener('click', e => {
    if (e.target === e.currentTarget) document.getElementById('createModal').classList.remove('active');
});

document.getElementById('confirmCreate').addEventListener('click', async () => {
    const name = document.getElementById('groupNameInput').value.trim();
    const desc = document.getElementById('groupDescInput').value.trim();
    const cat = document.getElementById('groupCatInput').value;
    const isPublic = document.getElementById('groupPublicInput').value === 'true';

    if (!name || name.length < 3) {
        showToast('Nom trop court (min 3 caracteres)', true);
        return;
    }
    if (name.length > 50) {
        showToast('Nom trop long (max 50 caracteres)', true);
        return;
    }

    const modCheck = ModerationSystem.checkContent(name + ' ' + desc);
    if (!modCheck.isValid) {
        showToast(modCheck.message, true);
        return;
    }

    try {
        const newRef = db.ref('forumGroups').push();
        await newRef.set({
            name: name,
            description: desc,
            category: cat,
            isPublic: isPublic,
            createdBy: currentUser.uid,
            createdByName: currentUserName,
            createdAt: Date.now(),
            memberCount: 1
        });

        await db.ref('forumMembers/' + newRef.key + '/' + currentUser.uid).set({
            name: currentUserName,
            role: 'admin',
            joinedAt: Date.now()
        });

        document.getElementById('createModal').classList.remove('active');
        document.getElementById('groupNameInput').value = '';
        document.getElementById('groupDescInput').value = '';
        showToast('Groupe cree !');
    } catch(e) {
        console.error('Erreur creation:', e);
        showToast('Erreur lors de la creation', true);
    }
});

// ==================== OPEN GROUP ====================
async function openGroup(groupId) {
    if (!currentUser) return;

    try {
        const groupSnap = await db.ref('forumGroups/' + groupId).once('value');
        const group = groupSnap.val();
        if (!group) { showToast('Groupe introuvable', true); return; }

        const memberSnap = await db.ref('forumMembers/' + groupId + '/' + currentUser.uid).once('value');
        const isMember = memberSnap.exists();

        if (!isMember) {
            if (group.isPublic === false) {
                showToast('Ce groupe est prive. Vous devez etre invite.', true);
                return;
            }
            await db.ref('forumMembers/' + groupId + '/' + currentUser.uid).set({
                name: currentUserName,
                role: 'member',
                joinedAt: Date.now()
            });
            await db.ref('forumGroups/' + groupId + '/memberCount').transaction(c => (c || 0) + 1);
            showToast('Vous avez rejoint le groupe !');
        }

        currentGroupId = groupId;
        document.getElementById('groupViewName').textContent = group.name || 'Sans nom';
        document.getElementById('groupViewDesc').textContent = group.description || '';
        document.getElementById('groupsListView').style.display = 'none';
        document.getElementById('groupView').classList.add('active');
        loadMessages(groupId);
        document.getElementById('msgInput').focus();
    } catch(e) {
        console.error('Erreur ouverture groupe:', e);
        showToast('Erreur', true);
    }
}

// Back to list
document.getElementById('backToList').addEventListener('click', () => {
    if (messagesListener) {
        db.ref('forumMessages/' + currentGroupId).off('child_added', messagesListener);
        messagesListener = null;
    }
    currentGroupId = null;
    document.getElementById('groupView').classList.remove('active');
    document.getElementById('groupsListView').style.display = 'block';
});

// ==================== MESSAGES ====================
function loadMessages(groupId) {
    const container = document.getElementById('messagesList');
    container.innerHTML = '<div class="msg-empty"><div class="icon">üí¨</div><p>Chargement...</p></div>';

    if (messagesListener) {
        db.ref('forumMessages/' + currentGroupId).off('child_added', messagesListener);
    }

    let first = true;
    messagesListener = db.ref('forumMessages/' + groupId).orderByChild('timestamp').limitToLast(100).on('child_added', snap => {
        if (first) {
            container.innerHTML = '';
            first = false;
        }
        const m = snap.val();
        if (!m) return;
        appendMessage(m);
    });

    setTimeout(() => {
        if (first) {
            container.innerHTML = '<div class="msg-empty"><div class="icon">üí¨</div><p>Aucun message. Lancez la conversation !</p></div>';
            first = false;
        }
    }, 2000);
}

function appendMessage(m) {
    const container = document.getElementById('messagesList');
    const empty = container.querySelector('.msg-empty');
    if (empty) empty.remove();

    const div = document.createElement('div');
    const isOwn = m.userId === currentUser.uid;
    div.className = 'msg' + (isOwn ? ' own' : '') + (m.isPinned ? ' pinned' : '');

    const initial = (m.userName || '?').charAt(0).toUpperCase();
    const time = m.timestamp ? new Date(m.timestamp).toLocaleTimeString('fr-FR', {hour:'2-digit',minute:'2-digit'}) : '';

    div.innerHTML = `
        <div class="msg-avatar">${initial}</div>
        <div class="msg-bubble">
            ${m.isPinned ? '<div class="pin-label">üìå Message epingle</div>' : ''}
            <div class="name">${escapeHtml(m.userName || '?')}</div>
            <div class="text">${escapeHtml(m.text || '')}</div>
            <div class="time">${time}</div>
        </div>`;

    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
}

// ==================== SEND MESSAGE ====================
const RateLimiter = {
    last: 0, count: 0, start: Date.now(),
    canSend() {
        const now = Date.now();
        if (now - this.start > 60000) { this.start = now; this.count = 0; }
        if (now - this.last < 1500) return false;
        if (this.count >= 30) return false;
        return true;
    },
    record() { this.last = Date.now(); this.count++; }
};

function sendMessage() {
    const input = document.getElementById('msgInput');
    const text = input.value.trim();
    if (!text || !currentUser || !currentGroupId) return;

    if (text.length > 500) {
        showToast('Message trop long (max 500 caracteres)', true);
        return;
    }

    const modCheck = ModerationSystem.checkContent(text);
    if (!modCheck.isValid) {
        showToast(modCheck.message, true);
        return;
    }

    if (!RateLimiter.canSend()) {
        showToast('Attendez avant d\'envoyer un autre message', true);
        return;
    }

    db.ref('forumMessages/' + currentGroupId).push({
        userId: currentUser.uid,
        userName: currentUserName,
        text: text,
        timestamp: Date.now(),
        isPinned: false
    });

    RateLimiter.record();
    input.value = '';
    input.focus();
}

document.getElementById('sendMsgBtn').addEventListener('click', sendMessage);
document.getElementById('msgInput').addEventListener('keypress', e => {
    if (e.key === 'Enter') sendMessage();
});

// ==================== MEMBERS ====================
document.getElementById('membersBtn').addEventListener('click', async () => {
    if (!currentGroupId) return;
    const container = document.getElementById('membersList');
    container.innerHTML = '<p style="text-align:center;color:var(--text-secondary)">Chargement...</p>';
    document.getElementById('membersModal').classList.add('active');

    try {
        const snap = await db.ref('forumMembers/' + currentGroupId).once('value');
        if (!snap.exists()) {
            container.innerHTML = '<p style="text-align:center;color:var(--text-secondary)">Aucun membre</p>';
            return;
        }
        let html = '';
        snap.forEach(child => {
            const m = child.val();
            const initial = (m.name || '?').charAt(0).toUpperCase();
            const roleLabel = m.role === 'admin' ? 'üëë Admin' : 'Membre';
            html += `
                <div class="member-item">
                    <div class="member-avatar">${initial}</div>
                    <span class="member-name">${escapeHtml(m.name || 'Inconnu')}</span>
                    <span class="member-role">${roleLabel}</span>
                </div>`;
        });
        container.innerHTML = html;
    } catch(e) {
        container.innerHTML = '<p style="color:var(--red)">Erreur de chargement</p>';
    }
});

document.getElementById('closeMembersModal').addEventListener('click', () => {
    document.getElementById('membersModal').classList.remove('active');
});
document.getElementById('membersModal').addEventListener('click', e => {
    if (e.target === e.currentTarget) document.getElementById('membersModal').classList.remove('active');
});

// ==================== LEAVE GROUP ====================
document.getElementById('leaveGroupBtn').addEventListener('click', async () => {
    if (!currentGroupId || !currentUser) return;
    if (!confirm('Quitter ce groupe ?')) return;

    try {
        await db.ref('forumMembers/' + currentGroupId + '/' + currentUser.uid).remove();
        await db.ref('forumGroups/' + currentGroupId + '/memberCount').transaction(c => Math.max((c || 1) - 1, 0));
        showToast('Vous avez quitte le groupe');
        document.getElementById('backToList').click();
    } catch(e) {
        showToast('Erreur', true);
    }
});

// ==================== INVITES ====================
function loadInvites() {
    if (!currentUser) return;
    db.ref('forumInvites/' + currentUser.uid).on('value', snap => {
        const badge = document.getElementById('invitesBadge');
        if (!snap.exists() || snap.numChildren() === 0) {
            badge.style.display = 'none';
            return;
        }
        badge.style.display = 'flex';
        badge.textContent = snap.numChildren();
    });
}

document.getElementById('invitesBtn').addEventListener('click', async () => {
    if (!currentUser) return;
    document.getElementById('invitesModal').classList.add('active');
    const container = document.getElementById('invitesList');
    container.innerHTML = '<p style="text-align:center;color:var(--text-secondary)">Chargement...</p>';

    try {
        const snap = await db.ref('forumInvites/' + currentUser.uid).once('value');
        if (!snap.exists() || snap.numChildren() === 0) {
            container.innerHTML = '<p style="color:var(--text-secondary);text-align:center;padding:20px">Aucune invitation</p>';
            return;
        }
        container.innerHTML = '';
        snap.forEach(child => {
            const inv = child.val();
            const invKey = child.key;
            const groupId = inv.groupId || '';

            const row = document.createElement('div');
            row.className = 'member-item';
            row.style.justifyContent = 'space-between';
            row.innerHTML = `
                <div style="display:flex;align-items:center;gap:10px">
                    <span>üì©</span>
                    <div>
                        <div style="font-size:0.9rem">${escapeHtml(inv.groupName || 'Groupe')}</div>
                        <div style="font-size:0.75rem;color:var(--text-secondary)">Invite par ${escapeHtml(inv.invitedBy || '?')}</div>
                    </div>
                </div>
                <div style="display:flex;gap:6px">
                    <button class="invite-accept-btn" style="padding:6px 12px;background:var(--green);color:var(--bg);border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:0.8rem">Accepter</button>
                    <button class="invite-decline-btn" style="padding:6px 12px;background:rgba(255,255,255,0.1);color:var(--text);border:none;border-radius:8px;cursor:pointer;font-size:0.8rem">Refuser</button>
                </div>`;

            row.querySelector('.invite-accept-btn').addEventListener('click', () => acceptInvite(invKey, groupId));
            row.querySelector('.invite-decline-btn').addEventListener('click', () => declineInvite(invKey));
            container.appendChild(row);
        });
    } catch(e) {
        console.error('Erreur invitations:', e);
        container.innerHTML = '<p style="color:var(--red)">Erreur de chargement</p>';
    }
});

document.getElementById('closeInvitesModal').addEventListener('click', () => {
    document.getElementById('invitesModal').classList.remove('active');
});
document.getElementById('invitesModal').addEventListener('click', e => {
    if (e.target === e.currentTarget) document.getElementById('invitesModal').classList.remove('active');
});

async function acceptInvite(inviteKey, groupId) {
    if (!currentUser) return;
    try {
        await db.ref('forumMembers/' + groupId + '/' + currentUser.uid).set({
            name: currentUserName,
            role: 'member',
            joinedAt: Date.now()
        });
        await db.ref('forumGroups/' + groupId + '/memberCount').transaction(c => (c || 0) + 1);
        await db.ref('forumInvites/' + currentUser.uid + '/' + inviteKey).remove();
        showToast('Invitation acceptee !');
        document.getElementById('invitesModal').classList.remove('active');
    } catch(e) {
        showToast('Erreur', true);
    }
}

async function declineInvite(inviteKey) {
    if (!currentUser) return;
    try {
        await db.ref('forumInvites/' + currentUser.uid + '/' + inviteKey).remove();
        showToast('Invitation refusee');
        document.getElementById('invitesBtn').click();
    } catch(e) {
        showToast('Erreur', true);
    }
}

console.log('‚úÖ Forum pret');
</script>
</body>
</html>
