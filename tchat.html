<!DOCTYPE html>
<html lang="fr">
<head>
    <!--
      Copyright (c) 2025 TLD - Tous droits reserves
      Toute copie, reproduction ou reutilisation non autorisee est interdite.
      Licence proprietaire - voir fichier LICENSE
    -->
    <meta charset="UTF-8">
    <meta http-equiv="content-language" content="fr">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8612974241235499"
         crossorigin="anonymous"></script>
    <meta name="author" content="TLD">
    <meta name="copyright" content="Copyright 2025 TLD. Tous droits reserves.">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
    <meta name="theme-color" content="#0a0a0f">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="img/1000074494.png">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="img/1000074494.png">
    <meta name="description" content="Tchat en direct avec la communaute TLD. Discutez de l'IA, partagez vos idees et connectez-vous en temps reel." data-i18n="tchat.desc">
    <meta property="og:title" content="Tchat Live - TLD" data-i18n="tchat.title">
    <meta property="og:description" content="Discutez de l'IA en direct avec la communaute TLD." data-i18n="tchat.desc">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://tino-le-doc.com/tchat.html">
    <meta property="og:locale" content="fr_FR" data-i18n="og.locale">
    <meta property="og:image" content="https://tino-le-doc.com/img/1000074494.png">
    <title data-i18n="tchat.title">Tchat Live üí¨ TLD</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;700&family=Syne:wght@700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/common.css">
    <style>
        :root{--bg:#0a0a0f;--cyan:#00f5ff;--magenta:#ff00aa;--yellow:#f5ff00;--orange:#ff9500;--green:#00ff88;--red:#ff4444;--text:#e8e8e8;--glass:rgba(255,255,255,0.05)}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Space Grotesk',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;min-height:100dvh}
        .container{max-width:1200px;margin:0 auto;padding:15px;min-height:100vh;min-height:100dvh}
        .logo{text-align:center;padding:10px 0}
        .logo img{max-width:150px;filter:drop-shadow(0 5px 20px rgba(255,165,0,0.4))}
        .back{color:var(--cyan);text-decoration:none;font-size:0.85rem}
        header{text-align:center;padding:15px 0}
        header h1{font-family:'Syne',sans-serif;font-size:1.8rem;background:linear-gradient(135deg,var(--magenta),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
        .badges{display:flex;gap:8px;justify-content:center;margin-top:10px;flex-wrap:wrap}
        .badge{padding:5px 12px;background:var(--glass);border:1px solid var(--green);border-radius:20px;font-size:0.75rem;color:var(--green);display:flex;align-items:center;gap:5px}
        .badge.live{border-color:var(--magenta);color:var(--magenta);animation:pulse 2s infinite}
        .badge.secure{border-color:var(--green);color:var(--green)}
        @keyframes pulse{0%,100%{box-shadow:0 0 10px rgba(255,0,170,0.3)}50%{box-shadow:0 0 25px rgba(255,0,170,0.6)}}
        .live-dot{width:8px;height:8px;background:var(--green);border-radius:50%;animation:blink 1.5s infinite}
        @keyframes blink{0%,100%{opacity:1}50%{opacity:0.4}}


        .login{background:var(--glass);border:1px solid rgba(255,255,255,0.1);border-radius:20px;padding:30px;text-align:center;margin:20px 0}
        .login h2{font-family:'Syne',sans-serif;color:var(--cyan);margin-bottom:20px}
        .login input{width:100%;max-width:280px;padding:12px 18px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.15);border-radius:12px;color:var(--text);font-family:inherit;font-size:1rem;text-align:center;margin-bottom:15px}
        .login input:focus{outline:none;border-color:var(--cyan)}
        .login button{padding:12px 35px;background:linear-gradient(135deg,var(--magenta),var(--cyan));border:none;border-radius:12px;color:#fff;font-family:'Syne',sans-serif;font-size:1rem;font-weight:700;cursor:pointer}
        .login button:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(255,0,170,0.4)}
        .login button:disabled{opacity:0.5;cursor:not-allowed;transform:none}

        .chat{display:none;flex-direction:column;background:var(--glass);border:1px solid rgba(255,255,255,0.1);border-radius:20px;overflow:hidden;margin:10px 0}
        .chat.active{display:flex}
        .chat-head{padding:12px 15px;background:rgba(255,255,255,0.03);border-bottom:1px solid rgba(255,255,255,0.08);display:flex;justify-content:space-between;align-items:center}
        .chat-head span{font-family:'Syne',sans-serif;display:flex;align-items:center;gap:8px}
        .online{font-size:0.8rem;color:var(--cyan)}

        .messages{flex:1;overflow-y:auto;padding:15px;display:flex;flex-direction:column;gap:12px;min-height:250px;max-height:400px}
        .messages::-webkit-scrollbar{width:5px}
        .messages::-webkit-scrollbar-thumb{background:var(--cyan);border-radius:5px}

        .msg{display:flex;gap:10px;animation:slideIn 0.3s}
        @keyframes slideIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        .msg.own{flex-direction:row-reverse}
        .avatar{width:36px;height:36px;background:linear-gradient(135deg,var(--orange),var(--yellow));border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--bg);font-size:0.9rem;flex-shrink:0}
        .msg.own .avatar{background:linear-gradient(135deg,var(--magenta),var(--cyan))}
        .bubble{max-width:75%;background:rgba(255,255,255,0.08);border-radius:16px 16px 16px 4px;padding:10px 14px}
        .msg.own .bubble{background:linear-gradient(135deg,rgba(255,0,170,0.2),rgba(0,245,255,0.2));border-radius:16px 16px 4px 16px}
        .msg-head{display:flex;gap:8px;align-items:center;margin-bottom:4px}
        .msg-name{font-weight:700;font-size:0.85rem;color:var(--orange)}
        .msg.own .msg-name{color:var(--cyan)}
        .msg-time{font-size:0.7rem;color:rgba(255,255,255,0.4)}
        .msg-text{line-height:1.4;word-wrap:break-word}
        .msg-text img{max-width:180px;max-height:130px;border-radius:10px;margin-top:5px;display:block}

        .sys{text-align:center;padding:8px;font-size:0.8rem;color:rgba(255,255,255,0.5);font-style:italic}
        .sys.join{color:var(--green)}
        .sys.leave{color:var(--red)}

        .empty{text-align:center;padding:40px;color:rgba(255,255,255,0.4)}
        .empty .icon{font-size:2.5rem;margin-bottom:10px}

        .typing{display:none;padding:8px 15px;font-size:0.8rem;color:rgba(255,255,255,0.5);font-style:italic}
        .typing.active{display:block}

        .input-area{padding:12px 15px;padding-bottom:calc(12px + env(safe-area-inset-bottom, 0px));background:rgba(255,255,255,0.03);border-top:1px solid rgba(255,255,255,0.08);flex-shrink:0}
        .warn{display:none;padding:8px 12px;background:rgba(255,68,68,0.15);border:1px solid var(--red);border-radius:10px;margin-bottom:10px;color:var(--red);font-size:0.8rem}
        .rate-limit{display:none;padding:8px 12px;background:rgba(255,149,0,0.15);border:1px solid var(--orange);border-radius:10px;margin-bottom:10px;color:var(--orange);font-size:0.8rem}

        .toolbar{display:flex;gap:5px;margin-bottom:10px}
        .tool-btn{width:42px;height:42px;border:none;background:rgba(255,255,255,0.08);border-radius:10px;cursor:pointer;font-size:1.2rem;transition:all 0.2s}
        .tool-btn:hover{background:rgba(255,255,255,0.15);transform:scale(1.1)}

        .picker{display:none;background:rgba(15,15,25,0.98);border:1px solid rgba(255,255,255,0.1);border-radius:15px;padding:12px;margin-bottom:10px;max-height:250px;overflow:hidden}
        .picker.active{display:block}

        .emoji-cats{display:flex;gap:5px;margin-bottom:10px;overflow-x:auto;padding-bottom:5px}
        .cat-btn{padding:8px 10px;background:rgba(255,255,255,0.08);border:none;border-radius:8px;cursor:pointer;font-size:1.1rem}
        .cat-btn:hover,.cat-btn.active{background:rgba(0,245,255,0.2)}

        .emoji-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:4px;max-height:140px;overflow-y:auto}
        .emoji-btn{border:none;background:none;cursor:pointer;font-size:1.3rem;padding:5px;border-radius:8px}
        .emoji-btn:hover{background:rgba(255,255,255,0.15)}

        .gif-search{width:100%;padding:10px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);border-radius:10px;color:var(--text);font-family:inherit;margin-bottom:10px}
        .gif-search:focus{outline:none;border-color:var(--cyan)}
        .gif-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;max-height:150px;overflow-y:auto}
        .gif-item{cursor:pointer;border-radius:8px;overflow:hidden}
        .gif-item:hover{transform:scale(1.02)}
        .gif-item img{width:100%;height:60px;object-fit:cover}
        .gif-load{text-align:center;padding:20px;color:rgba(255,255,255,0.5);grid-column:1/-1}

        .quick{display:flex;gap:5px;margin-bottom:10px;flex-wrap:wrap}
        .qr{padding:6px 10px;background:rgba(255,255,255,0.08);border:none;border-radius:20px;cursor:pointer;font-size:1rem}
        .qr:hover{background:rgba(255,255,255,0.15)}

        .form{display:flex;gap:8px}
        .form input{flex:1;padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.15);border-radius:25px;color:var(--text);font-family:inherit;font-size:16px}
        .form input:focus{outline:none;border-color:var(--cyan)}
        .form button{padding:12px 18px;background:linear-gradient(135deg,var(--magenta),var(--cyan));border:none;border-radius:25px;color:#fff;font-size:1.1rem;cursor:pointer}
        .form button:disabled{opacity:0.5;cursor:not-allowed}

        footer{text-align:center;padding:15px;font-size:0.8rem;color:rgba(255,255,255,0.4)}
        footer a{color:var(--cyan);text-decoration:none}

        /* ===== RESPONSIVE MOBILE (Android / iOS) ===== */
        @media(max-width:768px){
            /* Utiliser la hauteur reelle du viewport (sans barre d'adresse) */
            body{height:100dvh;overflow:hidden}
            .container{padding:8px;height:100dvh;display:flex;flex-direction:column;overflow:hidden}

            .logo{padding:5px 0;flex-shrink:0}
            .logo img{max-width:60px}
            .back{font-size:0.75rem}
            header{padding:8px 0;flex-shrink:0}
            header h1{font-size:1.3rem}
            .badges{gap:5px;margin-top:6px}
            .badge{padding:3px 8px;font-size:0.65rem}

            /* CHAT - prend tout l'espace restant */
            .chat{flex:1;display:flex;flex-direction:column;max-height:none;border-radius:15px;margin:5px 0;min-height:0;overflow:hidden}
            .chat.active{display:flex}
            .chat-head{padding:8px 12px;flex-shrink:0}
            .chat-head span{font-size:0.85rem}

            /* Messages - scroll flexible */
            .messages{flex:1;min-height:0;max-height:none;padding:10px;gap:8px;-webkit-overflow-scrolling:touch;overflow-y:auto}
            .msg-text{font-size:0.92rem}
            .msg-text img{max-width:150px;max-height:100px}
            .avatar{width:32px;height:32px;font-size:0.8rem;border-radius:8px}
            .bubble{max-width:80%;padding:8px 12px;border-radius:14px 14px 14px 4px}
            .msg.own .bubble{border-radius:14px 14px 4px 14px}
            .msg-name{font-size:0.8rem}
            .msg-time{font-size:0.65rem}

            /* Zone de saisie - toujours visible en bas */
            .input-area{padding:8px 10px;padding-bottom:calc(8px + env(safe-area-inset-bottom, 0px));flex-shrink:0;position:relative;z-index:10}

            /* Toolbar - boutons tactiles min 44px */
            .toolbar{gap:6px;margin-bottom:6px}
            .tool-btn{width:44px;height:44px;font-size:1.2rem;border-radius:12px}

            /* Pickers optimises mobile */
            .picker{border-radius:12px;padding:10px;max-height:200px}
            .emoji-cats{gap:3px;margin-bottom:8px}
            .cat-btn{padding:8px;font-size:1rem;min-width:38px;min-height:38px}
            .emoji-grid{grid-template-columns:repeat(7,1fr);gap:2px;max-height:120px}
            .emoji-btn{font-size:1.4rem;padding:6px;min-width:40px;min-height:40px}

            .gif-search{padding:10px;font-size:16px;border-radius:10px}
            .gif-grid{grid-template-columns:repeat(2,1fr);gap:5px;max-height:120px}
            .gif-item img{height:70px}

            /* Quick reactions */
            .quick{gap:4px;margin-bottom:6px}
            .qr{padding:8px;font-size:1.1rem;min-width:40px;min-height:40px;display:flex;align-items:center;justify-content:center;border-radius:12px}

            /* Form - inputs 16px pour eviter le zoom auto */
            .form{gap:6px}
            .form input{padding:12px 14px;font-size:16px;border-radius:22px}
            .form button{padding:12px 16px;font-size:1.1rem;border-radius:22px;min-width:48px;min-height:48px}

            /* Login */
            .login{padding:20px 15px;border-radius:15px;margin:15px 0}
            .login h2{font-size:1.2rem;margin-bottom:15px}
            .login input{padding:14px 18px;font-size:16px;max-width:100%;border-radius:14px}
            .login button{padding:14px 30px;font-size:1rem;border-radius:14px;min-height:48px}

            footer{padding:10px;font-size:0.7rem;flex-shrink:0}
        }

        /* Petits ecrans (< 380px, ex: anciens Android) */
        @media(max-width:380px){
            header h1{font-size:1.1rem}
            .badges{display:none}
            .emoji-grid{grid-template-columns:repeat(6,1fr)}
            .emoji-btn{font-size:1.2rem;min-width:36px;min-height:36px}
            .bubble{max-width:85%}
            .avatar{width:28px;height:28px;font-size:0.7rem}
        }

        /* Paysage mobile */
        @media(max-height:500px) and (orientation:landscape){
            .logo,.badges{display:none}
            header{padding:4px 0}
            header h1{font-size:1rem}
            .messages{max-height:none}
            .picker{max-height:130px}
        }
    </style>
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Organization",
      "name": "TLD",
      "url": "https://tino-le-doc.com",
      "logo": "https://tino-le-doc.com/img/1000074494.png"
    }
    </script>
</head>
<body>
    <a href="appareils-connectes.html" class="tino-iot-banner" aria-label="Tino Assistant IoT">
        <span class="tino-iot-banner-icon">üì°</span>
        <span class="tino-iot-banner-text">
            <span class="tino-iot-banner-title" data-i18n="banner.iot.title">Tino Assistant IoT</span>
            <span class="tino-iot-banner-sub" data-i18n="banner.iot.sub">Appareils connectes &amp; IA</span>
        </span>
        <span class="tino-iot-banner-dot"></span>
    </a>
    <a href="#main-content" class="skip-link" data-i18n="skip.link">Aller au contenu</a>
    <nav class="nav-dropdown" aria-label="Navigation rapide" data-i18n-aria="nav.aria">
        <select onchange="if(this.value) window.location.href=this.value" aria-label="Naviguer vers une page" data-i18n-aria="nav.aria.select">
            <option value="" data-i18n="nav.menu">&#9776; Menu</option>
            <option value="index.html" data-i18n="nav.accueil">&#127968; Accueil</option>
            <option value="veille-techno.html" data-i18n="nav.veille">&#128225; Veille Techno</option>
            <option value="quiz.html" data-i18n="nav.quiz">&#129504; Quiz</option>
            <option value="sondages.html" data-i18n="nav.sondages">&#128202; Sondages</option>
            <option value="debat.html" data-i18n="nav.debat">&#9876;&#65039; D&eacute;bat</option>
            <option value="tchat.html" selected data-i18n="nav.tchat">&#128172; Tchat</option>
            <option value="messagerie.html" data-i18n="nav.messagerie">&#9993;&#65039; Messagerie</option>
            <option value="forum.html" data-i18n="nav.forum">&#127963;&#65039; Forum</option>
            <option value="avis.html" data-i18n="nav.avis">&#11088; Avis</option>
            <option value="compte.html" data-i18n="nav.compte">&#128100; Compte</option>
            <option value="premium.html" data-i18n="nav.premium">&#128081; Premium</option>
            <option value="boutique.html" data-i18n="nav.boutique">&#128722; Boutique</option>
            <option value="appareils-connectes.html" data-i18n="nav.appareils">&#128225; Appareils IA</option>
            <option value="contact.html" data-i18n="nav.contact">&#128231; Contact</option>
            <option value="confidentialite.html" data-i18n="nav.confidentialite">&#128274; Confidentialit&eacute;</option>
        </select>
    </nav>
<div class="container" id="main-content">
    <div class="logo"><img src="img/1000074494.png" alt="TLD"></div>
    <a href="index.html" class="back" data-i18n="btn.back.short">‚Üê Retour</a>

    <header>
        <h1 data-i18n="tchat.h1">üí¨ Tchat Live</h1>
        <div class="badges">
            <div class="badge live"><span class="live-dot"></span><span data-i18n="tchat.live">En direct</span></div>
            <div class="badge secure" data-i18n="tchat.secure">üîí S√©curis√©</div>
            <div class="badge" data-i18n="tchat.moderated">üõ°Ô∏è Mod√©r√©</div>
            <div class="badge users">üë• <span id="count">0</span></div>
        </div>
    </header>

    <section class="login" id="login">
            <h2 data-i18n="tchat.join.title">üëã Rejoindre le tchat</h2>
            <input type="text" id="pseudo" placeholder="Votre pseudo..." maxlength="20" autocomplete="off" data-i18n-placeholder="tchat.placeholder.pseudo">
            <br><button id="joinBtn" data-i18n="tchat.join.btn">üöÄ C'est parti !</button>
        </section>

        <div class="chat" id="chat">
            <div class="chat-head">
                <span><span class="live-dot"></span>Tchat</span>
                <span class="online">üë• <span id="count2">0</span></span>
            </div>

            <div class="messages" id="msgs">
                <div class="empty"><div class="icon">üí¨</div><p>Soyez le premier !</p></div>
            </div>

            <div class="typing" id="typing"></div>

            <div class="input-area">
                <div class="warn" id="warn">üõ°Ô∏è Message bloqu√© par la mod√©ration</div>
                <div class="rate-limit" id="rateLimit">‚è≥ Attendez avant d'envoyer un autre message</div>

                <div class="toolbar">
                    <button class="tool-btn" id="emojiBtnT" type="button">üòÄ</button>
                    <button class="tool-btn" id="gifBtnT" type="button">GIF</button>
                </div>

                <div class="picker" id="emojiPick">
                    <div class="emoji-cats">
                        <button class="cat-btn active" data-c="faces" type="button">üòÄ</button>
                        <button class="cat-btn" data-c="hands" type="button">üëç</button>
                        <button class="cat-btn" data-c="hearts" type="button">‚ù§Ô∏è</button>
                        <button class="cat-btn" data-c="animals" type="button">üê±</button>
                        <button class="cat-btn" data-c="food" type="button">üçï</button>
                        <button class="cat-btn" data-c="symbols" type="button">‚ú®</button>
                    </div>
                    <div class="emoji-grid" id="emojiG"></div>
                </div>

                <div class="picker" id="gifPick">
                    <input type="text" class="gif-search" id="gifQ" placeholder="üîç Rechercher un GIF..." maxlength="50">
                    <div class="gif-grid" id="gifG"><div class="gif-load">Chargement...</div></div>
                </div>

                <div class="quick">
                    <button class="qr" type="button">üëç</button>
                    <button class="qr" type="button">‚ù§Ô∏è</button>
                    <button class="qr" type="button">üòÇ</button>
                    <button class="qr" type="button">üî•</button>
                    <button class="qr" type="button">üëè</button>
                    <button class="qr" type="button">ü§ñ</button>
                    <button class="qr" type="button">üß†</button>
                    <button class="qr" type="button">üíØ</button>
                </div>

                <form class="form" id="form">
                    <input type="text" id="msg" placeholder="Message..." maxlength="500" autocomplete="off">
                    <button type="submit" id="sendBtn">üì§</button>
                </form>
            </div>
        </div>

    <footer role="contentinfo"><strong>TLD</strong> | <a href="avis.html">Avis</a> | <a href="index.html">D√©bat</a></footer>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="js/firebase-config.js"></script>
<script>
// ==================== S√âCURIT√â ====================

// Rate limiting c√¥t√© client
const RateLimiter = {
    lastMessage: 0,
    messageCount: 0,
    COOLDOWN: 2000,      // 2 secondes entre messages
    MAX_PER_MINUTE: 20,  // Max 20 messages/minute
    minuteStart: Date.now(),
    
    canSend() {
        const now = Date.now();
        
        // Reset compteur chaque minute
        if (now - this.minuteStart > 60000) {
            this.minuteStart = now;
            this.messageCount = 0;
        }
        
        // V√©rifier cooldown
        if (now - this.lastMessage < this.COOLDOWN) {
            return false;
        }
        
        // V√©rifier limite par minute
        if (this.messageCount >= this.MAX_PER_MINUTE) {
            return false;
        }
        
        return true;
    },
    
    recordMessage() {
        this.lastMessage = Date.now();
        this.messageCount++;
    }
};

// Validation des donn√©es
const Validator = {
    // Valider pseudo
    isValidPseudo(pseudo) {
        if (typeof pseudo !== 'string') return false;
        const trimmed = pseudo.trim();
        if (trimmed.length < 2 || trimmed.length > 20) return false;
        // Pas de caract√®res sp√©ciaux dangereux
        if (/[<>\"'`\\]/.test(trimmed)) return false;
        return true;
    },
    
    // Valider message texte
    isValidMessage(text) {
        if (typeof text !== 'string') return false;
        const trimmed = text.trim();
        if (trimmed.length < 1 || trimmed.length > 500) return false;
        return true;
    },
    
    // Valider URL GIF (uniquement Tenor)
    isValidGifUrl(url) {
        if (typeof url !== 'string') return false;
        // Accepter uniquement les URLs Tenor
        const tenorPattern = /^https:\/\/media\.tenor\.com\/.+$/;
        return tenorPattern.test(url);
    },
    
    // Sanitize pour affichage
    sanitize(text) {
        if (typeof text !== 'string') return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
};

// ==================== D√âTECTION MOBILE ====================
const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

// ==================== FIREBASE ====================
let user = null, oderId = null, msgsRef, usersRef, typeRef;

// Config Firebase chargee depuis js/firebase-config.js
const auth = firebaseAuth;
const db = firebaseDb;
try {
    msgsRef = db.ref('chatMessages');
    usersRef = db.ref('chatUsers');
    typeRef = db.ref('chatTyping');
} catch(e) { console.error('Firebase:', e); }

// ==================== MOD√âRATION ====================
const badWords = [
    /\b(connard?|conna?(rd|sse)|put(e|ain)|merde|encul[e√©]|batar+d|salop(e|ard)?|pd|fdp|ntm|nique|d[e√©]bile|cr[e√©]tin|abrutis?|idiot|imbecile|stupide)\b/gi,
    /\b(n[e√®]gr[eo]?|bougnou?le?|bamboula|macaque|sale\s*(arabe|noir|blanc|juif|musulman|gay)|youpin|feuj|chintok|brid√©)\b/gi,
    /\b(tapette|tafiole|tarlouze|p[e√©]d[e√©]|p√©dale|gouine)\b/gi,
    /\b(hitler|nazi|kkk)\b/gi
];

function isClean(text) {
    if (typeof text !== 'string') return false;
    const normalized = text.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    return !badWords.some(p => p.test(normalized));
}

function formatTime(ts) {
    return new Date(ts).toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
}

// ==================== EMOJIS ====================
const emo = {
    faces: ['üòÄ','üòÉ','üòÑ','üòÅ','üòÖ','üòÇ','ü§£','üòä','üòá','üôÇ','üòâ','üòç','ü•∞','üòò','üòã','üòõ','üòú','ü§™','ü§ó','ü§î','üòè','üôÑ','üò¨','üòÆ','üò≤','üò≥','ü•∫','üò¢','üò≠','üò±','üò§','üò°','üòà','üíÄ','ü§°','üëª','üëΩ','ü§ñ'],
    hands: ['üëç','üëé','üëä','‚úä','ü§õ','ü§ú','ü§û','‚úåÔ∏è','ü§ü','ü§ò','üëå','üëà','üëâ','üëÜ','üëá','‚úã','üëã','ü§ô','üí™','üôè','üëè','ü§ù'],
    hearts: ['‚ù§Ô∏è','üß°','üíõ','üíö','üíô','üíú','üñ§','ü§ç','üíî','üíï','üíñ','üíò','üíù'],
    animals: ['üê∂','üê±','üê≠','üêπ','üê∞','ü¶ä','üêª','üêº','üê®','üêØ','ü¶Å','üêÆ','üê∑','üê∏','üêµ','üêî','üêß','ü¶Ñ','üêù','ü¶ã'],
    food: ['üçï','üçî','üçü','üå≠','üçø','üç≥','üßÄ','üåÆ','üçú','üç£','üç¶','üç©','üéÇ','üç´','‚òï','üç∫','ü•Ç'],
    symbols: ['‚ú®','‚≠ê','üåü','üí´','‚ö°','üî•','üí•','üåà','‚òÄÔ∏è','üåô','üíØ','‚úÖ','‚ùå','‚ùì','‚ùó','üî¥','üü¢','üîµ','üèÜ','üéØ','üéâ','üéä']
};

function renderEmojis(cat) {
    const g = document.getElementById('emojiG');
    if (g && emo[cat]) g.innerHTML = emo[cat].map(e => `<button class="emoji-btn" type="button">${e}</button>`).join('');
}

document.querySelectorAll('.cat-btn').forEach(b => {
    b.addEventListener('click', function() {
        document.querySelectorAll('.cat-btn').forEach(x => x.classList.remove('active'));
        this.classList.add('active');
        renderEmojis(this.dataset.c);
    });
});

document.getElementById('emojiG').addEventListener('click', e => {
    if (e.target.classList.contains('emoji-btn')) {
        const input = document.getElementById('msg');
        if (input.value.length < 500) {
            input.value += e.target.textContent;
            input.focus();
        }
    }
});

document.getElementById('emojiBtnT').addEventListener('click', () => {
    document.getElementById('gifPick').classList.remove('active');
    const p = document.getElementById('emojiPick');
    p.classList.toggle('active');
    if (p.classList.contains('active')) renderEmojis('faces');
});

// ==================== GIFs ====================
async function loadGifs(query = '') {
    const g = document.getElementById('gifG');
    g.innerHTML = '<div class="gif-load">‚è≥</div>';
    
    // Sanitize query
    const safeQuery = query.replace(/[<>\"'`\\]/g, '').substring(0, 50);
    
    try {
        const url = safeQuery 
            ? `https://tenor.googleapis.com/v2/search?q=${encodeURIComponent(safeQuery)}&key=AIzaSyAyimkuYQYF_FXVALexPuGQctUWRURdCYQ&limit=9&media_filter=gif,tinygif&contentfilter=medium`
            : `https://tenor.googleapis.com/v2/featured?key=AIzaSyAyimkuYQYF_FXVALexPuGQctUWRURdCYQ&limit=9&media_filter=gif,tinygif&contentfilter=medium`;
        
        const r = await fetch(url);
        const d = await r.json();
        
        if (d.results?.length) {
            g.innerHTML = d.results.map(x => {
                const gifUrl = x.media_formats.gif?.url || x.media_formats.tinygif?.url;
                const thumbUrl = x.media_formats.tinygif?.url || gifUrl;
                // V√©rifier que c'est bien une URL Tenor
                if (!Validator.isValidGifUrl(gifUrl)) return '';
                return `<div class="gif-item" data-url="${Validator.sanitize(gifUrl)}"><img src="${Validator.sanitize(thumbUrl)}" loading="lazy" alt="GIF"></div>`;
            }).join('');
        } else {
            g.innerHTML = '<div class="gif-load">Aucun GIF üò¢</div>';
        }
    } catch(e) { 
        g.innerHTML = '<div class="gif-load">Erreur üò¢</div>'; 
    }
}

document.getElementById('gifBtnT').addEventListener('click', () => {
    document.getElementById('emojiPick').classList.remove('active');
    const p = document.getElementById('gifPick');
    p.classList.toggle('active');
    if (p.classList.contains('active')) loadGifs();
});

let gifTO;
document.getElementById('gifQ').addEventListener('input', e => {
    clearTimeout(gifTO);
    gifTO = setTimeout(() => loadGifs(e.target.value), 500);
});

document.getElementById('gifG').addEventListener('click', e => {
    const it = e.target.closest('.gif-item');
    if (it && user && msgsRef) {
        const gifUrl = it.dataset.url;
        
        // Valider URL
        if (!Validator.isValidGifUrl(gifUrl)) {
            console.warn('URL GIF invalide');
            return;
        }
        
        // Rate limiting
        if (!RateLimiter.canSend()) {
            document.getElementById('rateLimit').style.display = 'block';
            setTimeout(() => document.getElementById('rateLimit').style.display = 'none', 2000);
            return;
        }
        
        msgsRef.push({
            type: 'gif',
            pseudo: user,
            user: user,
            oderId: oderId,
            text: '[GIF]',
            url: gifUrl,
            timestamp: Date.now()
        });
        
        RateLimiter.recordMessage();
        document.getElementById('gifPick').classList.remove('active');
    }
});

document.querySelectorAll('.qr').forEach(b => {
    b.addEventListener('click', function() {
        const input = document.getElementById('msg');
        if (input.value.length < 500) {
            input.value += this.textContent;
            input.focus();
        }
    });
});

// ==================== JOIN ====================
document.getElementById('joinBtn').addEventListener('click', joinChat);
document.getElementById('pseudo').addEventListener('keypress', e => { if (e.key === 'Enter') joinChat(); });

async function joinChat() {
    const pseudoInput = document.getElementById('pseudo');
    const joinBtn = document.getElementById('joinBtn');
    const p = pseudoInput.value.trim();

    // Validation
    if (!Validator.isValidPseudo(p)) {
        alert('Pseudo invalide (2-20 caract√®res, sans caract√®res sp√©ciaux)');
        return;
    }

    if (!isClean(p)) {
        alert('üõ°Ô∏è Pseudo non autoris√©');
        return;
    }

    // Authentification requise pour √©crire dans Firebase
    joinBtn.disabled = true;
    try {
        if (!auth || !auth.currentUser) {
            await auth.signInAnonymously();
        }
    } catch (e) {
        console.error('Erreur auth:', e);
        joinBtn.disabled = false;
        alert('Connexion impossible. Veuillez r√©essayer ou vous connecter via la page Compte.');
        return;
    }

    user = p;
    oderId = auth.currentUser.uid;

    if (usersRef) {
        const uref = usersRef.child(oderId);
        uref.set({name: user, joinedAt: Date.now()});
        uref.onDisconnect().remove();
    }

    document.getElementById('login').style.display = 'none';
    document.getElementById('chat').classList.add('active');

    if (msgsRef) {
        msgsRef.push({type: 'system', action: 'join', user, pseudo: user, text: user + ' a rejoint le tchat', timestamp: Date.now()});
    }

    loadMessages();
    document.getElementById('msg').focus();
}

// ==================== MESSAGES ====================
function loadMessages() {
    if (!msgsRef) return;
    
    msgsRef.limitToLast(50).on('child_added', s => {
        const d = s.val();
        if (d) displayMessage(d);
    }, err => console.error('Erreur msgs:', err));
}

function displayMessage(d) {
    const c = document.getElementById('msgs');
    const emp = c.querySelector('.empty');
    if (emp) emp.remove();
    
    const div = document.createElement('div');
    
    if (d.type === 'system') {
        div.className = 'sys ' + (d.action || '');
        div.textContent = `üëã ${Validator.sanitize(d.user)} ${d.action === 'join' ? 'a rejoint' : 'a quitt√©'}`;
    } else {
        div.className = 'msg' + (d.oderId === oderId ? ' own' : '');
        
        let content;
        if (d.type === 'gif' && Validator.isValidGifUrl(d.url)) {
            content = `<img src="${Validator.sanitize(d.url)}" alt="GIF" loading="lazy" onerror="this.style.display='none'">`;
        } else {
            content = Validator.sanitize(d.text || '');
        }
        
        const userName = Validator.sanitize(d.user || '?');
        const initial = userName.charAt(0).toUpperCase();
        
        div.innerHTML = `
            <div class="avatar">${initial}</div>
            <div class="bubble">
                <div class="msg-head">
                    <span class="msg-name">${userName}</span>
                    <span class="msg-time">${d.timestamp ? formatTime(d.timestamp) : ''}</span>
                </div>
                <div class="msg-text">${content}</div>
            </div>
        `;
    }
    
    c.appendChild(div);
    c.scrollTop = c.scrollHeight;
}

// ==================== SEND ====================
document.getElementById('form').addEventListener('submit', e => {
    e.preventDefault();
    sendMsg();
});

// Fix clavier Android : garder l'input visible
const msgEl = document.getElementById('msg');
if (msgEl) {
    msgEl.addEventListener('focus', () => {
        setTimeout(() => {
            msgEl.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
        }, 300);
    });
}

// Gestion du resize par le clavier virtuel
if (window.visualViewport) {
    window.visualViewport.addEventListener('resize', () => {
        document.documentElement.style.height = window.visualViewport.height + 'px';
    });
    window.visualViewport.addEventListener('scroll', () => {
        document.documentElement.style.height = window.visualViewport.height + 'px';
    });
}

function sendMsg() {
    const inp = document.getElementById('msg');
    const t = inp.value.trim();
    const warn = document.getElementById('warn');
    const rateLimit = document.getElementById('rateLimit');
    
    // Validations
    if (!t || !user || !msgsRef) return;
    
    if (!Validator.isValidMessage(t)) {
        warn.textContent = 'üõ°Ô∏è Message invalide (1-500 caract√®res)';
        warn.style.display = 'block';
        setTimeout(() => warn.style.display = 'none', 3000);
        return;
    }
    
    if (!isClean(t)) {
        warn.textContent = 'üõ°Ô∏è Message bloqu√© par la mod√©ration';
        warn.style.display = 'block';
        setTimeout(() => warn.style.display = 'none', 3000);
        return;
    }
    
    // Rate limiting
    if (!RateLimiter.canSend()) {
        rateLimit.style.display = 'block';
        setTimeout(() => rateLimit.style.display = 'none', 2000);
        return;
    }
    
    msgsRef.push({
        type: 'message',
        pseudo: user,
        user: user,
        oderId: oderId,
        text: t,
        timestamp: Date.now()
    });
    
    RateLimiter.recordMessage();
    inp.value = '';
    
    document.getElementById('emojiPick').classList.remove('active');
    document.getElementById('gifPick').classList.remove('active');
    
    if (typeRef && oderId) typeRef.child(oderId).remove();
}

// Mod√©ration en temps r√©el
document.getElementById('msg').addEventListener('input', function() {
    const warn = document.getElementById('warn');
    if (!isClean(this.value) && this.value.length > 2) {
        warn.textContent = 'üõ°Ô∏è Contenu non autoris√© d√©tect√©';
        warn.style.display = 'block';
    } else {
        warn.style.display = 'none';
    }
    
    // Typing indicator
    if (user && oderId && typeRef) {
        if (this.value.length > 0) {
            typeRef.child(oderId).set({name: user, at: Date.now()});
        } else {
            typeRef.child(oderId).remove();
        }
    }
});

// ==================== ONLINE & TYPING ====================
if (usersRef) {
    usersRef.on('value', s => {
        const n = s.numChildren();
        document.getElementById('count').textContent = n;
        document.getElementById('count2').textContent = n;
    });
}

if (typeRef) {
    typeRef.on('value', s => {
        const ti = document.getElementById('typing');
        const arr = [];
        
        s.forEach(c => {
            if (c.key !== oderId && c.val().at && Date.now() - c.val().at < 5000) {
                arr.push(Validator.sanitize(c.val().name));
            }
        });
        
        if (arr.length) {
            ti.textContent = arr.length === 1 ? `${arr[0]} √©crit...` : `${arr.join(', ')} √©crivent...`;
            ti.classList.add('active');
        } else {
            ti.classList.remove('active');
        }
    });
}

// Cleanup typing indicators
setInterval(() => {
    if (typeRef) {
        typeRef.once('value', s => {
            s.forEach(c => {
                if (c.val().at && Date.now() - c.val().at > 5000) {
                    c.ref.remove();
                }
            });
        });
    }
}, 5000);

// ==================== CLEANUP ====================
window.addEventListener('beforeunload', () => {
    if (oderId && usersRef) usersRef.child(oderId).remove();
    if (user && msgsRef) msgsRef.push({type: 'system', action: 'leave', user, pseudo: user, text: user + ' a quitt√© le tchat', timestamp: Date.now()});
});

// ==================== MOBILE KEYBOARD ====================
if (isMobile) {
    const msgInput = document.getElementById('msg');
    const pseudoInput = document.getElementById('pseudo');
    const chatEl = document.getElementById('chat');
    const msgsEl = document.getElementById('msgs');

    // Gestion du clavier virtuel Android via visualViewport
    if (window.visualViewport) {
        window.visualViewport.addEventListener('resize', () => {
            // Scroll vers le bas quand le clavier s'ouvre
            if (chatEl.classList.contains('active')) {
                setTimeout(() => msgsEl.scrollTop = msgsEl.scrollHeight, 100);
            }
        });
    }

    // Scroll au focus sur l'input message
    msgInput.addEventListener('focus', () => {
        setTimeout(() => {
            msgInput.scrollIntoView({block: 'nearest', behavior: 'smooth'});
            msgsEl.scrollTop = msgsEl.scrollHeight;
        }, 300);
    });

    // Fermer les pickers quand on tape
    msgInput.addEventListener('focus', () => {
        document.getElementById('emojiPick').classList.remove('active');
        document.getElementById('gifPick').classList.remove('active');
    });
}

// Init
renderEmojis('faces');
console.log('‚úÖ Tchat s√©curis√© pr√™t');
</script>

    <!-- Bouton Partager Flottant -->
    <div class="share-fab" id="shareFab">
        <button class="share-fab-btn" id="shareFabBtn" aria-label="Partager cette page" data-i18n-aria="share.fab.aria">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/></svg>
        </button>
        <div class="share-fab-menu" id="shareFabMenu">
            <button class="share-fab-menu-item" onclick="shareFabWhatsApp()">
                <svg viewBox="0 0 24 24" fill="#25D366"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                <span data-i18n="share.fab.whatsapp">WhatsApp</span>
            </button>
            <button class="share-fab-menu-item" onclick="shareFabX()">
                <svg viewBox="0 0 24 24" fill="#e8e8e8"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                <span data-i18n="share.fab.x">X (Twitter)</span>
            </button>
            <button class="share-fab-menu-item" onclick="shareFabCopy()">
                <span class="sfm-icon">üîó</span>
                <span data-i18n="share.fab.copy" id="shareFabCopyText">Copier le lien</span>
            </button>
        </div>
    </div>
    <script>
    (function() {
        var fabBtn = document.getElementById('shareFabBtn');
        var fabMenu = document.getElementById('shareFabMenu');
        fabBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            if (navigator.share) {
                navigator.share({ title: document.title, url: window.location.href }).catch(function(){});
            } else {
                fabMenu.classList.toggle('open');
            }
        });
        document.addEventListener('click', function(e) {
            if (!document.getElementById('shareFab').contains(e.target)) {
                fabMenu.classList.remove('open');
            }
        });
    })();
    function shareFabWhatsApp() {
        window.open('https://wa.me/?text=' + encodeURIComponent(document.title + ' ' + window.location.href), '_blank');
    }
    function shareFabX() {
        window.open('https://x.com/intent/post?text=' + encodeURIComponent(document.title) + '&url=' + encodeURIComponent(window.location.href), '_blank');
    }
    function shareFabCopy() {
        navigator.clipboard.writeText(window.location.href).then(function() {
            var el = document.getElementById('shareFabCopyText');
            var orig = el.textContent;
            el.textContent = '‚úÖ Copi√© !';
            setTimeout(function() { el.textContent = orig; }, 2000);
        });
    }
    </script>

</body>
</html>
