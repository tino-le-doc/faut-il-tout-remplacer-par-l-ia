<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tchat Live üí¨ Tino Le Doc</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;700&family=Syne:wght@700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/common.css">
    <style>
        :root{--bg:#0a0a0f;--cyan:#00f5ff;--magenta:#ff00aa;--yellow:#f5ff00;--orange:#ff9500;--green:#00ff88;--red:#ff4444;--text:#e8e8e8;--glass:rgba(255,255,255,0.05)}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Space Grotesk',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
        .container{max-width:1200px;margin:0 auto;padding:15px;min-height:100vh}
        .logo{text-align:center;padding:10px 0}
        .logo img{max-width:100px;filter:drop-shadow(0 5px 20px rgba(255,165,0,0.4))}
        .back{color:var(--cyan);text-decoration:none;font-size:0.85rem}
        header{text-align:center;padding:15px 0}
        header h1{font-family:'Syne',sans-serif;font-size:1.8rem;background:linear-gradient(135deg,var(--magenta),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .badges{display:flex;gap:8px;justify-content:center;margin-top:10px;flex-wrap:wrap}
        .badge{padding:5px 12px;background:var(--glass);border:1px solid var(--green);border-radius:20px;font-size:0.75rem;color:var(--green);display:flex;align-items:center;gap:5px}
        .badge.live{border-color:var(--magenta);color:var(--magenta);animation:pulse 2s infinite}
        .badge.video{border-color:var(--red);color:var(--red)}
        .badge.secure{border-color:var(--green);color:var(--green)}
        @keyframes pulse{0%,100%{box-shadow:0 0 10px rgba(255,0,170,0.3)}50%{box-shadow:0 0 25px rgba(255,0,170,0.6)}}
        .live-dot{width:8px;height:8px;background:var(--green);border-radius:50%;animation:blink 1.5s infinite}
        @keyframes blink{0%,100%{opacity:1}50%{opacity:0.4}}

        .tabs{display:flex;gap:10px;justify-content:center;margin:20px 0;flex-wrap:wrap}
        .tab-btn{padding:12px 20px;background:var(--glass);border:2px solid rgba(255,255,255,0.1);border-radius:15px;color:var(--text);font-family:'Syne',sans-serif;font-size:0.95rem;font-weight:700;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;gap:8px}
        .tab-btn:hover{border-color:var(--cyan);transform:translateY(-2px)}
        .tab-btn.active{background:linear-gradient(135deg,var(--magenta),var(--cyan));border-color:transparent}
        .tab-btn.video-tab{border-color:var(--red)}
        .tab-btn.video-tab.active{background:linear-gradient(135deg,var(--red),var(--orange))}
        
        .tab-content{display:none}
        .tab-content.active{display:block}

        .video-section{background:var(--glass);border:1px solid rgba(255,255,255,0.1);border-radius:20px;overflow:hidden;margin:10px 0}
        .video-header{padding:15px 20px;background:linear-gradient(135deg,rgba(255,68,68,0.2),rgba(255,149,0,0.2));border-bottom:1px solid rgba(255,255,255,0.1)}
        .video-header h2{font-family:'Syne',sans-serif;font-size:1.1rem;display:flex;align-items:center;gap:10px;margin-bottom:10px}
        .video-header h2 .rec{width:12px;height:12px;background:var(--red);border-radius:50%;animation:recPulse 1s infinite}
        @keyframes recPulse{0%,100%{opacity:1;box-shadow:0 0 10px var(--red)}50%{opacity:0.5;box-shadow:0 0 20px var(--red)}}

        .video-join{padding:40px 20px;text-align:center;background:linear-gradient(135deg,#1a1a2e,#0a0a0f)}
        .video-join .icon{font-size:4rem;margin-bottom:20px}
        .video-join h3{font-family:'Syne',sans-serif;font-size:1.3rem;margin-bottom:10px;color:var(--text)}
        .video-join p{color:rgba(255,255,255,0.6);margin-bottom:20px;line-height:1.6}
        .video-join-btn{padding:15px 35px;border:none;border-radius:15px;font-family:'Syne',sans-serif;font-size:1.1rem;font-weight:700;cursor:pointer;background:linear-gradient(135deg,var(--green),#00cc6a);color:var(--bg);transition:all 0.3s;display:inline-flex;align-items:center;gap:10px}
        .video-join-btn:hover{transform:scale(1.05);box-shadow:0 10px 30px rgba(0,255,136,0.3)}
        .video-join-btn:disabled{opacity:0.5;cursor:not-allowed;transform:none}

        .video-grid{padding:10px;gap:10px;background:#000}
        .video-grid.active{display:flex;flex-wrap:wrap}

        .video-cell{position:relative;background:#222;border-radius:12px;overflow:hidden;width:100%;height:350px}
        .video-cell video{width:100%;height:100%;object-fit:cover}
        .video-cell.local{border:2px solid var(--cyan)}
        .video-cell .name-tag{position:absolute;bottom:8px;left:8px;padding:4px 10px;background:rgba(0,0,0,0.7);border-radius:8px;font-size:0.75rem;color:#fff;display:flex;align-items:center;gap:6px;z-index:2}
        .video-cell .name-tag .mic-off{color:var(--red)}
        .video-cell .no-video{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#1a1a2e,#0a0a0f);z-index:1}
        .video-cell .no-video .av-initial{width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,var(--orange),var(--yellow));display:flex;align-items:center;justify-content:center;font-size:1.5rem;font-weight:700;color:var(--bg)}

        .video-controls{display:none;padding:15px;background:rgba(0,0,0,0.8);justify-content:center;gap:12px;align-items:center}
        .video-controls.active{display:flex}
        .vc-btn{width:50px;height:50px;border:none;border-radius:50%;font-size:1.3rem;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.15);color:#fff}
        .vc-btn:hover{transform:scale(1.1)}
        .vc-btn.off{background:rgba(255,68,68,0.3);color:var(--red)}
        .vc-btn.leave{background:var(--red);color:#fff}
        .vc-btn.leave:hover{background:#ff2222}
        .video-count{font-size:0.8rem;color:rgba(255,255,255,0.6);display:flex;align-items:center;gap:5px}

        .video-info{padding:20px;background:rgba(255,255,255,0.02)}
        .video-info h4{color:var(--cyan);margin-bottom:10px;font-size:0.95rem}
        .video-info ul{font-size:0.85rem;color:rgba(255,255,255,0.6);padding-left:20px;line-height:1.8}
        .video-info li{margin-bottom:5px}

        .login{background:var(--glass);border:1px solid rgba(255,255,255,0.1);border-radius:20px;padding:30px;text-align:center;margin:20px 0}
        .login h2{font-family:'Syne',sans-serif;color:var(--cyan);margin-bottom:20px}
        .login input{width:100%;max-width:280px;padding:12px 18px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.15);border-radius:12px;color:var(--text);font-family:inherit;font-size:1rem;text-align:center;margin-bottom:15px}
        .login input:focus{outline:none;border-color:var(--cyan)}
        .login button{padding:12px 35px;background:linear-gradient(135deg,var(--magenta),var(--cyan));border:none;border-radius:12px;color:#fff;font-family:'Syne',sans-serif;font-size:1rem;font-weight:700;cursor:pointer}
        .login button:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(255,0,170,0.4)}
        .login button:disabled{opacity:0.5;cursor:not-allowed;transform:none}

        .chat{display:none;flex-direction:column;background:var(--glass);border:1px solid rgba(255,255,255,0.1);border-radius:20px;overflow:hidden;margin:10px 0}
        .chat.active{display:flex}
        .chat-head{padding:12px 15px;background:rgba(255,255,255,0.03);border-bottom:1px solid rgba(255,255,255,0.08);display:flex;justify-content:space-between;align-items:center}
        .chat-head span{font-family:'Syne',sans-serif;display:flex;align-items:center;gap:8px}
        .online{font-size:0.8rem;color:var(--cyan)}

        .messages{flex:1;overflow-y:auto;padding:15px;display:flex;flex-direction:column;gap:12px;min-height:250px;max-height:400px}
        .messages::-webkit-scrollbar{width:5px}
        .messages::-webkit-scrollbar-thumb{background:var(--cyan);border-radius:5px}

        .msg{display:flex;gap:10px;animation:slideIn 0.3s}
        @keyframes slideIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        .msg.own{flex-direction:row-reverse}
        .avatar{width:36px;height:36px;background:linear-gradient(135deg,var(--orange),var(--yellow));border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--bg);font-size:0.9rem;flex-shrink:0}
        .msg.own .avatar{background:linear-gradient(135deg,var(--magenta),var(--cyan))}
        .bubble{max-width:75%;background:rgba(255,255,255,0.08);border-radius:16px 16px 16px 4px;padding:10px 14px}
        .msg.own .bubble{background:linear-gradient(135deg,rgba(255,0,170,0.2),rgba(0,245,255,0.2));border-radius:16px 16px 4px 16px}
        .msg-head{display:flex;gap:8px;align-items:center;margin-bottom:4px}
        .msg-name{font-weight:700;font-size:0.85rem;color:var(--orange)}
        .msg.own .msg-name{color:var(--cyan)}
        .msg-time{font-size:0.7rem;color:rgba(255,255,255,0.4)}
        .msg-text{line-height:1.4;word-wrap:break-word}
        .msg-text img{max-width:180px;max-height:130px;border-radius:10px;margin-top:5px;display:block}

        .sys{text-align:center;padding:8px;font-size:0.8rem;color:rgba(255,255,255,0.5);font-style:italic}
        .sys.join{color:var(--green)}
        .sys.leave{color:var(--red)}

        .empty{text-align:center;padding:40px;color:rgba(255,255,255,0.4)}
        .empty .icon{font-size:2.5rem;margin-bottom:10px}

        .typing{display:none;padding:8px 15px;font-size:0.8rem;color:rgba(255,255,255,0.5);font-style:italic}
        .typing.active{display:block}

        .input-area{padding:12px 15px;background:rgba(255,255,255,0.03);border-top:1px solid rgba(255,255,255,0.08)}
        .warn{display:none;padding:8px 12px;background:rgba(255,68,68,0.15);border:1px solid var(--red);border-radius:10px;margin-bottom:10px;color:var(--red);font-size:0.8rem}
        .rate-limit{display:none;padding:8px 12px;background:rgba(255,149,0,0.15);border:1px solid var(--orange);border-radius:10px;margin-bottom:10px;color:var(--orange);font-size:0.8rem}

        .toolbar{display:flex;gap:5px;margin-bottom:10px}
        .tool-btn{width:42px;height:42px;border:none;background:rgba(255,255,255,0.08);border-radius:10px;cursor:pointer;font-size:1.2rem;transition:all 0.2s}
        .tool-btn:hover{background:rgba(255,255,255,0.15);transform:scale(1.1)}

        .picker{display:none;background:rgba(15,15,25,0.98);border:1px solid rgba(255,255,255,0.1);border-radius:15px;padding:12px;margin-bottom:10px;max-height:250px;overflow:hidden}
        .picker.active{display:block}

        .emoji-cats{display:flex;gap:5px;margin-bottom:10px;overflow-x:auto;padding-bottom:5px}
        .cat-btn{padding:8px 10px;background:rgba(255,255,255,0.08);border:none;border-radius:8px;cursor:pointer;font-size:1.1rem}
        .cat-btn:hover,.cat-btn.active{background:rgba(0,245,255,0.2)}

        .emoji-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:4px;max-height:140px;overflow-y:auto}
        .emoji-btn{border:none;background:none;cursor:pointer;font-size:1.3rem;padding:5px;border-radius:8px}
        .emoji-btn:hover{background:rgba(255,255,255,0.15)}

        .gif-search{width:100%;padding:10px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);border-radius:10px;color:var(--text);font-family:inherit;margin-bottom:10px}
        .gif-search:focus{outline:none;border-color:var(--cyan)}
        .gif-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;max-height:150px;overflow-y:auto}
        .gif-item{cursor:pointer;border-radius:8px;overflow:hidden}
        .gif-item:hover{transform:scale(1.02)}
        .gif-item img{width:100%;height:60px;object-fit:cover}
        .gif-load{text-align:center;padding:20px;color:rgba(255,255,255,0.5);grid-column:1/-1}

        .quick{display:flex;gap:5px;margin-bottom:10px;flex-wrap:wrap}
        .qr{padding:6px 10px;background:rgba(255,255,255,0.08);border:none;border-radius:20px;cursor:pointer;font-size:1rem}
        .qr:hover{background:rgba(255,255,255,0.15)}

        .form{display:flex;gap:8px}
        .form input{flex:1;padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.15);border-radius:25px;color:var(--text);font-family:inherit;font-size:16px}
        .form input:focus{outline:none;border-color:var(--cyan)}
        .form button{padding:12px 18px;background:linear-gradient(135deg,var(--magenta),var(--cyan));border:none;border-radius:25px;color:#fff;font-size:1.1rem;cursor:pointer}
        .form button:disabled{opacity:0.5;cursor:not-allowed}

        footer{text-align:center;padding:15px;font-size:0.8rem;color:rgba(255,255,255,0.4)}
        footer a{color:var(--cyan);text-decoration:none}

        /* ===== RESPONSIVE MOBILE (Android / iOS) ===== */
        @media(max-width:768px){
            /* Utiliser la hauteur reelle du viewport (sans barre d'adresse) */
            body{height:100dvh;overflow:hidden}
            .container{padding:8px;min-height:100dvh;display:flex;flex-direction:column}

            .logo{padding:5px 0}
            .logo img{max-width:60px}
            .back{font-size:0.75rem}
            header{padding:8px 0}
            header h1{font-size:1.3rem}
            .badges{gap:5px;margin-top:6px}
            .badge{padding:3px 8px;font-size:0.65rem}

            .tabs{gap:6px;margin:10px 0}
            .tab-btn{padding:10px 15px;font-size:0.85rem;flex:1;justify-content:center}

            /* VIDEO */
            .video-grid{gap:6px;padding:6px}
            .video-cell{height:250px}
            .video-cell .no-video .av-initial{width:45px;height:45px;font-size:1.1rem}
            .video-join{padding:25px 15px}
            .video-join .icon{font-size:2.5rem}
            .video-join h3{font-size:1.1rem}
            .video-join-btn{padding:14px 28px;font-size:1rem;min-height:48px}
            .vc-btn{width:50px;height:50px;min-width:50px;min-height:50px}
            .video-controls{gap:15px;padding:12px}

            /* CHAT - prend tout l'espace restant */
            .chat{flex:1;display:flex;flex-direction:column;max-height:none;border-radius:15px;margin:5px 0}
            .chat.active{display:flex}
            .chat-head{padding:8px 12px}
            .chat-head span{font-size:0.85rem}

            /* Messages - scroll flexible */
            .messages{flex:1;min-height:0;max-height:none;padding:10px;gap:8px;-webkit-overflow-scrolling:touch}
            .msg-text{font-size:0.92rem}
            .msg-text img{max-width:150px;max-height:100px}
            .avatar{width:32px;height:32px;font-size:0.8rem;border-radius:8px}
            .bubble{max-width:80%;padding:8px 12px;border-radius:14px 14px 14px 4px}
            .msg.own .bubble{border-radius:14px 14px 4px 14px}
            .msg-name{font-size:0.8rem}
            .msg-time{font-size:0.65rem}

            /* Zone de saisie */
            .input-area{padding:8px 10px}

            /* Toolbar - boutons tactiles min 44px */
            .toolbar{gap:6px;margin-bottom:6px}
            .tool-btn{width:44px;height:44px;font-size:1.2rem;border-radius:12px}

            /* Pickers optimises mobile */
            .picker{border-radius:12px;padding:10px;max-height:200px}
            .emoji-cats{gap:3px;margin-bottom:8px}
            .cat-btn{padding:8px;font-size:1rem;min-width:38px;min-height:38px}
            .emoji-grid{grid-template-columns:repeat(7,1fr);gap:2px;max-height:120px}
            .emoji-btn{font-size:1.4rem;padding:6px;min-width:40px;min-height:40px}

            .gif-search{padding:10px;font-size:16px;border-radius:10px}
            .gif-grid{grid-template-columns:repeat(2,1fr);gap:5px;max-height:120px}
            .gif-item img{height:70px}

            /* Quick reactions */
            .quick{gap:4px;margin-bottom:6px}
            .qr{padding:8px;font-size:1.1rem;min-width:40px;min-height:40px;display:flex;align-items:center;justify-content:center;border-radius:12px}

            /* Form - inputs 16px pour eviter le zoom auto */
            .form{gap:6px}
            .form input{padding:12px 14px;font-size:16px;border-radius:22px}
            .form button{padding:12px 16px;font-size:1.1rem;border-radius:22px;min-width:48px;min-height:48px}

            /* Login */
            .login{padding:20px 15px;border-radius:15px;margin:15px 0}
            .login h2{font-size:1.2rem;margin-bottom:15px}
            .login input{padding:14px 18px;font-size:16px;max-width:100%;border-radius:14px}
            .login button{padding:14px 30px;font-size:1rem;border-radius:14px;min-height:48px}

            footer{padding:10px;font-size:0.7rem}
        }

        /* Petits ecrans (< 380px, ex: anciens Android) */
        @media(max-width:380px){
            header h1{font-size:1.1rem}
            .badges{display:none}
            .tab-btn{padding:8px 10px;font-size:0.8rem}
            .emoji-grid{grid-template-columns:repeat(6,1fr)}
            .emoji-btn{font-size:1.2rem;min-width:36px;min-height:36px}
            .bubble{max-width:85%}
            .avatar{width:28px;height:28px;font-size:0.7rem}
        }

        /* Paysage mobile */
        @media(max-height:500px) and (orientation:landscape){
            .logo,.badges{display:none}
            header{padding:4px 0}
            header h1{font-size:1rem}
            .tabs{margin:5px 0}
            .messages{max-height:none}
            .picker{max-height:130px}
        }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-link">Aller au contenu</a>
<div class="container" id="main-content">
    <div class="logo"><img src="1000074492.png" alt="Tino Le Doc"></div>
    <a href="index.html" class="back">‚Üê Retour</a>

    <header>
        <h1>üí¨ Tchat Live</h1>
        <div class="badges">
            <div class="badge live"><span class="live-dot"></span>En direct</div>
            <div class="badge video">üìπ Vid√©o</div>
            <div class="badge secure">üîí S√©curis√©</div>
            <div class="badge">üõ°Ô∏è Mod√©r√©</div>
            <div class="badge users">üë• <span id="count">0</span></div>
        </div>
    </header>

    <div class="tabs">
        <button class="tab-btn active" data-tab="text">üí¨ Tchat Texte</button>
        <button class="tab-btn video-tab" data-tab="video">üìπ Vid√©o Live</button>
    </div>

    <!-- VIDEO TAB -->
    <div class="tab-content" id="tab-video">
        <div class="video-section">
            <div class="video-header">
                <h2><span class="rec"></span> Salon Vid√©o - Tino Le Doc</h2>
                <div class="video-count" id="videoCount">üë• 0 en appel</div>
            </div>
            <div class="video-join" id="videoJoin">
                <div class="icon">üìπ</div>
                <h3>Rejoignez le salon vid√©o !</h3>
                <p>Directement dans votre navigateur, sans application.<br>Compatible Android, Mac, Windows.</p>
                <button class="video-join-btn" id="videoJoinBtn">üìπ Rejoindre l'appel</button>
            </div>
            <div id="videoGrid" style="display:none;padding:10px;background:#000"></div>
            <div class="video-controls" id="videoControls">
                <button class="vc-btn" id="vcMic" title="Micro">üé§</button>
                <button class="vc-btn" id="vcCam" title="Cam√©ra">üìπ</button>
                <button class="vc-btn leave" id="vcLeave" title="Quitter">üìû</button>
            </div>
            <div class="video-info">
                <h4>üí° Infos :</h4>
                <ul>
                    <li>üì± Fonctionne sur Android, iPhone, Mac, Windows</li>
                    <li>üåê Aucune application requise, tout dans le navigateur</li>
                    <li>üîí Connexion chiffr√©e (WebRTC)</li>
                    <li>üë• Jusqu'a 6 participants simultan√©s</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- TEXT TAB -->
    <div class="tab-content active" id="tab-text">
        <section class="login" id="login">
            <h2>üëã Rejoindre le tchat</h2>
            <input type="text" id="pseudo" placeholder="Votre pseudo..." maxlength="20" autocomplete="off">
            <br><button id="joinBtn">üöÄ C'est parti !</button>
        </section>

        <div class="chat" id="chat">
            <div class="chat-head">
                <span><span class="live-dot"></span>Tchat</span>
                <span class="online">üë• <span id="count2">0</span></span>
            </div>

            <div class="messages" id="msgs">
                <div class="empty"><div class="icon">üí¨</div><p>Soyez le premier !</p></div>
            </div>

            <div class="typing" id="typing"></div>

            <div class="input-area">
                <div class="warn" id="warn">üõ°Ô∏è Message bloqu√© par la mod√©ration</div>
                <div class="rate-limit" id="rateLimit">‚è≥ Attendez avant d'envoyer un autre message</div>

                <div class="toolbar">
                    <button class="tool-btn" id="emojiBtnT" type="button">üòÄ</button>
                    <button class="tool-btn" id="gifBtnT" type="button">GIF</button>
                </div>

                <div class="picker" id="emojiPick">
                    <div class="emoji-cats">
                        <button class="cat-btn active" data-c="faces" type="button">üòÄ</button>
                        <button class="cat-btn" data-c="hands" type="button">üëç</button>
                        <button class="cat-btn" data-c="hearts" type="button">‚ù§Ô∏è</button>
                        <button class="cat-btn" data-c="animals" type="button">üê±</button>
                        <button class="cat-btn" data-c="food" type="button">üçï</button>
                        <button class="cat-btn" data-c="symbols" type="button">‚ú®</button>
                    </div>
                    <div class="emoji-grid" id="emojiG"></div>
                </div>

                <div class="picker" id="gifPick">
                    <input type="text" class="gif-search" id="gifQ" placeholder="üîç Rechercher un GIF..." maxlength="50">
                    <div class="gif-grid" id="gifG"><div class="gif-load">Chargement...</div></div>
                </div>

                <div class="quick">
                    <button class="qr" type="button">üëç</button>
                    <button class="qr" type="button">‚ù§Ô∏è</button>
                    <button class="qr" type="button">üòÇ</button>
                    <button class="qr" type="button">üî•</button>
                    <button class="qr" type="button">üëè</button>
                    <button class="qr" type="button">ü§ñ</button>
                    <button class="qr" type="button">üß†</button>
                    <button class="qr" type="button">üíØ</button>
                </div>

                <form class="form" id="form">
                    <input type="text" id="msg" placeholder="Message..." maxlength="500" autocomplete="off">
                    <button type="submit" id="sendBtn">üì§</button>
                </form>
            </div>
        </div>
    </div>

    <footer role="contentinfo"><strong>Tino Le Doc</strong> | <a href="avis.html">Avis</a> | <a href="index.html">D√©bat</a></footer>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="js/firebase-config.js"></script>
<script>
// ==================== S√âCURIT√â ====================

// Rate limiting c√¥t√© client
const RateLimiter = {
    lastMessage: 0,
    messageCount: 0,
    COOLDOWN: 2000,      // 2 secondes entre messages
    MAX_PER_MINUTE: 20,  // Max 20 messages/minute
    minuteStart: Date.now(),
    
    canSend() {
        const now = Date.now();
        
        // Reset compteur chaque minute
        if (now - this.minuteStart > 60000) {
            this.minuteStart = now;
            this.messageCount = 0;
        }
        
        // V√©rifier cooldown
        if (now - this.lastMessage < this.COOLDOWN) {
            return false;
        }
        
        // V√©rifier limite par minute
        if (this.messageCount >= this.MAX_PER_MINUTE) {
            return false;
        }
        
        return true;
    },
    
    recordMessage() {
        this.lastMessage = Date.now();
        this.messageCount++;
    }
};

// Validation des donn√©es
const Validator = {
    // Valider pseudo
    isValidPseudo(pseudo) {
        if (typeof pseudo !== 'string') return false;
        const trimmed = pseudo.trim();
        if (trimmed.length < 2 || trimmed.length > 20) return false;
        // Pas de caract√®res sp√©ciaux dangereux
        if (/[<>\"'`\\]/.test(trimmed)) return false;
        return true;
    },
    
    // Valider message texte
    isValidMessage(text) {
        if (typeof text !== 'string') return false;
        const trimmed = text.trim();
        if (trimmed.length < 1 || trimmed.length > 500) return false;
        return true;
    },
    
    // Valider URL GIF (uniquement Tenor)
    isValidGifUrl(url) {
        if (typeof url !== 'string') return false;
        // Accepter uniquement les URLs Tenor
        const tenorPattern = /^https:\/\/media\.tenor\.com\/.+$/;
        return tenorPattern.test(url);
    },
    
    // Sanitize pour affichage
    sanitize(text) {
        if (typeof text !== 'string') return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
};

// ==================== D√âTECTION MOBILE ====================
const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

// ==================== FIREBASE ====================
let user = null, oderId = null, msgsRef, usersRef, typeRef;

// Config Firebase chargee depuis js/firebase-config.js
const auth = firebaseAuth;
const db = firebaseDb;
try {
    msgsRef = db.ref('chatMessages');
    usersRef = db.ref('chatUsers');
    typeRef = db.ref('chatTyping');
} catch(e) { console.error('Firebase:', e); }

// ==================== TABS ====================
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        this.classList.add('active');
        document.getElementById('tab-' + this.dataset.tab).classList.add('active');
    });
});

// ==================== WEBRTC VIDEO ====================
const VideoChat = {
    localStream: null,
    peers: {},           // { oderId: RTCPeerConnection }
    remoteStreams: {},    // { oderId: MediaStream }
    myVideoId: null,
    micEnabled: true,
    camEnabled: true,
    roomRef: null,
    participantsRef: null,
    signalsRef: null,
    joined: false,

    STUN_SERVERS: {
        iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' },
            { urls: 'stun:stun2.l.google.com:19302' }
        ]
    },

    async joinCall() {
        if (this.joined) return;
        const joinBtn = document.getElementById('videoJoinBtn');
        joinBtn.disabled = true;
        joinBtn.textContent = 'Connexion...';

        // Verifier HTTPS (requis pour getUserMedia)
        if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
            alert('La vid√©o n√©cessite une connexion HTTPS s√©curis√©e.');
            joinBtn.disabled = false;
            joinBtn.textContent = 'üìπ Rejoindre l\'appel';
            return;
        }

        // Verifier que getUserMedia est disponible
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            alert('Votre navigateur ne supporte pas la vid√©o. Essayez Chrome ou Firefox.');
            joinBtn.disabled = false;
            joinBtn.textContent = 'üìπ Rejoindre l\'appel';
            return;
        }

        try {
            // Contraintes simples pour Android
            this.localStream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'user' },
                audio: true
            });
        } catch (err) {
            console.warn('Camera+audio failed:', err.name, err.message);
            // Si pas de camera, essayer juste audio
            try {
                this.localStream = await navigator.mediaDevices.getUserMedia({ video: false, audio: true });
                this.camEnabled = false;
            } catch (err2) {
                console.error('Audio-only failed:', err2.name, err2.message);
                let msg = 'Impossible d\'acc√©der √† la cam√©ra ou au micro.\n\n';
                if (err.name === 'NotAllowedError' || err2.name === 'NotAllowedError') {
                    msg += 'Autorisez l\'acc√®s dans les param√®tres de votre navigateur.';
                } else if (err.name === 'NotFoundError' || err2.name === 'NotFoundError') {
                    msg += 'Aucune cam√©ra ou micro d√©tect√© sur cet appareil.';
                } else {
                    msg += 'Erreur : ' + (err.message || err.name);
                }
                alert(msg);
                joinBtn.disabled = false;
                joinBtn.textContent = 'üìπ Rejoindre l\'appel';
                return;
            }
        }

        this.joined = true;
        this.myVideoId = 'v_' + crypto.getRandomValues(new Uint32Array(1))[0].toString(36) + '_' + Date.now();

        // Afficher l'UI
        document.getElementById('videoJoin').style.display = 'none';
        document.getElementById('videoControls').classList.add('active');

        // Afficher la grille
        const grid = document.getElementById('videoGrid');
        grid.style.cssText = 'display:block;padding:10px;background:#000;';

        // Creer la video via JS
        const video = document.createElement('video');
        video.autoplay = true;
        video.playsInline = true;
        video.muted = true;
        video.setAttribute('playsinline', '');
        video.setAttribute('webkit-playsinline', '');
        video.controls = false;
        video.style.cssText = 'display:block;width:90vw;max-width:800px;height:auto;aspect-ratio:3/4;object-fit:cover;background:#222;border-radius:12px;';

        video.srcObject = this.localStream;

        grid.innerHTML = '';
        grid.appendChild(video);

        this.localVideoEl = video;

        video.onloadedmetadata = () => {
            video.play().catch(() => {});
        };

        // Forcer play apres 2s si necessaire
        setTimeout(() => {
            if (video.paused && video.srcObject) {
                video.play().catch(() => {});
            }
        }, 2000);

        if (!this.camEnabled) {
            this.updateVideoOverlay(this.myVideoId, true);
        }

        // Firebase signaling
        this.roomRef = db.ref('videoRoom');
        this.participantsRef = this.roomRef.child('participants');
        this.signalsRef = this.roomRef.child('signals');

        // S'enregistrer comme participant
        const myRef = this.participantsRef.child(this.myVideoId);
        myRef.set({
            name: user || 'Anonyme',
            joinedAt: Date.now(),
            mic: this.micEnabled,
            cam: this.camEnabled
        });
        myRef.onDisconnect().remove();

        // Nettoyage des signaux a la deconnexion
        this.signalsRef.child(this.myVideoId).onDisconnect().remove();

        // Ecouter les nouveaux participants
        this.participantsRef.on('child_added', snap => {
            const peerId = snap.key;
            if (peerId === this.myVideoId) return;
            const data = snap.val();
            this.addVideoCell(peerId, data.name, false);
            this.updateGridLayout();
            this.updateParticipantCount();
            // Celui avec le plus grand ID cree l'offre
            if (this.myVideoId > peerId) {
                this.createOffer(peerId);
            }
        });

        // Ecouter les departs
        this.participantsRef.on('child_removed', snap => {
            const peerId = snap.key;
            this.removePeer(peerId);
            this.updateGridLayout();
            this.updateParticipantCount();
        });

        // Ecouter les mises a jour (mic/cam)
        this.participantsRef.on('child_changed', snap => {
            const peerId = snap.key;
            if (peerId === this.myVideoId) return;
            const data = snap.val();
            const nameTag = document.querySelector(`[data-peer="${peerId}"] .name-tag`);
            if (nameTag) {
                nameTag.innerHTML = data.name + (!data.mic ? ' <span class="mic-off">üîá</span>' : '');
            }
            if (!data.cam) {
                this.updateVideoOverlay(peerId, true);
            } else {
                this.updateVideoOverlay(peerId, false);
            }
        });

        // Ecouter les signaux entrants
        this.signalsRef.child(this.myVideoId).on('child_added', async snap => {
            const signal = snap.val();
            if (!signal) return;
            try {
                if (signal.type === 'offer') {
                    await this.handleOffer(signal.from, signal.sdp);
                } else if (signal.type === 'answer') {
                    await this.handleAnswer(signal.from, signal.sdp);
                } else if (signal.type === 'ice') {
                    await this.handleIce(signal.from, signal.candidate);
                }
            } catch (e) {
                console.error('Signal error:', e);
            }
            // Supprimer le signal traite
            snap.ref.remove();
        });

        this.updateParticipantCount();
        this.updateGridLayout();
    },

    async createOffer(peerId) {
        const pc = this.createPeerConnection(peerId);
        try {
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            await this.signalsRef.child(peerId).push({
                type: 'offer',
                from: this.myVideoId,
                sdp: offer.sdp
            });
        } catch (e) {
            console.error('Offer error:', e);
        }
    },

    async handleOffer(fromId, sdp) {
        const pc = this.createPeerConnection(fromId);
        try {
            await pc.setRemoteDescription(new RTCSessionDescription({ type: 'offer', sdp }));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            await this.signalsRef.child(fromId).push({
                type: 'answer',
                from: this.myVideoId,
                sdp: answer.sdp
            });
        } catch (e) {
            console.error('Answer error:', e);
        }
    },

    async handleAnswer(fromId, sdp) {
        const pc = this.peers[fromId];
        if (pc && pc.signalingState !== 'stable') {
            try {
                await pc.setRemoteDescription(new RTCSessionDescription({ type: 'answer', sdp }));
            } catch (e) {
                console.error('Set answer error:', e);
            }
        }
    },

    async handleIce(fromId, candidate) {
        const pc = this.peers[fromId];
        if (pc && candidate) {
            try {
                await pc.addIceCandidate(new RTCIceCandidate(candidate));
            } catch (e) {
                console.error('ICE error:', e);
            }
        }
    },

    createPeerConnection(peerId) {
        if (this.peers[peerId]) {
            this.peers[peerId].close();
        }

        const pc = new RTCPeerConnection(this.STUN_SERVERS);
        this.peers[peerId] = pc;

        // Ajouter les tracks locaux
        if (this.localStream) {
            this.localStream.getTracks().forEach(track => {
                pc.addTrack(track, this.localStream);
            });
        }

        // ICE candidates
        pc.onicecandidate = event => {
            if (event.candidate) {
                this.signalsRef.child(peerId).push({
                    type: 'ice',
                    from: this.myVideoId,
                    candidate: event.candidate.toJSON()
                });
            }
        };

        // Recevoir le flux distant
        pc.ontrack = event => {
            const stream = event.streams[0];
            if (stream) {
                this.remoteStreams[peerId] = stream;
                const videoEl = document.querySelector(`[data-peer="${peerId}"] video`);
                if (videoEl) {
                    videoEl.srcObject = stream;
                    this.playVideo(videoEl);
                }
            }
        };

        // Gerer la reconnexion
        pc.onconnectionstatechange = () => {
            if (pc.connectionState === 'failed') {
                // Retenter la connexion
                pc.close();
                delete this.peers[peerId];
                if (this.myVideoId > peerId) {
                    setTimeout(() => this.createOffer(peerId), 1000);
                }
            }
        };

        return pc;
    },

    // Play video avec retry et detection metadata
    playVideo(videoEl, retries = 5) {
        if (!videoEl) return;
        // Empecher ouverture en fenetre externe
        videoEl.controls = false;
        videoEl.playsInline = true;
        videoEl.setAttribute('playsinline', '');
        videoEl.setAttribute('webkit-playsinline', '');

        const attempt = () => {
            const p = videoEl.play();
            if (p && p.catch) {
                p.catch(err => {
                    console.warn('play() failed:', err.name, '- retries left:', retries);
                    if (retries > 0) {
                        retries--;
                        setTimeout(attempt, 500);
                    }
                });
            }
        };
        // Attendre que le stream soit pret
        if (videoEl.readyState >= 2) {
            attempt();
        } else {
            videoEl.addEventListener('loadedmetadata', () => {
                console.log('Video metadata loaded, dimensions:', videoEl.videoWidth, 'x', videoEl.videoHeight);
                attempt();
            }, { once: true });
            // Fallback si loadedmetadata ne se declenche pas
            setTimeout(attempt, 1000);
        }
    },

    addVideoCell(peerId, name, isLocal) {
        const grid = document.getElementById('videoGrid');
        if (grid.querySelector(`[data-peer="${peerId}"]`)) return;

        const cell = document.createElement('div');
        // Tout en inline style - pas de classes CSS
        cell.style.cssText = 'display:block;width:90vw;max-width:800px;background:#222;border-radius:12px;overflow:hidden;position:relative;margin-bottom:10px;';
        cell.dataset.peer = peerId;

        const initial = (name || '?').charAt(0).toUpperCase();

        // Video element
        const video = document.createElement('video');
        video.autoplay = true;
        video.playsInline = true;
        video.setAttribute('playsinline', '');
        video.setAttribute('webkit-playsinline', '');
        video.controls = false;
        video.style.cssText = 'display:block;width:90vw;max-width:800px;height:auto;aspect-ratio:3/4;object-fit:cover;background:#111;';
        if (isLocal) video.muted = true;
        cell.appendChild(video);

        // Name tag
        const tag = document.createElement('div');
        tag.style.cssText = 'position:absolute;bottom:8px;left:8px;padding:4px 10px;background:rgba(0,0,0,0.7);border-radius:8px;font-size:0.75rem;color:#fff;z-index:2;';
        tag.textContent = (name || '?') + (isLocal ? ' (vous)' : '');
        cell.appendChild(tag);

        grid.appendChild(cell);
    },

    updateVideoOverlay(peerId, showOverlay) {
        const cell = document.querySelector(`[data-peer="${peerId}"]`);
        if (!cell) return;
        const overlay = cell.querySelector('.no-video');
        const video = cell.querySelector('video');
        if (overlay) overlay.style.display = showOverlay ? 'flex' : 'none';
        if (video) video.style.opacity = showOverlay ? '0' : '1';
    },

    removePeer(peerId) {
        if (this.peers[peerId]) {
            this.peers[peerId].close();
            delete this.peers[peerId];
        }
        delete this.remoteStreams[peerId];
        const cell = document.querySelector(`[data-peer="${peerId}"]`);
        if (cell) cell.remove();
        // Nettoyer les signaux
        this.signalsRef.child(peerId).child(this.myVideoId).remove();
    },

    updateGridLayout() {
        const grid = document.getElementById('videoGrid');
        const cells = grid.querySelectorAll('.video-cell');
        const count = cells.length;
        // Adapter la taille des cellules selon le nombre
        cells.forEach(cell => {
            if (count <= 1) {
                cell.style.flex = '1 1 100%';
                cell.style.maxWidth = '100%';
                cell.style.height = '350px';
            } else if (count <= 2) {
                cell.style.flex = '1 1 48%';
                cell.style.maxWidth = '49%';
                cell.style.height = '300px';
            } else {
                cell.style.flex = '1 1 31%';
                cell.style.maxWidth = '33%';
                cell.style.height = '250px';
            }
        });
    },

    updateParticipantCount() {
        this.participantsRef.once('value', snap => {
            const n = snap.numChildren();
            document.getElementById('videoCount').textContent = 'üë• ' + n + ' en appel';
        });
    },

    toggleMic() {
        if (!this.localStream) return;
        this.micEnabled = !this.micEnabled;
        this.localStream.getAudioTracks().forEach(t => t.enabled = this.micEnabled);
        const btn = document.getElementById('vcMic');
        btn.textContent = this.micEnabled ? 'üé§' : 'üîá';
        btn.classList.toggle('off', !this.micEnabled);
        // Mettre a jour Firebase
        if (this.participantsRef && this.myVideoId) {
            this.participantsRef.child(this.myVideoId).update({ mic: this.micEnabled });
        }
    },

    toggleCam() {
        if (!this.localStream) return;
        const videoTracks = this.localStream.getVideoTracks();
        if (videoTracks.length === 0) return;
        this.camEnabled = !this.camEnabled;
        videoTracks.forEach(t => t.enabled = this.camEnabled);
        const btn = document.getElementById('vcCam');
        btn.textContent = this.camEnabled ? 'üìπ' : 'üì∑';
        btn.classList.toggle('off', !this.camEnabled);
        this.updateVideoOverlay(this.myVideoId, !this.camEnabled);
        if (this.participantsRef && this.myVideoId) {
            this.participantsRef.child(this.myVideoId).update({ cam: this.camEnabled });
        }
    },

    leaveCall() {
        this.joined = false;

        // Fermer toutes les connexions
        Object.keys(this.peers).forEach(id => {
            this.peers[id].close();
        });
        this.peers = {};
        this.remoteStreams = {};

        // Arreter le stream local
        if (this.localStream) {
            this.localStream.getTracks().forEach(t => t.stop());
            this.localStream = null;
        }

        // Se retirer de Firebase
        if (this.participantsRef && this.myVideoId) {
            this.participantsRef.child(this.myVideoId).remove();
        }
        if (this.signalsRef && this.myVideoId) {
            this.signalsRef.child(this.myVideoId).remove();
        }

        // Detacher les listeners
        if (this.participantsRef) {
            this.participantsRef.off();
        }
        if (this.signalsRef && this.myVideoId) {
            this.signalsRef.child(this.myVideoId).off();
        }

        // Reset UI
        if (this.localVideoEl) {
            this.localVideoEl.srcObject = null;
            this.localVideoEl = null;
        }
        document.getElementById('videoGrid').innerHTML = '';
        document.getElementById('videoGrid').style.display = 'none';
        document.getElementById('videoControls').classList.remove('active');
        document.getElementById('videoJoin').style.display = 'block';
        document.getElementById('videoCount').textContent = 'üë• 0 en appel';

        const joinBtn = document.getElementById('videoJoinBtn');
        joinBtn.disabled = false;
        joinBtn.textContent = 'üìπ Rejoindre l\'appel';

        this.micEnabled = true;
        this.camEnabled = true;
        document.getElementById('vcMic').textContent = 'üé§';
        document.getElementById('vcMic').classList.remove('off');
        document.getElementById('vcCam').textContent = 'üìπ';
        document.getElementById('vcCam').classList.remove('off');
    }
};

// Boutons video
document.getElementById('videoJoinBtn').addEventListener('click', () => VideoChat.joinCall());
document.getElementById('vcMic').addEventListener('click', () => VideoChat.toggleMic());
document.getElementById('vcCam').addEventListener('click', () => VideoChat.toggleCam());
document.getElementById('vcLeave').addEventListener('click', () => VideoChat.leaveCall());

// Compteur participants video en temps reel
try {
    db.ref('videoRoom/participants').on('value', snap => {
        const n = snap.numChildren();
        document.getElementById('videoCount').textContent = 'üë• ' + n + ' en appel';
    });
} catch(e) {}

// Cleanup video a la fermeture
window.addEventListener('beforeunload', () => {
    if (VideoChat.joined) VideoChat.leaveCall();
});

// ==================== MOD√âRATION ====================
const badWords = [
    /\b(connard?|conna?(rd|sse)|put(e|ain)|merde|encul[e√©]|batar+d|salop(e|ard)?|pd|fdp|ntm|nique|d[e√©]bile|cr[e√©]tin|abrutis?|idiot|imbecile|stupide)\b/gi,
    /\b(n[e√®]gr[eo]?|bougnou?le?|bamboula|macaque|sale\s*(arabe|noir|blanc|juif|musulman|gay)|youpin|feuj|chintok|brid√©)\b/gi,
    /\b(tapette|tafiole|tarlouze|p[e√©]d[e√©]|p√©dale|gouine)\b/gi,
    /\b(hitler|nazi|kkk)\b/gi
];

function isClean(text) {
    if (typeof text !== 'string') return false;
    const normalized = text.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    return !badWords.some(p => p.test(normalized));
}

function formatTime(ts) {
    return new Date(ts).toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
}

// ==================== EMOJIS ====================
const emo = {
    faces: ['üòÄ','üòÉ','üòÑ','üòÅ','üòÖ','üòÇ','ü§£','üòä','üòá','üôÇ','üòâ','üòç','ü•∞','üòò','üòã','üòõ','üòú','ü§™','ü§ó','ü§î','üòè','üôÑ','üò¨','üòÆ','üò≤','üò≥','ü•∫','üò¢','üò≠','üò±','üò§','üò°','üòà','üíÄ','ü§°','üëª','üëΩ','ü§ñ'],
    hands: ['üëç','üëé','üëä','‚úä','ü§õ','ü§ú','ü§û','‚úåÔ∏è','ü§ü','ü§ò','üëå','üëà','üëâ','üëÜ','üëá','‚úã','üëã','ü§ô','üí™','üôè','üëè','ü§ù'],
    hearts: ['‚ù§Ô∏è','üß°','üíõ','üíö','üíô','üíú','üñ§','ü§ç','üíî','üíï','üíñ','üíò','üíù'],
    animals: ['üê∂','üê±','üê≠','üêπ','üê∞','ü¶ä','üêª','üêº','üê®','üêØ','ü¶Å','üêÆ','üê∑','üê∏','üêµ','üêî','üêß','ü¶Ñ','üêù','ü¶ã'],
    food: ['üçï','üçî','üçü','üå≠','üçø','üç≥','üßÄ','üåÆ','üçú','üç£','üç¶','üç©','üéÇ','üç´','‚òï','üç∫','ü•Ç'],
    symbols: ['‚ú®','‚≠ê','üåü','üí´','‚ö°','üî•','üí•','üåà','‚òÄÔ∏è','üåô','üíØ','‚úÖ','‚ùå','‚ùì','‚ùó','üî¥','üü¢','üîµ','üèÜ','üéØ','üéâ','üéä']
};

function renderEmojis(cat) {
    const g = document.getElementById('emojiG');
    if (g && emo[cat]) g.innerHTML = emo[cat].map(e => `<button class="emoji-btn" type="button">${e}</button>`).join('');
}

document.querySelectorAll('.cat-btn').forEach(b => {
    b.addEventListener('click', function() {
        document.querySelectorAll('.cat-btn').forEach(x => x.classList.remove('active'));
        this.classList.add('active');
        renderEmojis(this.dataset.c);
    });
});

document.getElementById('emojiG').addEventListener('click', e => {
    if (e.target.classList.contains('emoji-btn')) {
        const input = document.getElementById('msg');
        if (input.value.length < 500) {
            input.value += e.target.textContent;
            input.focus();
        }
    }
});

document.getElementById('emojiBtnT').addEventListener('click', () => {
    document.getElementById('gifPick').classList.remove('active');
    const p = document.getElementById('emojiPick');
    p.classList.toggle('active');
    if (p.classList.contains('active')) renderEmojis('faces');
});

// ==================== GIFs ====================
async function loadGifs(query = '') {
    const g = document.getElementById('gifG');
    g.innerHTML = '<div class="gif-load">‚è≥</div>';
    
    // Sanitize query
    const safeQuery = query.replace(/[<>\"'`\\]/g, '').substring(0, 50);
    
    try {
        const url = safeQuery 
            ? `https://tenor.googleapis.com/v2/search?q=${encodeURIComponent(safeQuery)}&key=AIzaSyAyimkuYQYF_FXVALexPuGQctUWRURdCYQ&limit=9&media_filter=gif,tinygif&contentfilter=medium`
            : `https://tenor.googleapis.com/v2/featured?key=AIzaSyAyimkuYQYF_FXVALexPuGQctUWRURdCYQ&limit=9&media_filter=gif,tinygif&contentfilter=medium`;
        
        const r = await fetch(url);
        const d = await r.json();
        
        if (d.results?.length) {
            g.innerHTML = d.results.map(x => {
                const gifUrl = x.media_formats.gif?.url || x.media_formats.tinygif?.url;
                const thumbUrl = x.media_formats.tinygif?.url || gifUrl;
                // V√©rifier que c'est bien une URL Tenor
                if (!Validator.isValidGifUrl(gifUrl)) return '';
                return `<div class="gif-item" data-url="${Validator.sanitize(gifUrl)}"><img src="${Validator.sanitize(thumbUrl)}" loading="lazy" alt="GIF"></div>`;
            }).join('');
        } else {
            g.innerHTML = '<div class="gif-load">Aucun GIF üò¢</div>';
        }
    } catch(e) { 
        g.innerHTML = '<div class="gif-load">Erreur üò¢</div>'; 
    }
}

document.getElementById('gifBtnT').addEventListener('click', () => {
    document.getElementById('emojiPick').classList.remove('active');
    const p = document.getElementById('gifPick');
    p.classList.toggle('active');
    if (p.classList.contains('active')) loadGifs();
});

let gifTO;
document.getElementById('gifQ').addEventListener('input', e => {
    clearTimeout(gifTO);
    gifTO = setTimeout(() => loadGifs(e.target.value), 500);
});

document.getElementById('gifG').addEventListener('click', e => {
    const it = e.target.closest('.gif-item');
    if (it && user && msgsRef) {
        const gifUrl = it.dataset.url;
        
        // Valider URL
        if (!Validator.isValidGifUrl(gifUrl)) {
            console.warn('URL GIF invalide');
            return;
        }
        
        // Rate limiting
        if (!RateLimiter.canSend()) {
            document.getElementById('rateLimit').style.display = 'block';
            setTimeout(() => document.getElementById('rateLimit').style.display = 'none', 2000);
            return;
        }
        
        msgsRef.push({
            type: 'gif',
            user: user,
            oderId: oderId,
            url: gifUrl,
            timestamp: Date.now()
        });
        
        RateLimiter.recordMessage();
        document.getElementById('gifPick').classList.remove('active');
    }
});

document.querySelectorAll('.qr').forEach(b => {
    b.addEventListener('click', function() {
        const input = document.getElementById('msg');
        if (input.value.length < 500) {
            input.value += this.textContent;
            input.focus();
        }
    });
});

// ==================== JOIN ====================
document.getElementById('joinBtn').addEventListener('click', joinChat);
document.getElementById('pseudo').addEventListener('keypress', e => { if (e.key === 'Enter') joinChat(); });

function joinChat() {
    const pseudoInput = document.getElementById('pseudo');
    const p = pseudoInput.value.trim();
    
    // Validation
    if (!Validator.isValidPseudo(p)) {
        alert('Pseudo invalide (2-20 caract√®res, sans caract√®res sp√©ciaux)');
        return;
    }
    
    if (!isClean(p)) {
        alert('üõ°Ô∏è Pseudo non autoris√©');
        return;
    }
    
    user = p;
    // ID unique s√©curis√©
    oderId = 'u_' + crypto.getRandomValues(new Uint32Array(1))[0].toString(36) + '_' + Date.now();
    
    if (usersRef) {
        const uref = usersRef.child(oderId);
        uref.set({name: user, joinedAt: Date.now()});
        uref.onDisconnect().remove();
    }
    
    document.getElementById('login').style.display = 'none';
    document.getElementById('chat').classList.add('active');
    
    if (msgsRef) {
        msgsRef.push({type: 'system', action: 'join', user, timestamp: Date.now()});
    }
    
    loadMessages();
    document.getElementById('msg').focus();
}

// ==================== MESSAGES ====================
function loadMessages() {
    if (!msgsRef) return;
    
    msgsRef.limitToLast(50).on('child_added', s => {
        const d = s.val();
        if (d) displayMessage(d);
    }, err => console.error('Erreur msgs:', err));
}

function displayMessage(d) {
    const c = document.getElementById('msgs');
    const emp = c.querySelector('.empty');
    if (emp) emp.remove();
    
    const div = document.createElement('div');
    
    if (d.type === 'system') {
        div.className = 'sys ' + (d.action || '');
        div.textContent = `üëã ${Validator.sanitize(d.user)} ${d.action === 'join' ? 'a rejoint' : 'a quitt√©'}`;
    } else {
        div.className = 'msg' + (d.oderId === oderId ? ' own' : '');
        
        let content;
        if (d.type === 'gif' && Validator.isValidGifUrl(d.url)) {
            content = `<img src="${Validator.sanitize(d.url)}" alt="GIF" loading="lazy" onerror="this.style.display='none'">`;
        } else {
            content = Validator.sanitize(d.text || '');
        }
        
        const userName = Validator.sanitize(d.user || '?');
        const initial = userName.charAt(0).toUpperCase();
        
        div.innerHTML = `
            <div class="avatar">${initial}</div>
            <div class="bubble">
                <div class="msg-head">
                    <span class="msg-name">${userName}</span>
                    <span class="msg-time">${d.timestamp ? formatTime(d.timestamp) : ''}</span>
                </div>
                <div class="msg-text">${content}</div>
            </div>
        `;
    }
    
    c.appendChild(div);
    c.scrollTop = c.scrollHeight;
}

// ==================== SEND ====================
document.getElementById('form').addEventListener('submit', e => { 
    e.preventDefault(); 
    sendMsg(); 
});

function sendMsg() {
    const inp = document.getElementById('msg');
    const t = inp.value.trim();
    const warn = document.getElementById('warn');
    const rateLimit = document.getElementById('rateLimit');
    
    // Validations
    if (!t || !user || !msgsRef) return;
    
    if (!Validator.isValidMessage(t)) {
        warn.textContent = 'üõ°Ô∏è Message invalide (1-500 caract√®res)';
        warn.style.display = 'block';
        setTimeout(() => warn.style.display = 'none', 3000);
        return;
    }
    
    if (!isClean(t)) {
        warn.textContent = 'üõ°Ô∏è Message bloqu√© par la mod√©ration';
        warn.style.display = 'block';
        setTimeout(() => warn.style.display = 'none', 3000);
        return;
    }
    
    // Rate limiting
    if (!RateLimiter.canSend()) {
        rateLimit.style.display = 'block';
        setTimeout(() => rateLimit.style.display = 'none', 2000);
        return;
    }
    
    msgsRef.push({
        type: 'message',
        user: user,
        oderId: oderId,
        text: t,
        timestamp: Date.now()
    });
    
    RateLimiter.recordMessage();
    inp.value = '';
    
    document.getElementById('emojiPick').classList.remove('active');
    document.getElementById('gifPick').classList.remove('active');
    
    if (typeRef && oderId) typeRef.child(oderId).remove();
}

// Mod√©ration en temps r√©el
document.getElementById('msg').addEventListener('input', function() {
    const warn = document.getElementById('warn');
    if (!isClean(this.value) && this.value.length > 2) {
        warn.textContent = 'üõ°Ô∏è Contenu non autoris√© d√©tect√©';
        warn.style.display = 'block';
    } else {
        warn.style.display = 'none';
    }
    
    // Typing indicator
    if (user && oderId && typeRef) {
        if (this.value.length > 0) {
            typeRef.child(oderId).set({name: user, at: Date.now()});
        } else {
            typeRef.child(oderId).remove();
        }
    }
});

// ==================== ONLINE & TYPING ====================
if (usersRef) {
    usersRef.on('value', s => {
        const n = s.numChildren();
        document.getElementById('count').textContent = n;
        document.getElementById('count2').textContent = n;
    });
}

if (typeRef) {
    typeRef.on('value', s => {
        const ti = document.getElementById('typing');
        const arr = [];
        
        s.forEach(c => {
            if (c.key !== oderId && c.val().at && Date.now() - c.val().at < 5000) {
                arr.push(Validator.sanitize(c.val().name));
            }
        });
        
        if (arr.length) {
            ti.textContent = arr.length === 1 ? `${arr[0]} √©crit...` : `${arr.join(', ')} √©crivent...`;
            ti.classList.add('active');
        } else {
            ti.classList.remove('active');
        }
    });
}

// Cleanup typing indicators
setInterval(() => {
    if (typeRef) {
        typeRef.once('value', s => {
            s.forEach(c => {
                if (c.val().at && Date.now() - c.val().at > 5000) {
                    c.ref.remove();
                }
            });
        });
    }
}, 5000);

// ==================== CLEANUP ====================
window.addEventListener('beforeunload', () => {
    if (oderId && usersRef) usersRef.child(oderId).remove();
    if (user && msgsRef) msgsRef.push({type: 'system', action: 'leave', user, timestamp: Date.now()});
});

// ==================== MOBILE KEYBOARD ====================
if (isMobile) {
    const msgInput = document.getElementById('msg');
    const pseudoInput = document.getElementById('pseudo');
    const chatEl = document.getElementById('chat');
    const msgsEl = document.getElementById('msgs');

    // Gestion du clavier virtuel Android via visualViewport
    if (window.visualViewport) {
        window.visualViewport.addEventListener('resize', () => {
            // Scroll vers le bas quand le clavier s'ouvre
            if (chatEl.classList.contains('active')) {
                setTimeout(() => msgsEl.scrollTop = msgsEl.scrollHeight, 100);
            }
        });
    }

    // Scroll au focus sur l'input message
    msgInput.addEventListener('focus', () => {
        setTimeout(() => {
            msgInput.scrollIntoView({block: 'nearest', behavior: 'smooth'});
            msgsEl.scrollTop = msgsEl.scrollHeight;
        }, 300);
    });

    // Fermer les pickers quand on tape
    msgInput.addEventListener('focus', () => {
        document.getElementById('emojiPick').classList.remove('active');
        document.getElementById('gifPick').classList.remove('active');
    });
}

// Init
renderEmojis('faces');
console.log('‚úÖ Tchat s√©curis√© pr√™t');
</script>
</body>
</html>
