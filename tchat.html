<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tchat Live üí¨ Tino Le Doc</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;700&family=Syne:wght@700;800&display=swap" rel="stylesheet">
    <style>
        :root{--bg:#0a0a0f;--cyan:#00f5ff;--magenta:#ff00aa;--yellow:#f5ff00;--orange:#ff9500;--green:#00ff88;--red:#ff4444;--text:#e8e8e8;--glass:rgba(255,255,255,0.05)}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Space Grotesk',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
        .container{max-width:800px;margin:0 auto;padding:15px;display:flex;flex-direction:column;min-height:100vh}
        .logo{text-align:center;padding:10px 0}
        .logo img{max-width:100px;filter:drop-shadow(0 5px 20px rgba(255,165,0,0.4))}
        .back{color:var(--cyan);text-decoration:none;font-size:0.85rem}
        header{text-align:center;padding:15px 0}
        header h1{font-family:'Syne',sans-serif;font-size:1.8rem;background:linear-gradient(135deg,var(--magenta),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .badges{display:flex;gap:8px;justify-content:center;margin-top:10px;flex-wrap:wrap}
        .badge{padding:5px 12px;background:var(--glass);border:1px solid var(--green);border-radius:20px;font-size:0.75rem;color:var(--green);display:flex;align-items:center;gap:5px}
        .badge.live{border-color:var(--magenta);color:var(--magenta);animation:pulse 2s infinite}
        .badge.users{border-color:var(--cyan);color:var(--cyan)}
        @keyframes pulse{0%,100%{box-shadow:0 0 10px rgba(255,0,170,0.3)}50%{box-shadow:0 0 25px rgba(255,0,170,0.6)}}
        .live-dot{width:8px;height:8px;background:var(--green);border-radius:50%;animation:blink 1.5s infinite}
        @keyframes blink{0%,100%{opacity:1}50%{opacity:0.4}}
        
        .login{background:var(--glass);border:1px solid rgba(255,255,255,0.1);border-radius:20px;padding:30px;text-align:center;margin:20px 0}
        .login h2{font-family:'Syne',sans-serif;color:var(--cyan);margin-bottom:20px}
        .login input{width:100%;max-width:280px;padding:12px 18px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.15);border-radius:12px;color:var(--text);font-family:inherit;font-size:1rem;text-align:center;margin-bottom:15px}
        .login input:focus{outline:none;border-color:var(--cyan)}
        .login button{padding:12px 35px;background:linear-gradient(135deg,var(--magenta),var(--cyan));border:none;border-radius:12px;color:#fff;font-family:'Syne',sans-serif;font-size:1rem;font-weight:700;cursor:pointer}
        .login button:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(255,0,170,0.4)}
        
        .chat{display:none;flex:1;flex-direction:column;background:var(--glass);border:1px solid rgba(255,255,255,0.1);border-radius:20px;overflow:hidden;margin:10px 0}
        .chat.active{display:flex}
        .chat-head{padding:12px 15px;background:rgba(255,255,255,0.03);border-bottom:1px solid rgba(255,255,255,0.08);display:flex;justify-content:space-between;align-items:center}
        .chat-head span{font-family:'Syne',sans-serif;display:flex;align-items:center;gap:8px}
        .online{font-size:0.8rem;color:var(--cyan)}
        
        .messages{flex:1;overflow-y:auto;padding:15px;display:flex;flex-direction:column;gap:12px;min-height:250px;max-height:400px}
        .messages::-webkit-scrollbar{width:5px}
        .messages::-webkit-scrollbar-thumb{background:var(--cyan);border-radius:5px}
        
        .msg{display:flex;gap:10px;animation:slideIn 0.3s}
        @keyframes slideIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        .msg.own{flex-direction:row-reverse}
        .avatar{width:36px;height:36px;background:linear-gradient(135deg,var(--orange),var(--yellow));border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--bg);font-size:0.9rem;flex-shrink:0}
        .msg.own .avatar{background:linear-gradient(135deg,var(--magenta),var(--cyan))}
        .bubble{max-width:75%;background:rgba(255,255,255,0.08);border-radius:16px 16px 16px 4px;padding:10px 14px}
        .msg.own .bubble{background:linear-gradient(135deg,rgba(255,0,170,0.2),rgba(0,245,255,0.2));border-radius:16px 16px 4px 16px}
        .msg-head{display:flex;gap:8px;align-items:center;margin-bottom:4px}
        .msg-name{font-weight:700;font-size:0.85rem;color:var(--orange)}
        .msg.own .msg-name{color:var(--cyan)}
        .msg-time{font-size:0.7rem;color:rgba(255,255,255,0.4)}
        .msg-text{line-height:1.4;word-wrap:break-word}
        .msg-text img{max-width:180px;max-height:130px;border-radius:10px;margin-top:5px;display:block}
        
        .sys{text-align:center;padding:8px;font-size:0.8rem;color:rgba(255,255,255,0.5);font-style:italic}
        .sys.join{color:var(--green)}
        .sys.leave{color:var(--red)}
        
        .empty{text-align:center;padding:40px;color:rgba(255,255,255,0.4)}
        .empty .icon{font-size:2.5rem;margin-bottom:10px}
        
        .typing{display:none;padding:8px 15px;font-size:0.8rem;color:rgba(255,255,255,0.5);font-style:italic}
        .typing.active{display:block}
        
        .input-area{padding:12px 15px;background:rgba(255,255,255,0.03);border-top:1px solid rgba(255,255,255,0.08)}
        .warn{display:none;padding:8px 12px;background:rgba(255,68,68,0.15);border:1px solid var(--red);border-radius:10px;margin-bottom:10px;color:var(--red);font-size:0.8rem}
        
        .toolbar{display:flex;gap:5px;margin-bottom:10px}
        .tool-btn{width:42px;height:42px;border:none;background:rgba(255,255,255,0.08);border-radius:10px;cursor:pointer;font-size:1.2rem;transition:all 0.2s}
        .tool-btn:hover{background:rgba(255,255,255,0.15);transform:scale(1.1)}
        .tool-btn.active{background:linear-gradient(135deg,var(--magenta),var(--cyan))}
        
        .picker{display:none;background:rgba(15,15,25,0.98);border:1px solid rgba(255,255,255,0.1);border-radius:15px;padding:12px;margin-bottom:10px;max-height:280px;overflow:hidden}
        .picker.active{display:block}
        
        .emoji-cats{display:flex;gap:5px;margin-bottom:10px;overflow-x:auto;padding-bottom:5px}
        .cat-btn{padding:8px 10px;background:rgba(255,255,255,0.08);border:none;border-radius:8px;cursor:pointer;font-size:1.1rem}
        .cat-btn:hover,.cat-btn.active{background:rgba(0,245,255,0.2)}
        
        .emoji-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:4px;max-height:160px;overflow-y:auto}
        .emoji-btn{border:none;background:none;cursor:pointer;font-size:1.3rem;padding:5px;border-radius:8px}
        .emoji-btn:hover{background:rgba(255,255,255,0.15);transform:scale(1.15)}
        
        .gif-search{width:100%;padding:10px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);border-radius:10px;color:var(--text);font-family:inherit;margin-bottom:10px}
        .gif-search:focus{outline:none;border-color:var(--cyan)}
        .gif-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;max-height:180px;overflow-y:auto}
        .gif-item{cursor:pointer;border-radius:8px;overflow:hidden;transition:transform 0.2s}
        .gif-item:hover{transform:scale(1.05)}
        .gif-item img{width:100%;height:70px;object-fit:cover}
        .gif-load{text-align:center;padding:20px;color:rgba(255,255,255,0.5);grid-column:1/-1}
        
        .quick{display:flex;gap:5px;margin-bottom:10px;flex-wrap:wrap}
        .qr{padding:6px 10px;background:rgba(255,255,255,0.08);border:none;border-radius:20px;cursor:pointer;font-size:1rem;transition:all 0.2s}
        .qr:hover{background:rgba(255,255,255,0.15);transform:scale(1.1)}
        
        .form{display:flex;gap:8px}
        .form input{flex:1;padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.15);border-radius:25px;color:var(--text);font-family:inherit}
        .form input:focus{outline:none;border-color:var(--cyan)}
        .form button{padding:12px 18px;background:linear-gradient(135deg,var(--magenta),var(--cyan));border:none;border-radius:25px;color:#fff;font-size:1.1rem;cursor:pointer}
        .form button:hover{transform:scale(1.05)}
        
        .error-msg{background:rgba(255,68,68,0.2);border:1px solid var(--red);padding:15px;border-radius:10px;margin:10px 0;text-align:center;color:var(--red)}
        
        footer{text-align:center;padding:15px;font-size:0.8rem;color:rgba(255,255,255,0.4)}
        footer a{color:var(--cyan);text-decoration:none}
        
        @media(max-width:600px){.emoji-grid{grid-template-columns:repeat(6,1fr)}.gif-grid{grid-template-columns:repeat(2,1fr)}.bubble{max-width:85%}}
    </style>
</head>
<body>
<div class="container">
    <div class="logo"><img src="1000074492.png" alt="Tino Le Doc"></div>
    <a href="index.html" class="back">‚Üê Retour</a>
    
    <header>
        <h1>üí¨ Tchat Live</h1>
        <div class="badges">
            <div class="badge live"><span class="live-dot"></span>En direct</div>
            <div class="badge">üõ°Ô∏è Mod√©r√©</div>
            <div class="badge users">üë• <span id="count">0</span></div>
        </div>
    </header>
    
    <div id="errorBox"></div>
    
    <section class="login" id="login">
        <h2>üëã Rejoindre</h2>
        <input type="text" id="pseudo" placeholder="Votre pseudo..." maxlength="20">
        <br><button id="joinBtn">üöÄ C'est parti !</button>
    </section>
    
    <div class="chat" id="chat">
        <div class="chat-head">
            <span><span class="live-dot"></span>Tchat</span>
            <span class="online">üë• <span id="count2">0</span></span>
        </div>
        
        <div class="messages" id="msgs">
            <div class="empty"><div class="icon">üí¨</div><p>Soyez le premier !</p></div>
        </div>
        
        <div class="typing" id="typing"></div>
        
        <div class="input-area">
            <div class="warn" id="warn">üõ°Ô∏è Message bloqu√©</div>
            
            <div class="toolbar">
                <button class="tool-btn" id="emojiBtnT">üòÄ</button>
                <button class="tool-btn" id="gifBtnT">GIF</button>
            </div>
            
            <div class="picker" id="emojiPick">
                <div class="emoji-cats">
                    <button class="cat-btn active" data-c="faces">üòÄ</button>
                    <button class="cat-btn" data-c="hands">üëç</button>
                    <button class="cat-btn" data-c="hearts">‚ù§Ô∏è</button>
                    <button class="cat-btn" data-c="animals">üê±</button>
                    <button class="cat-btn" data-c="food">üçï</button>
                    <button class="cat-btn" data-c="things">üí°</button>
                    <button class="cat-btn" data-c="symbols">‚ú®</button>
                </div>
                <div class="emoji-grid" id="emojiG"></div>
            </div>
            
            <div class="picker" id="gifPick">
                <input type="text" class="gif-search" id="gifQ" placeholder="üîç Rechercher...">
                <div class="gif-grid" id="gifG"><div class="gif-load">Chargement...</div></div>
            </div>
            
            <div class="quick">
                <button class="qr">üëç</button>
                <button class="qr">‚ù§Ô∏è</button>
                <button class="qr">üòÇ</button>
                <button class="qr">üî•</button>
                <button class="qr">üëè</button>
                <button class="qr">ü§ñ</button>
                <button class="qr">üß†</button>
                <button class="qr">üíØ</button>
                <button class="qr">üòç</button>
                <button class="qr">üéâ</button>
            </div>
            
            <form class="form" id="form">
                <input type="text" id="msg" placeholder="Message..." maxlength="300" autocomplete="off">
                <button type="submit">üì§</button>
            </form>
        </div>
    </div>
    
    <footer><strong>Tino Le Doc</strong> | <a href="avis.html">Avis</a> | <a href="index.html">D√©bat</a></footer>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script>
// Variables globales
let user = null;
let uid = null;
let msgsRef, usersRef, typeRef;

// Init Firebase
try {
    const app = firebase.initializeApp({
        apiKey: "AIzaSyCV0R7uSlyTm2yEL-EoAd6_DZa16R4WiPc",
        authDomain: "tino-le-doc.firebaseapp.com",
        databaseURL: "https://tino-le-doc-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "tino-le-doc",
        storageBucket: "tino-le-doc.firebasestorage.app",
        messagingSenderId: "865928450606",
        appId: "1:865928450606:web:20fcb9497f7e0ded2fc5bf"
    });
    
    const db = firebase.database();
    msgsRef = db.ref('chatMessages');
    usersRef = db.ref('chatUsers');
    typeRef = db.ref('chatTyping');
    
    console.log('Firebase initialis√© ‚úÖ');
} catch(e) {
    console.error('Erreur Firebase:', e);
    document.getElementById('errorBox').innerHTML = '<div class="error-msg">‚ùå Erreur de connexion Firebase. Rechargez la page.</div>';
}

// Emojis
const emo = {
    faces: ['üòÄ','üòÉ','üòÑ','üòÅ','üòÖ','üòÇ','ü§£','üòä','üòá','üôÇ','üòâ','üòç','ü•∞','üòò','üòã','üòõ','üòú','ü§™','üòù','ü§ó','ü§î','üòê','üòè','üôÑ','üò¨','üòÆ','üò≤','üò≥','ü•∫','üò¢','üò≠','üò±','üò§','üò°','üòà','üíÄ','üí©','ü§°','üëª','üëΩ','ü§ñ','üò∫','üòª','üôÄ'],
    hands: ['üëç','üëé','üëä','‚úä','ü§õ','ü§ú','ü§û','‚úåÔ∏è','ü§ü','ü§ò','üëå','ü§å','üëà','üëâ','üëÜ','üëá','‚òùÔ∏è','‚úã','ü§ö','üñê','üëã','ü§ô','üí™','üôè','üëè','ü§ù'],
    hearts: ['‚ù§Ô∏è','üß°','üíõ','üíö','üíô','üíú','üñ§','ü§ç','üíî','‚ù£Ô∏è','üíï','üíû','üíì','üíó','üíñ','üíò','üíù','‚ô•Ô∏è','üòç','ü•∞','üòò','üòª'],
    animals: ['üê∂','üê±','üê≠','üêπ','üê∞','ü¶ä','üêª','üêº','üê®','üêØ','ü¶Å','üêÆ','üê∑','üê∏','üêµ','üêî','üêß','üê¶','ü¶Ü','ü¶Ö','ü¶â','üê∫','üê¥','ü¶Ñ','üêù','ü¶ã','üêô','üê¨','üê≥','ü¶à','üêä','ü¶ñ'],
    food: ['üçï','üçî','üçü','üå≠','üçø','ü•ì','üç≥','ü•û','üßÄ','ü•ó','üåÆ','üåØ','üçú','üç£','üç±','üç¶','üç©','üç™','üéÇ','üç´','üç¨','üç≠','‚òï','üç∫','üçª','ü•Ç','üç∑','üçπ'],
    things: ['üí°','üî¶','üí∞','üíé','üîß','‚öôÔ∏è','üí£','üîÆ','üíä','üíª','üì±','üñ•Ô∏è','üì∑','üé•','üì∫','üéÆ','üïπÔ∏è','üéß','üé§','üéµ','üé∏','üéπ','üé∫','üé∑'],
    symbols: ['‚ú®','‚≠ê','üåü','üí´','‚ö°','üî•','üí•','‚òÑÔ∏è','üåà','‚òÄÔ∏è','üåô','üíØ','‚úÖ','‚ùå','‚ùì','‚ùó','‚ôªÔ∏è','üî¥','üü†','üü°','üü¢','üîµ','üü£','‚ö´','‚ö™','üèÜ','ü•á','üéØ','üé™','üé≠','üé®']
};

// Mod√©ration
const badWords = [
    /\b(connard?|conna?(rd|sse)|put(e|ain)|merde|encul[e√©]|batar+d|salop(e|ard)?|pd|fdp|ntm|nique|d[e√©]bile|cr[e√©]tin|abrutis?|idiot|imbecile|stupide)\b/gi,
    /\b(n[e√®]gr[eo]?|bougnou?le?|bamboula|macaque|sale\s*(arabe|noir|blanc|juif|musulman|gay)|youpin|feuj|chintok|brid√©)\b/gi,
    /\b(tapette|tafiole|tarlouze|p[e√©]d[e√©]|p√©dale|gouine)\b/gi,
    /\b(hitler|nazi|kkk)\b/gi
];

function isClean(text) {
    const normalized = text.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    return !badWords.some(pattern => pattern.test(normalized));
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatTime(timestamp) {
    return new Date(timestamp).toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
}

// Emoji picker
function renderEmojis(category) {
    const grid = document.getElementById('emojiG');
    if (grid && emo[category]) {
        grid.innerHTML = emo[category].map(e => `<button class="emoji-btn" type="button">${e}</button>`).join('');
    }
}

// Event listeners pour les cat√©gories d'emojis
document.querySelectorAll('.cat-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        renderEmojis(this.dataset.c);
    });
});

// Click sur emoji
document.getElementById('emojiG').addEventListener('click', function(e) {
    if (e.target.classList.contains('emoji-btn')) {
        const input = document.getElementById('msg');
        input.value += e.target.textContent;
        input.focus();
    }
});

// Toggle emoji picker
document.getElementById('emojiBtnT').addEventListener('click', function() {
    document.getElementById('gifPick').classList.remove('active');
    const picker = document.getElementById('emojiPick');
    picker.classList.toggle('active');
    if (picker.classList.contains('active')) {
        renderEmojis('faces');
    }
});

// GIF Picker (Tenor API)
async function loadGifs(query = '') {
    const grid = document.getElementById('gifG');
    grid.innerHTML = '<div class="gif-load">‚è≥ Chargement...</div>';
    
    try {
        const apiKey = 'AIzaSyAyimkuYQYF_FXVALexPuGQctUWRURdCYQ';
        const url = query 
            ? `https://tenor.googleapis.com/v2/search?q=${encodeURIComponent(query)}&key=${apiKey}&limit=12&media_filter=tinygif,gif`
            : `https://tenor.googleapis.com/v2/featured?key=${apiKey}&limit=12&media_filter=tinygif,gif`;
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.results && data.results.length > 0) {
            grid.innerHTML = data.results.map(gif => {
                const preview = gif.media_formats.tinygif?.url || gif.media_formats.gif?.url;
                const full = gif.media_formats.gif?.url || preview;
                return `<div class="gif-item" data-url="${full}"><img src="${preview}" alt="GIF" loading="lazy"></div>`;
            }).join('');
        } else {
            grid.innerHTML = '<div class="gif-load">Aucun GIF trouv√© üò¢</div>';
        }
    } catch (error) {
        console.error('Erreur GIF:', error);
        grid.innerHTML = '<div class="gif-load">Erreur de chargement üò¢</div>';
    }
}

// Toggle GIF picker
document.getElementById('gifBtnT').addEventListener('click', function() {
    document.getElementById('emojiPick').classList.remove('active');
    const picker = document.getElementById('gifPick');
    picker.classList.toggle('active');
    if (picker.classList.contains('active')) {
        loadGifs();
    }
});

// Recherche GIF
let gifTimeout;
document.getElementById('gifQ').addEventListener('input', function(e) {
    clearTimeout(gifTimeout);
    gifTimeout = setTimeout(() => loadGifs(e.target.value), 500);
});

// Click sur GIF
document.getElementById('gifG').addEventListener('click', function(e) {
    const item = e.target.closest('.gif-item');
    if (item && user && msgsRef) {
        const gifUrl = item.dataset.url;
        msgsRef.push({
            type: 'gif',
            user: user,
            oderId: uid,
            url: gifUrl,
            timestamp: Date.now()
        });
        document.getElementById('gifPick').classList.remove('active');
    }
});

// Quick reactions
document.querySelectorAll('.qr').forEach(btn => {
    btn.addEventListener('click', function() {
        const input = document.getElementById('msg');
        input.value += this.textContent;
        input.focus();
    });
});

// Rejoindre le tchat
document.getElementById('joinBtn').addEventListener('click', joinChat);
document.getElementById('pseudo').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') joinChat();
});

function joinChat() {
    const pseudo = document.getElementById('pseudo').value.trim();
    
    if (pseudo.length < 2) {
        alert('Le pseudo doit avoir au moins 2 caract√®res');
        return;
    }
    
    if (!isClean(pseudo)) {
        alert('üõ°Ô∏è Ce pseudo n\'est pas autoris√©');
        return;
    }
    
    user = pseudo;
    uid = 'user_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
    
    // Enregistrer l'utilisateur
    if (usersRef) {
        const userRef = usersRef.child(uid);
        userRef.set({
            name: user,
            joinedAt: Date.now()
        });
        userRef.onDisconnect().remove();
    }
    
    // Afficher le chat
    document.getElementById('login').style.display = 'none';
    document.getElementById('chat').classList.add('active');
    
    // Message de bienvenue
    if (msgsRef) {
        msgsRef.push({
            type: 'system',
            action: 'join',
            user: user,
            timestamp: Date.now()
        });
    }
    
    // Charger les messages existants
    loadMessages();
    
    document.getElementById('msg').focus();
}

// Charger les messages
function loadMessages() {
    if (!msgsRef) return;
    
    // √âcouter les nouveaux messages
    msgsRef.limitToLast(50).on('child_added', function(snapshot) {
        const data = snapshot.val();
        if (data) {
            displayMessage(data);
        }
    }, function(error) {
        console.error('Erreur lecture messages:', error);
        document.getElementById('errorBox').innerHTML = '<div class="error-msg">‚ùå Erreur de lecture. V√©rifiez les r√®gles Firebase.</div>';
    });
}

// Afficher un message
function displayMessage(data) {
    const container = document.getElementById('msgs');
    
    // Supprimer le message "vide"
    const emptyMsg = container.querySelector('.empty');
    if (emptyMsg) {
        emptyMsg.remove();
    }
    
    const div = document.createElement('div');
    
    if (data.type === 'system') {
        div.className = 'sys ' + (data.action || '');
        const action = data.action === 'join' ? 'a rejoint' : 'a quitt√©';
        div.textContent = `üëã ${escapeHtml(data.user)} ${action} le tchat`;
    } else {
        const isOwn = data.oderId === uid;
        div.className = 'msg' + (isOwn ? ' own' : '');
        
        let content;
        if (data.type === 'gif') {
            content = `<img src="${escapeHtml(data.url)}" alt="GIF" onerror="this.style.display='none'">`;
        } else {
            content = escapeHtml(data.text || '');
        }
        
        const initial = (data.user || '?').charAt(0).toUpperCase();
        const time = data.timestamp ? formatTime(data.timestamp) : '';
        
        div.innerHTML = `
            <div class="avatar">${initial}</div>
            <div class="bubble">
                <div class="msg-head">
                    <span class="msg-name">${escapeHtml(data.user || 'Anonyme')}</span>
                    <span class="msg-time">${time}</span>
                </div>
                <div class="msg-text">${content}</div>
            </div>
        `;
    }
    
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
}

// Envoyer un message
document.getElementById('form').addEventListener('submit', function(e) {
    e.preventDefault();
    sendMessage();
});

function sendMessage() {
    const input = document.getElementById('msg');
    const text = input.value.trim();
    const warn = document.getElementById('warn');
    
    if (!text || !user || !msgsRef) return;
    
    if (!isClean(text)) {
        warn.style.display = 'block';
        setTimeout(() => warn.style.display = 'none', 3000);
        return;
    }
    
    msgsRef.push({
        type: 'message',
        user: user,
        oderId: uid,
        text: text,
        timestamp: Date.now()
    });
    
    input.value = '';
    
    // Fermer les pickers
    document.getElementById('emojiPick').classList.remove('active');
    document.getElementById('gifPick').classList.remove('active');
    
    // Supprimer indicateur de frappe
    if (typeRef && uid) {
        typeRef.child(uid).remove();
    }
}

// Mod√©ration en temps r√©el
document.getElementById('msg').addEventListener('input', function() {
    const warn = document.getElementById('warn');
    
    if (!isClean(this.value) && this.value.length > 2) {
        warn.style.display = 'block';
    } else {
        warn.style.display = 'none';
    }
    
    // Indicateur de frappe
    if (user && uid && typeRef) {
        if (this.value.length > 0) {
            typeRef.child(uid).set({name: user, at: Date.now()});
        } else {
            typeRef.child(uid).remove();
        }
    }
});

// Compteur d'utilisateurs en ligne
if (usersRef) {
    usersRef.on('value', function(snapshot) {
        const count = snapshot.numChildren();
        document.getElementById('count').textContent = count;
        document.getElementById('count2').textContent = count;
    });
}

// Indicateur de frappe
if (typeRef) {
    typeRef.on('value', function(snapshot) {
        const indicator = document.getElementById('typing');
        const typingUsers = [];
        
        snapshot.forEach(function(child) {
            const data = child.val();
            if (child.key !== uid && data.at && (Date.now() - data.at) < 5000) {
                typingUsers.push(data.name);
            }
        });
        
        if (typingUsers.length > 0) {
            indicator.textContent = typingUsers.length === 1 
                ? `${typingUsers[0]} √©crit...` 
                : `${typingUsers.join(', ')} √©crivent...`;
            indicator.classList.add('active');
        } else {
            indicator.classList.remove('active');
        }
    });
}

// Nettoyage des indicateurs de frappe
setInterval(function() {
    if (typeRef) {
        typeRef.once('value', function(snapshot) {
            snapshot.forEach(function(child) {
                const data = child.val();
                if (data.at && (Date.now() - data.at) > 5000) {
                    child.ref.remove();
                }
            });
        });
    }
}, 5000);

// Quand l'utilisateur quitte
window.addEventListener('beforeunload', function() {
    if (uid && usersRef) {
        usersRef.child(uid).remove();
    }
    if (user && msgsRef) {
        msgsRef.push({
            type: 'system',
            action: 'leave',
            user: user,
            timestamp: Date.now()
        });
    }
});

// Initialiser les emojis
renderEmojis('faces');

console.log('Tchat initialis√© ‚úÖ');
</script>
</body>
</html>
