<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
    <title>Messagerie üí¨ Tino Le Doc</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;700&family=Syne:wght@700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/common.css">
    <style>
        :root {
            --bg: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a25;
            --cyan: #00f5ff;
            --magenta: #ff00aa;
            --orange: #ff9500;
            --yellow: #f5ff00;
            --green: #00ff88;
            --red: #ff4444;
            --text: #e8e8e8;
            --text-secondary: #a0a0a0;
            --glass: rgba(255,255,255,0.05);
            --glass-border: rgba(255,255,255,0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Space Grotesk', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow: hidden;
        }

        /* Layout */
        .app-container {
            display: flex;
            height: 100vh;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sidebar-header h1 {
            font-family: 'Syne', sans-serif;
            font-size: 1.3rem;
            background: linear-gradient(135deg, var(--cyan), var(--magenta));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--glass);
            border-radius: 10px;
            color: var(--text);
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-btn:hover {
            background: var(--cyan);
            color: var(--bg);
        }

        .icon-btn.danger:hover {
            background: var(--red);
        }

        /* Tabs */
        .sidebar-tabs {
            display: flex;
            border-bottom: 1px solid var(--glass-border);
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-family: 'Syne', sans-serif;
            font-weight: 700;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .tab-btn:hover {
            color: var(--text);
            background: var(--glass);
        }

        .tab-btn.active {
            color: var(--cyan);
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 20%;
            width: 60%;
            height: 3px;
            background: var(--cyan);
            border-radius: 3px 3px 0 0;
        }

        .tab-btn .badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 18px;
            height: 18px;
            padding: 0 5px;
            background: var(--magenta);
            border-radius: 10px;
            font-size: 0.7rem;
            color: white;
            margin-left: 5px;
        }

        /* Search */
        .search-box {
            padding: 15px;
            border-bottom: 1px solid var(--glass-border);
        }

        .search-input {
            width: 100%;
            padding: 10px 15px;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: var(--text);
            font-family: inherit;
            font-size: 0.9rem;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--cyan);
        }

        .search-input::placeholder {
            color: var(--text-secondary);
        }

        /* Conversations List */
        .conversations-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .conversations-list::-webkit-scrollbar {
            width: 5px;
        }

        .conversations-list::-webkit-scrollbar-thumb {
            background: var(--glass-border);
            border-radius: 5px;
        }

        .conv-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 5px;
        }

        .conv-item:hover {
            background: var(--glass);
        }

        .conv-item.active {
            background: linear-gradient(135deg, rgba(0,245,255,0.15), rgba(255,0,170,0.15));
            border: 1px solid var(--cyan);
        }

        .conv-item.unread {
            background: rgba(255,0,170,0.1);
        }

        .conv-avatar {
            width: 48px;
            height: 48px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
            flex-shrink: 0;
            position: relative;
        }

        .conv-avatar.user {
            background: linear-gradient(135deg, var(--orange), var(--yellow));
            color: var(--bg);
        }

        .conv-avatar.group {
            background: linear-gradient(135deg, var(--cyan), var(--magenta));
            color: white;
        }

        .online-indicator {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            background: var(--green);
            border: 2px solid var(--bg-secondary);
            border-radius: 50%;
        }

        .conv-info {
            flex: 1;
            min-width: 0;
        }

        .conv-name {
            font-weight: 700;
            font-size: 0.95rem;
            margin-bottom: 3px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .conv-name .group-icon {
            font-size: 0.8rem;
        }

        .conv-preview {
            font-size: 0.8rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .conv-meta {
            text-align: right;
            flex-shrink: 0;
        }

        .conv-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .conv-unread {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
            height: 20px;
            padding: 0 6px;
            background: var(--magenta);
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 700;
            color: white;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-state .icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .empty-state h3 {
            font-family: 'Syne', sans-serif;
            color: var(--text);
            margin-bottom: 10px;
        }

        /* Main Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg);
            height: 100vh;
            min-height: 0;
            overflow: hidden;
            position: relative;
        }

        .chat-header {
            padding: 15px 20px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            gap: 15px;
            flex-shrink: 0; /* Ne pas r√©duire */
        }

        .chat-header-info {
            flex: 1;
        }

        .chat-header-name {
            font-family: 'Syne', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
        }

        .chat-header-status {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .chat-header-status.online {
            color: var(--green);
        }

        .chat-header-actions {
            display: flex;
            gap: 8px;
        }

        /* Messages */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-height: 0; /* Important pour le scroll dans flexbox */
        }

        .messages-container::-webkit-scrollbar {
            width: 6px;
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: var(--cyan);
            border-radius: 3px;
        }

        .message {
            display: flex;
            gap: 10px;
            max-width: 70%;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.own {
            flex-direction: row-reverse;
            margin-left: auto;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
            flex-shrink: 0;
            background: linear-gradient(135deg, var(--orange), var(--yellow));
            color: var(--bg);
        }

        .message.own .message-avatar {
            background: linear-gradient(135deg, var(--magenta), var(--cyan));
            color: white;
        }

        .message-content {
            background: var(--bg-tertiary);
            border-radius: 16px 16px 16px 4px;
            padding: 12px 16px;
        }

        .message.own .message-content {
            background: linear-gradient(135deg, rgba(255,0,170,0.2), rgba(0,245,255,0.2));
            border-radius: 16px 16px 4px 16px;
        }

        .message-sender {
            font-weight: 700;
            font-size: 0.85rem;
            color: var(--orange);
            margin-bottom: 4px;
        }

        .message.own .message-sender {
            color: var(--cyan);
        }

        .message-text {
            line-height: 1.5;
            word-wrap: break-word;
        }

        .message-text img {
            max-width: 200px;
            max-height: 150px;
            border-radius: 10px;
            margin-top: 8px;
        }

        .message-time {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 5px;
            text-align: right;
        }

        .message-system {
            text-align: center;
            padding: 10px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-style: italic;
        }

        .message-system.join { color: var(--green); }
        .message-system.leave { color: var(--red); }

        /* Input Area */
        .input-area {
            padding: 15px 20px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--glass-border);
            flex-shrink: 0;
            z-index: 10;
        }

        .input-toolbar {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .input-form {
            display: flex;
            gap: 10px;
        }

        .input-form input {
            flex: 1;
            padding: 12px 18px;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 25px;
            color: var(--text);
            font-family: inherit;
            font-size: 1rem;
        }

        .input-form input:focus {
            outline: none;
            border-color: var(--cyan);
        }

        .input-form button {
            padding: 12px 20px;
            background: linear-gradient(135deg, var(--magenta), var(--cyan));
            border: none;
            border-radius: 25px;
            color: white;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .input-form button:hover {
            transform: scale(1.05);
        }

        /* No Chat Selected */
        .no-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 40px;
        }

        /* Active Chat - IMPORTANT: doit prendre toute la hauteur */
        #activeChat {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 0;
        }

        .no-chat .icon {
            font-size: 5rem;
            margin-bottom: 20px;
        }

        .no-chat h2 {
            font-family: 'Syne', sans-serif;
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .no-chat p {
            color: var(--text-secondary);
            max-width: 300px;
        }

        /* Modals */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            width: 100%;
            max-width: 450px;
            max-height: 80vh;
            overflow: hidden;
            animation: modalIn 0.3s ease;
        }

        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h2 {
            font-family: 'Syne', sans-serif;
            font-size: 1.2rem;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--glass);
            border-radius: 8px;
            color: var(--text);
            font-size: 1.2rem;
            cursor: pointer;
        }

        .modal-close:hover {
            background: var(--red);
        }

        .modal-body {
            padding: 20px;
            max-height: 50vh;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--glass-border);
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: var(--text);
            font-family: inherit;
            font-size: 1rem;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--cyan);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 12px;
            font-family: 'Syne', sans-serif;
            font-weight: 700;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--magenta), var(--cyan));
            color: white;
        }

        .btn-secondary {
            background: var(--glass);
            color: var(--text);
            border: 1px solid var(--glass-border);
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        /* User/Contact item */
        .user-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--glass);
            border-radius: 12px;
            margin-bottom: 10px;
        }

        .user-item-avatar {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--orange), var(--yellow));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--bg);
        }

        .user-item-info {
            flex: 1;
        }

        .user-item-name {
            font-weight: 700;
        }

        .user-item-status {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .user-item-actions {
            display: flex;
            gap: 5px;
        }

        .user-item-actions button {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .user-item-actions .accept {
            background: var(--green);
            color: var(--bg);
        }

        .user-item-actions .reject {
            background: var(--red);
            color: white;
        }

        .user-item-actions .add {
            background: var(--cyan);
            color: var(--bg);
        }

        .user-item-actions .message {
            background: var(--magenta);
            color: white;
        }

        /* Members list */
        .members-section {
            margin-top: 20px;
        }

        .members-section h4 {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .member-chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--glass);
            border-radius: 20px;
            margin: 3px;
            font-size: 0.85rem;
        }

        .member-chip .remove {
            width: 18px;
            height: 18px;
            border: none;
            background: var(--red);
            border-radius: 50%;
            color: white;
            font-size: 0.7rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Login required */
        .login-required {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            text-align: center;
            padding: 40px;
        }

        .login-required .icon {
            font-size: 5rem;
            margin-bottom: 20px;
        }

        .login-required h1 {
            font-family: 'Syne', sans-serif;
            font-size: 2rem;
            margin-bottom: 15px;
            background: linear-gradient(135deg, var(--cyan), var(--magenta));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .login-required p {
            color: var(--text-secondary);
            margin-bottom: 30px;
            max-width: 400px;
        }

        .login-required .btn {
            padding: 15px 40px;
            font-size: 1.1rem;
        }

        /* ===== RESPONSIVE MOBILE (Android / iOS) ===== */
        @media (max-width: 768px) {
            body { height: 100dvh; overflow: hidden; }

            .app-container {
                flex-direction: column;
                height: 100dvh;
            }

            /* Sidebar en overlay plein ecran */
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                width: 100%;
                z-index: 100;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            /* Overlay sombre derriere la sidebar */
            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.6);
                z-index: 99;
            }

            .sidebar-overlay.active {
                display: block;
            }

            /* Header mobile */
            .mobile-header {
                display: flex;
                align-items: center;
                padding: 10px 15px;
                background: var(--bg-secondary);
                border-bottom: 1px solid var(--glass-border);
                flex-shrink: 0;
                gap: 12px;
                min-height: 50px;
            }

            .mobile-header .icon-btn {
                width: 44px;
                height: 44px;
                font-size: 1.3rem;
            }

            .mobile-header span {
                font-family: 'Syne', sans-serif;
                font-size: 1rem;
                font-weight: 700;
            }

            /* Zone de chat - prend l'espace restant apres mobile-header */
            .chat-area {
                width: 100%;
                flex: 1;
                min-height: 0;
                height: auto;
                display: flex;
                flex-direction: column;
                overflow: hidden;
                position: relative;
            }

            #activeChat {
                flex: 1;
                display: flex;
                flex-direction: column;
                min-height: 0;
                overflow: hidden;
                height: 100%;
            }

            .messages-container {
                flex: 1;
                min-height: 0;
                overflow-y: auto;
            }

            /* Chat header mobile */
            .chat-header {
                padding: 10px 12px;
                gap: 10px;
            }

            .chat-header .conv-avatar {
                width: 36px;
                height: 36px;
                font-size: 0.9rem;
                border-radius: 10px;
            }

            .chat-header-name { font-size: 0.95rem; }
            .chat-header-status { font-size: 0.75rem; }

            #mobileBackBtn {
                display: flex !important;
                width: 44px;
                height: 44px;
                font-size: 1.2rem;
            }

            /* Messages */
            .messages-container {
                flex: 1;
                min-height: 0;
                padding: 12px;
                gap: 10px;
                -webkit-overflow-scrolling: touch;
            }

            .message { max-width: 85%; }

            .message-avatar {
                width: 32px;
                height: 32px;
                font-size: 0.8rem;
                border-radius: 8px;
            }

            .message-content {
                padding: 10px 12px;
                border-radius: 14px 14px 14px 4px;
            }

            .message.own .message-content {
                border-radius: 14px 14px 4px 14px;
            }

            .message-sender { font-size: 0.8rem; }
            .message-text { font-size: 0.92rem; }
            .message-text img { max-width: 180px; max-height: 120px; }
            .message-time { font-size: 0.65rem; }

            /* Zone de saisie - fixee en bas */
            .input-area {
                padding: 10px 12px;
                padding-bottom: calc(10px + env(safe-area-inset-bottom, 0px));
                flex-shrink: 0;
                position: relative;
                background: var(--bg-secondary);
                border-top: 1px solid var(--glass-border);
                z-index: 10;
            }

            .input-toolbar { margin-bottom: 8px; }

            .input-toolbar .icon-btn {
                width: 44px;
                height: 44px;
            }

            .input-form { gap: 8px; }

            .input-form input {
                padding: 12px 16px;
                font-size: 16px;
                border-radius: 22px;
            }

            .input-form button {
                padding: 12px 16px;
                font-size: 1.1rem;
                border-radius: 22px;
                min-width: 48px;
                min-height: 48px;
            }

            /* Boutons tactiles globaux min 44px */
            .icon-btn {
                width: 44px;
                height: 44px;
                font-size: 1.2rem;
            }

            .tab-btn {
                padding: 12px 8px;
                font-size: 0.8rem;
                min-height: 44px;
            }

            /* Sidebar contenu mobile */
            .sidebar-header { padding: 15px; }
            .sidebar-header h1 { font-size: 1.1rem; }

            .search-input {
                padding: 12px 15px;
                font-size: 16px;
            }

            .conv-item {
                padding: 12px;
                gap: 10px;
                min-height: 60px;
            }

            .conv-avatar {
                width: 44px;
                height: 44px;
                font-size: 1.1rem;
            }

            .conv-name { font-size: 0.9rem; }
            .conv-preview { font-size: 0.8rem; }

            /* No chat selected */
            .no-chat { padding: 30px 20px; }
            .no-chat .icon { font-size: 3rem; }
            .no-chat h2 { font-size: 1.2rem; }
            .no-chat p { font-size: 0.9rem; }

            /* Login required */
            .login-required { padding: 30px 20px; }
            .login-required .icon { font-size: 3.5rem; }
            .login-required h1 { font-size: 1.5rem; }
            .login-required p { font-size: 0.9rem; }
            .login-required .btn { padding: 14px 30px; font-size: 1rem; min-height: 48px; }

            /* Modals sur mobile */
            .modal-overlay { padding: 10px; }
            .modal { border-radius: 15px; max-height: 90vh; }
            .modal-header { padding: 15px; }
            .modal-header h2 { font-size: 1rem; }
            .modal-body { padding: 15px; }
            .modal-footer { padding: 12px 15px; }

            .form-group input,
            .form-group textarea {
                font-size: 16px;
                padding: 12px 15px;
            }

            .btn { min-height: 44px; padding: 12px 20px; }

            .user-item { padding: 10px; gap: 10px; }
            .user-item-actions button { min-height: 36px; min-width: 44px; padding: 8px 14px; }
        }

        /* Petits ecrans Android */
        @media (max-width: 380px) {
            .sidebar-header h1 { font-size: 1rem; }
            .chat-header-name { font-size: 0.85rem; }
            .conv-avatar { width: 38px; height: 38px; font-size: 1rem; }
            .message { max-width: 90%; }
            .message-avatar { width: 28px; height: 28px; font-size: 0.7rem; }
        }

        /* Paysage mobile */
        @media (max-height: 500px) and (orientation: landscape) {
            .mobile-header { padding: 5px 10px; min-height: 40px; }
            .chat-header { padding: 8px 12px; }
            .messages-container { padding: 8px; gap: 6px; }
            .input-area { padding: 6px 10px; }
        }

        @media (min-width: 769px) {
            .mobile-header {
                display: none;
            }

            .sidebar-overlay {
                display: none !important;
            }
        }
        /* Video Call */
        .vc-rec{display:inline-block;width:12px;height:12px;background:var(--red);border-radius:50%;animation:vcPulse 1s infinite}
        @keyframes vcPulse{0%,100%{opacity:1}50%{opacity:0.3}}
        #vcVideoGrid{display:flex;flex-wrap:wrap;gap:10px;justify-content:center}
        .vc-cell{position:relative;background:#222;border-radius:12px;overflow:hidden;flex:1 1 45%;max-width:48%;aspect-ratio:16/9}
        .vc-cell.local{border:2px solid var(--cyan)}
        .vc-cell video{width:100%;height:100%;object-fit:cover;display:block}
        .vc-cell .vc-nametag{position:absolute;bottom:8px;left:8px;padding:4px 10px;background:rgba(0,0,0,0.7);border-radius:8px;font-size:0.75rem;color:#fff;z-index:2}
        #vcControls .icon-btn{width:50px;height:50px;font-size:1.3rem;border-radius:50%}
        #vcControls .icon-btn.off{background:var(--red);color:white}
        @media(max-width:768px){
            .vc-cell{flex:1 1 100%;max-width:100%}
        }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-link">Aller au contenu</a>
    <!-- Login Required Screen -->
    <div class="login-required" id="loginRequired">
        <div class="icon">üîê</div>
        <h1>Connexion requise</h1>
        <p>Connectez-vous ou cr√©ez un compte pour acc√©der √† la messagerie priv√©e, ajouter des contacts et cr√©er des groupes.</p>
        <a href="compte.html" class="btn btn-primary">üë§ Se connecter / S'inscrire</a>
        <br><br>
        <a href="tchat.html" style="color: var(--cyan);">üí¨ Ou acc√©der au tchat public</a>
    </div>

    <!-- Main App -->
    <div class="app-container" id="main-content" style="display: none;">
        <!-- Overlay sidebar mobile -->
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

        <!-- Mobile Header -->
        <div class="mobile-header">
            <button class="icon-btn" onclick="toggleSidebar()">‚ò∞</button>
            <span>Messagerie</span>
        </div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h1>üí¨ Messagerie</h1>
                <div class="header-actions">
                    <button class="icon-btn" onclick="openModal('newGroup')" title="Nouveau groupe">üë•</button>
                    <button class="icon-btn" onclick="openModal('addContact')" title="Ajouter contact">‚ûï</button>
                    <a href="index.html" class="icon-btn" title="Retour">üè†</a>
                </div>
            </div>

            <div class="sidebar-tabs">
                <button class="tab-btn active" data-tab="conversations">üí¨ Conversations</button>
                <button class="tab-btn" data-tab="contacts">üë• Contacts <span class="badge" id="requestsBadge" style="display:none;">0</span></button>
            </div>

            <div class="search-box">
                <input type="text" class="search-input" id="searchInput" placeholder="üîç Rechercher...">
            </div>

            <!-- Conversations Tab -->
            <div class="conversations-list" id="conversationsTab">
                <div id="conversationsList">
                    <!-- Filled by JS -->
                </div>

                <div class="empty-state" id="emptyConversations" style="display: none;">
                    <div class="icon">üí¨</div>
                    <h3>Aucune conversation</h3>
                    <p>Ajoutez des contacts ou cr√©ez un groupe pour commencer</p>
                </div>
            </div>

            <!-- Contacts Tab -->
            <div class="conversations-list" id="contactsTab" style="display: none;">
                <!-- Friend Requests -->
                <div id="friendRequests"></div>

                <!-- Contacts List -->
                <div id="contactsList">
                    <div class="empty-state">
                        <div class="icon">üë•</div>
                        <h3>Aucun contact</h3>
                        <p>Recherchez des utilisateurs pour les ajouter</p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Chat Area -->
        <main class="chat-area" id="chatArea">
            <!-- No chat selected -->
            <div class="no-chat" id="noChat">
                <div class="icon">üí¨</div>
                <h2>Bienvenue !</h2>
                <p>S√©lectionnez une conversation ou cr√©ez-en une nouvelle pour commencer √† discuter.</p>
            </div>

            <!-- Active Chat -->
            <div id="activeChat" style="display: none;">
                <div class="chat-header">
                    <button class="icon-btn" onclick="toggleSidebar()" style="display: none;" id="mobileBackBtn">‚Üê</button>
                    <div class="conv-avatar" id="chatAvatar">?</div>
                    <div class="chat-header-info">
                        <div class="chat-header-name" id="chatName">Chat</div>
                        <div class="chat-header-status" id="chatStatus">-</div>
                    </div>
                    <div class="chat-header-actions">
                        <button class="icon-btn" id="videoCallBtn" onclick="startVideoCall()" style="display:none;" title="Appel vid√©o">üìπ</button>
                        <button class="icon-btn" id="chatInfoBtn" onclick="openChatInfo()">‚ÑπÔ∏è</button>
                    </div>
                </div>

                <div class="messages-container" id="messagesContainer">
                    <!-- Messages filled by JS -->
                </div>

                <div class="input-area">
                    <form class="input-form" id="messageForm">
                        <input type="text" id="messageInput" placeholder="√âcrire un message..." maxlength="500" autocomplete="off">
                        <button type="submit">üì§</button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal: Add Contact -->
    <div class="modal-overlay" id="modalAddContact">
        <div class="modal">
            <div class="modal-header">
                <h2>‚ûï Ajouter un contact</h2>
                <button class="modal-close" onclick="closeModal('addContact')">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Rechercher par pseudo</label>
                    <input type="text" id="searchUserInput" placeholder="Entrez un pseudo..." maxlength="20">
                </div>
                <div id="searchResults"></div>
            </div>
        </div>
    </div>

    <!-- Modal: New Group -->
    <div class="modal-overlay" id="modalNewGroup">
        <div class="modal">
            <div class="modal-header">
                <h2>üë• Cr√©er un groupe</h2>
                <button class="modal-close" onclick="closeModal('newGroup')">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Nom du groupe</label>
                    <input type="text" id="groupName" placeholder="Ex: Mes amis..." maxlength="30">
                </div>
                <div class="form-group">
                    <label>Description (optionnel)</label>
                    <textarea id="groupDescription" placeholder="De quoi parle ce groupe ?" maxlength="100"></textarea>
                </div>
                <div class="members-section">
                    <h4>Membres s√©lectionn√©s</h4>
                    <div id="selectedMembers">
                        <p style="color: var(--text-secondary); font-size: 0.85rem;">S√©lectionnez des contacts ci-dessous</p>
                    </div>
                </div>
                <div class="form-group">
                    <label>Ajouter des contacts</label>
                    <div id="contactsForGroup"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('newGroup')">Annuler</button>
                <button class="btn btn-primary" onclick="createGroup()">Cr√©er le groupe</button>
            </div>
        </div>
    </div>

    <!-- Modal: Chat Info -->
    <div class="modal-overlay" id="modalChatInfo">
        <div class="modal">
            <div class="modal-header">
                <h2>‚ÑπÔ∏è Informations</h2>
                <button class="modal-close" onclick="closeModal('chatInfo')">‚úï</button>
            </div>
            <div class="modal-body" id="chatInfoContent">
                <!-- Filled by JS -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="leaveGroupBtn" onclick="leaveGroup()" style="display: none;">üö™ Quitter le groupe</button>
            </div>
        </div>
    </div>

    <!-- Modal: Video Call -->
    <div class="modal-overlay" id="modalVideoCall" style="background:rgba(0,0,0,0.95);">
        <div class="modal" style="max-width:900px;max-height:95vh;background:#0a0a0f;">
            <div class="modal-header" style="background:linear-gradient(135deg,rgba(255,68,68,0.2),rgba(255,149,0,0.2));">
                <h2><span class="vc-rec"></span> Appel vid√©o - <span id="vcCallName">...</span></h2>
                <div style="display:flex;align-items:center;gap:10px;">
                    <span id="vcParticipantCount" style="font-size:0.8rem;color:rgba(255,255,255,0.6);">0 en appel</span>
                    <button class="modal-close" onclick="DMVideoChat.leaveCall()">‚úï</button>
                </div>
            </div>
            <div class="modal-body" style="padding:0;max-height:none;overflow:hidden;">
                <!-- Ecran de jointure -->
                <div id="vcJoinScreen" style="padding:40px 20px;text-align:center;">
                    <div style="font-size:4rem;margin-bottom:20px;">üìπ</div>
                    <h3 style="font-family:'Syne',sans-serif;font-size:1.3rem;margin-bottom:10px;">Appel vid√©o priv√©</h3>
                    <p style="color:rgba(255,255,255,0.6);margin-bottom:20px;">D√©marrez un appel vid√©o en direct avec votre contact</p>
                    <button id="vcJoinBtn" onclick="DMVideoChat.joinCall()" style="padding:15px 35px;border:none;border-radius:15px;font-family:'Syne',sans-serif;font-size:1.1rem;font-weight:700;cursor:pointer;background:linear-gradient(135deg,#00ff88,#00cc6a);color:#0a0a0f;transition:all 0.3s;">üìπ Rejoindre l'appel</button>
                </div>
                <!-- Grille vid√©o -->
                <div id="vcVideoGrid" style="display:none;padding:10px;background:#000;"></div>
                <!-- Controles -->
                <div id="vcControls" style="display:none;padding:15px;background:rgba(0,0,0,0.8);justify-content:center;gap:12px;align-items:center;">
                    <button class="icon-btn" id="vcMicBtn" onclick="DMVideoChat.toggleMic()" title="Micro">üé§</button>
                    <button class="icon-btn" id="vcCamBtn" onclick="DMVideoChat.toggleCam()" title="Cam√©ra">üìπ</button>
                    <button class="icon-btn danger" id="vcLeaveBtn" onclick="DMVideoChat.leaveCall()" title="Raccrocher" style="background:var(--red);color:white;">üìû</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="js/firebase-config.js"></script>
    <script>
        // Config Firebase chargee depuis js/firebase-config.js
        const auth = firebaseAuth;
        const db = firebaseDb;

        // ==================== STATE ====================
        let currentUser = null;
        let currentUserProfile = null;
        let currentChat = null;
        let currentChatType = null;
        let contacts = {};
        let conversations = {};
        let selectedGroupMembers = [];
        let messageListeners = {};

        // ==================== AUTH STATE ====================
        auth.onAuthStateChanged(async user => {
            if (user) {
                currentUser = user;
                try {
                    const snapshot = await db.ref('users/' + user.uid).once('value');
                    currentUserProfile = snapshot.val();
                    
                    if (currentUserProfile) {
                        document.getElementById('loginRequired').style.display = 'none';
                        document.getElementById('main-content').style.display = 'flex';
                        initApp();
                    } else {
                        window.location.href = 'compte.html';
                    }
                } catch (e) {
                    console.error('Erreur profil:', e);
                }
            } else {
                document.getElementById('loginRequired').style.display = 'flex';
                document.getElementById('main-content').style.display = 'none';
            }
        });

        // ==================== INIT APP ====================
        function initApp() {
            loadContacts();
            loadFriendRequests();
            loadConversations();
            setupTabs();
            setupSearch();

            // Message form
            document.getElementById('messageForm').addEventListener('submit', e => {
                e.preventDefault();
                sendMessage();
            });

            // Fix clavier Android : garder l'input visible
            const msgInputEl = document.getElementById('messageInput');
            if (msgInputEl) {
                msgInputEl.addEventListener('focus', () => {
                    setTimeout(() => {
                        msgInputEl.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                    }, 300);
                });
            }

            // Gestion du resize par le clavier virtuel
            if (window.visualViewport) {
                window.visualViewport.addEventListener('resize', () => {
                    document.documentElement.style.height = window.visualViewport.height + 'px';
                });
                window.visualViewport.addEventListener('scroll', () => {
                    document.documentElement.style.height = window.visualViewport.height + 'px';
                });
            }

            // Search user
            document.getElementById('searchUserInput').addEventListener('input', debounce(searchUsers, 500));

            console.log('‚úÖ Messagerie initialis√©e pour:', currentUserProfile.pseudo);
        }

        // ==================== TABS ====================
        function setupTabs() {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    const tab = this.dataset.tab;
                    document.getElementById('conversationsTab').style.display = tab === 'conversations' ? 'block' : 'none';
                    document.getElementById('contactsTab').style.display = tab === 'contacts' ? 'block' : 'none';
                });
            });
        }

        // ==================== SEARCH ====================
        function setupSearch() {
            document.getElementById('searchInput').addEventListener('input', function() {
                const query = this.value.toLowerCase();
                document.querySelectorAll('.conv-item').forEach(item => {
                    const name = item.querySelector('.conv-name')?.textContent.toLowerCase() || '';
                    item.style.display = name.includes(query) ? 'flex' : 'none';
                });
            });
        }

        // ==================== CONTACTS ====================
        function loadContacts() {
            db.ref('contacts/' + currentUser.uid).on('value', async snapshot => {
                contacts = {};
                const contactsDiv = document.getElementById('contactsList');
                const groupContactsDiv = document.getElementById('contactsForGroup');

                if (!snapshot.exists()) {
                    contactsDiv.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">üë•</div>
                            <h3>Aucun contact</h3>
                            <p>Recherchez des utilisateurs pour les ajouter</p>
                        </div>
                    `;
                    groupContactsDiv.innerHTML = '<p style="color: var(--text-secondary);">Aucun contact</p>';
                    return;
                }

                let contactsHTML = '';
                let groupHTML = '';

                for (const [oderId, data] of Object.entries(snapshot.val())) {
                    // Le pseudo est stock√© dans le contact (pas besoin de lire users/)
                    const pseudo = data.pseudo || 'Utilisateur';
                    contacts[oderId] = { pseudo, oderId };

                    contactsHTML += `
                        <div class="user-item">
                            <div class="user-item-avatar">${pseudo.charAt(0).toUpperCase()}</div>
                            <div class="user-item-info">
                                <div class="user-item-name">${escapeHtml(pseudo)}</div>
                                <div class="user-item-status">Contact</div>
                            </div>
                            <div class="user-item-actions">
                                <button class="message" onclick="startDM('${oderId}')">üí¨</button>
                            </div>
                        </div>
                    `;

                    groupHTML += `
                        <div class="user-item" onclick="toggleGroupMember('${oderId}', '${escapeHtml(pseudo)}')" style="cursor:pointer;">
                            <div class="user-item-avatar">${pseudo.charAt(0).toUpperCase()}</div>
                            <div class="user-item-info">
                                <div class="user-item-name">${escapeHtml(pseudo)}</div>
                            </div>
                            <input type="checkbox" id="check_${oderId}">
                        </div>
                    `;
                }

                contactsDiv.innerHTML = contactsHTML || '<p style="color: var(--text-secondary); padding: 20px;">Aucun contact</p>';
                groupContactsDiv.innerHTML = groupHTML || '<p style="color: var(--text-secondary);">Aucun contact</p>';
            });
        }

        // ==================== FRIEND REQUESTS ====================
        function loadFriendRequests() {
            db.ref('friendRequests/' + currentUser.uid).on('value', async snapshot => {
                const requestsDiv = document.getElementById('friendRequests');
                const badge = document.getElementById('requestsBadge');

                if (!snapshot.exists()) {
                    requestsDiv.innerHTML = '';
                    badge.style.display = 'none';
                    return;
                }

                const requests = snapshot.val();
                let manualCount = 0;

                let html = '';

                for (const [oderId, data] of Object.entries(requests)) {
                    // Auto-accept : l'autre a d√©j√† accept√©, on s'ajoute mutuellement
                    if (data.autoAccept) {
                        await db.ref('contacts/' + currentUser.uid + '/' + oderId).set({
                            pseudo: data.pseudo || 'Utilisateur',
                            addedAt: Date.now()
                        });
                        await db.ref('friendRequests/' + currentUser.uid + '/' + oderId).remove();
                        continue;
                    }

                    manualCount++;
                    const pseudo = data.pseudo || 'Utilisateur';
                    html += `
                        <div class="user-item">
                            <div class="user-item-avatar">${pseudo.charAt(0).toUpperCase()}</div>
                            <div class="user-item-info">
                                <div class="user-item-name">${escapeHtml(pseudo)}</div>
                                <div class="user-item-status">Veut vous ajouter</div>
                            </div>
                            <div class="user-item-actions">
                                <button class="accept" onclick="acceptFriendRequest('${oderId}', '${escapeHtml(pseudo)}')">‚úì</button>
                                <button class="reject" onclick="rejectFriendRequest('${oderId}')">‚úï</button>
                            </div>
                        </div>
                    `;
                }

                badge.textContent = manualCount;
                badge.style.display = manualCount > 0 ? 'inline-flex' : 'none';

                if (html) {
                    html = '<h4 style="padding: 10px; color: var(--magenta);">üì® Demandes d\'amis</h4>' + html;
                }
                requestsDiv.innerHTML = html;
            });
        }

        async function sendFriendRequest(oderId) {
            if (oderId === currentUser.uid) {
                alert('Vous ne pouvez pas vous ajouter vous-m√™me !');
                return;
            }

            try {
                // V√©rifie si d√©j√† en contact (lecture autoris√©e : c'est notre propre noeud)
                const contactSnap = await db.ref('contacts/' + currentUser.uid + '/' + oderId).once('value');
                if (contactSnap.exists()) {
                    alert('D√©j√† dans vos contacts !');
                    return;
                }

                // Envoie la demande avec le pseudo (√©vite de lire users/ c√¥t√© destinataire)
                await db.ref('friendRequests/' + oderId + '/' + currentUser.uid).set({
                    from: currentUser.uid,
                    pseudo: currentUserProfile.pseudo,
                    timestamp: Date.now()
                });

                alert('Demande envoy√©e ! ‚úÖ');
            } catch (err) {
                console.error('Erreur envoi demande:', err);
                alert('Erreur lors de l\'envoi de la demande.');
            }
        }

        async function acceptFriendRequest(oderId, pseudo) {
            try {
                // Ajouter √† MES contacts (autoris√© : auth.uid == $oderId)
                await db.ref('contacts/' + currentUser.uid + '/' + oderId).set({
                    pseudo: pseudo || 'Utilisateur',
                    addedAt: Date.now()
                });

                // Envoyer une demande inverse pour que l'autre nous ajoute automatiquement
                // (on ne peut pas √©crire dans contacts/{autreUid}, mais on peut √©crire dans friendRequests/{autreUid})
                await db.ref('friendRequests/' + oderId + '/' + currentUser.uid).set({
                    from: currentUser.uid,
                    pseudo: currentUserProfile.pseudo,
                    timestamp: Date.now(),
                    autoAccept: true
                });

                // Supprimer la demande re√ßue
                await db.ref('friendRequests/' + currentUser.uid + '/' + oderId).remove();
            } catch (err) {
                console.error('Erreur acceptation:', err);
            }
        }

        async function rejectFriendRequest(oderId) {
            await db.ref('friendRequests/' + currentUser.uid + '/' + oderId).remove();
        }

        // ==================== SEARCH USERS ====================
        async function searchUsers() {
            const query = document.getElementById('searchUserInput').value.trim().toLowerCase();
            const resultsDiv = document.getElementById('searchResults');

            if (query.length < 2) {
                resultsDiv.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">Entrez au moins 2 caract√®res</p>';
                return;
            }

            resultsDiv.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">Recherche...</p>';

            try {
                // Requ√™te par pr√©fixe sur le noeud "pseudos" (lecture publique)
                // Les pseudos sont stock√©s en minuscules comme cl√©s
                const snapshot = await db.ref('pseudos')
                    .orderByKey()
                    .startAt(query)
                    .endAt(query + '\uf8ff')
                    .limitToFirst(11)
                    .once('value');

                if (!snapshot.exists()) {
                    resultsDiv.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">Aucun utilisateur trouv√©</p>';
                    return;
                }

                let html = '';
                let count = 0;
                snapshot.forEach(child => {
                    if (count >= 10) return;
                    const pseudo = child.key;    // cl√© = pseudo en minuscules
                    const uid = child.val();     // valeur = uid de l'utilisateur

                    if (uid !== currentUser.uid) {
                        const displayPseudo = pseudo.charAt(0).toUpperCase() + pseudo.slice(1);
                        html += `
                            <div class="user-item">
                                <div class="user-item-avatar">${displayPseudo.charAt(0).toUpperCase()}</div>
                                <div class="user-item-info">
                                    <div class="user-item-name">${escapeHtml(displayPseudo)}</div>
                                </div>
                                <div class="user-item-actions">
                                    <button class="add" onclick="sendFriendRequest('${uid}')">‚ûï Ajouter</button>
                                </div>
                            </div>
                        `;
                        count++;
                    }
                });

                resultsDiv.innerHTML = html || '<p style="color: var(--text-secondary); text-align: center;">Aucun r√©sultat</p>';
            } catch (err) {
                console.error('Erreur recherche:', err);
                resultsDiv.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">Erreur lors de la recherche</p>';
            }
        }

        // ==================== CONVERSATIONS ====================
        function loadConversations() {
            // Load DMs
            db.ref('userConversations/' + currentUser.uid).on('value', async snapshot => {
                const listDiv = document.getElementById('conversationsList');

                if (!snapshot.exists()) {
                    updateConversationsUI();
                    return;
                }

                conversations = {};
                let html = '';

                for (const [convId, data] of Object.entries(snapshot.val())) {
                    conversations[convId] = data;

                    if (data.type === 'dm') {
                        const otherUserId = data.participants ? data.participants.find(p => p !== currentUser.uid) : null;
                        const otherPseudo = data.otherPseudo || (otherUserId && contacts[otherUserId] && contacts[otherUserId].pseudo) || 'Utilisateur';
                        html += createConvItem(convId, 'dm', otherPseudo, data.lastMessage, data.lastTime, data.unread);
                    } else if (data.type === 'group') {
                        html += createConvItem(convId, 'group', data.name, data.lastMessage, data.lastTime, data.unread);
                    }
                }

                listDiv.innerHTML = html;
                updateConversationsUI();
            });
        }

        function createConvItem(id, type, name, lastMsg, lastTime, unread) {
            const avatarClass = type === 'dm' ? 'user' : 'group';
            const icon = type === 'group' ? '<span class="group-icon">üë•</span>' : '';
            const initial = name.charAt(0).toUpperCase();
            const time = lastTime ? formatTime(lastTime) : '';
            const preview = lastMsg ? escapeHtml(lastMsg.substring(0, 30)) + (lastMsg.length > 30 ? '...' : '') : 'Aucun message';
            const unreadBadge = unread > 0 ? `<div class="conv-unread">${unread}</div>` : '';
            const unreadClass = unread > 0 ? 'unread' : '';

            return `
                <div class="conv-item ${unreadClass}" data-type="${type}" data-id="${id}" onclick="openChat('${type}', '${id}')">
                    <div class="conv-avatar ${avatarClass}">${initial}</div>
                    <div class="conv-info">
                        <div class="conv-name">${icon}${escapeHtml(name)}</div>
                        <div class="conv-preview">${preview}</div>
                    </div>
                    <div class="conv-meta">
                        <div class="conv-time">${time}</div>
                        ${unreadBadge}
                    </div>
                </div>
            `;
        }

        function updateConversationsUI() {
            const list = document.getElementById('conversationsList');
            const empty = document.getElementById('emptyConversations');
            empty.style.display = list.children.length === 0 ? 'block' : 'none';
        }

        // ==================== GROUPS ====================
        function toggleGroupMember(oderId, pseudo) {
            const checkbox = document.getElementById('check_' + oderId);
            const idx = selectedGroupMembers.findIndex(m => m.oderId === oderId);

            if (idx > -1) {
                selectedGroupMembers.splice(idx, 1);
                checkbox.checked = false;
            } else {
                selectedGroupMembers.push({ oderId, pseudo });
                checkbox.checked = true;
            }

            updateSelectedMembers();
        }

        function updateSelectedMembers() {
            const div = document.getElementById('selectedMembers');

            if (selectedGroupMembers.length === 0) {
                div.innerHTML = '<p style="color: var(--text-secondary); font-size: 0.85rem;">S√©lectionnez des contacts ci-dessous</p>';
                return;
            }

            div.innerHTML = selectedGroupMembers.map(m => `
                <span class="member-chip">
                    ${escapeHtml(m.pseudo)}
                    <button class="remove" onclick="removeGroupMember('${m.oderId}')">‚úï</button>
                </span>
            `).join('');
        }

        function removeGroupMember(oderId) {
            const idx = selectedGroupMembers.findIndex(m => m.oderId === oderId);
            if (idx > -1) {
                selectedGroupMembers.splice(idx, 1);
                const checkbox = document.getElementById('check_' + oderId);
                if (checkbox) checkbox.checked = false;
                updateSelectedMembers();
            }
        }

        async function createGroup() {
            const name = document.getElementById('groupName').value.trim();
            const description = document.getElementById('groupDescription').value.trim();

            if (!name || name.length < 2) {
                alert('Le nom du groupe doit faire au moins 2 caract√®res');
                return;
            }

            if (selectedGroupMembers.length === 0) {
                alert('Ajoutez au moins un membre au groupe');
                return;
            }

            // Create group
            const groupRef = db.ref('groups').push();
            const groupId = groupRef.key;

            const members = {
                [currentUser.uid]: { role: 'admin', joinedAt: Date.now() }
            };

            selectedGroupMembers.forEach(m => {
                members[m.oderId] = { role: 'member', joinedAt: Date.now() };
            });

            await groupRef.set({
                name,
                description,
                createdBy: currentUser.uid,
                createdAt: Date.now(),
                members
            });

            // Add to all members' conversations
            const allMembers = [currentUser.uid, ...selectedGroupMembers.map(m => m.oderId)];

            for (const oderId of allMembers) {
                await db.ref('userConversations/' + oderId + '/' + groupId).set({
                    type: 'group',
                    name,
                    lastMessage: 'Groupe cr√©√©',
                    lastTime: Date.now(),
                    unread: oderId === currentUser.uid ? 0 : 1
                });
            }

            // System message
            await db.ref('groupMessages/' + groupId).push({
                type: 'system',
                text: `${currentUserProfile.pseudo} a cr√©√© le groupe`,
                timestamp: Date.now()
            });

            // Reset and close
            selectedGroupMembers = [];
            document.getElementById('groupName').value = '';
            document.getElementById('groupDescription').value = '';
            closeModal('newGroup');

            alert('Groupe cr√©√© ! ‚úÖ');
        }

        // ==================== DM ====================
        async function startDM(otherUserId) {
            try {
                const convId = [currentUser.uid, otherUserId].sort().join('_');
                const existingConv = await db.ref('userConversations/' + currentUser.uid + '/' + convId).once('value');

                if (!existingConv.exists()) {
                    // Pseudo depuis les contacts locaux (pas de lecture users/)
                    const otherPseudo = (contacts[otherUserId] && contacts[otherUserId].pseudo) || 'Utilisateur';

                    await db.ref('userConversations/' + currentUser.uid + '/' + convId).set({
                        type: 'dm',
                        otherPseudo: otherPseudo,
                        participants: [currentUser.uid, otherUserId],
                        lastMessage: '',
                        lastTime: Date.now(),
                        unread: 0
                    });

                    await db.ref('userConversations/' + otherUserId + '/' + convId).set({
                        type: 'dm',
                        otherPseudo: currentUserProfile.pseudo,
                        participants: [currentUser.uid, otherUserId],
                        lastMessage: '',
                        lastTime: Date.now(),
                        unread: 0
                    });
                }

                openChat('dm', convId);
                closeModal('addContact');
            } catch (err) {
                console.error('Erreur startDM:', err);
            }
        }

        // ==================== OPEN CHAT ====================
        async function openChat(type, id) {
            // Clear previous listener
            if (messageListeners[currentChat]) {
                db.ref(messageListeners[currentChat].path).off('child_added', messageListeners[currentChat].callback);
            }

            currentChatType = type;
            currentChat = id;

            document.getElementById('noChat').style.display = 'none';
            document.getElementById('activeChat').style.display = 'flex';
            document.getElementById('activeChat').style.flexDirection = 'column';

            const messagesContainer = document.getElementById('messagesContainer');
            messagesContainer.innerHTML = '';

            // Update header based on type
            const avatar = document.getElementById('chatAvatar');
            const nameEl = document.getElementById('chatName');
            const statusEl = document.getElementById('chatStatus');

            if (type === 'dm') {
                const conv = conversations[id];
                if (conv) {
                    // Pseudo stock√© dans la conversation ou depuis les contacts locaux
                    const otherUserId = conv.participants ? conv.participants.find(p => p !== currentUser.uid) : null;
                    const otherPseudo = conv.otherPseudo || (otherUserId && contacts[otherUserId] && contacts[otherUserId].pseudo) || 'Utilisateur';

                    avatar.className = 'conv-avatar user';
                    avatar.textContent = otherPseudo.charAt(0).toUpperCase();
                    nameEl.textContent = otherPseudo;
                    statusEl.textContent = 'Message priv√©';
                    statusEl.className = 'chat-header-status';
                }
                document.getElementById('leaveGroupBtn').style.display = 'none';
                document.getElementById('videoCallBtn').style.display = 'flex';

                loadMessages('dmMessages/' + id);
            } else if (type === 'group') {
                const conv = conversations[id];
                if (conv) {
                    avatar.className = 'conv-avatar group';
                    avatar.textContent = conv.name.charAt(0).toUpperCase();
                    nameEl.textContent = conv.name;

                    const groupSnap = await db.ref('groups/' + id + '/members').once('value');
                    const memberCount = groupSnap.exists() ? Object.keys(groupSnap.val()).length : 0;
                    statusEl.textContent = `${memberCount} membres`;
                    statusEl.className = 'chat-header-status';
                }
                document.getElementById('leaveGroupBtn').style.display = 'block';
                document.getElementById('videoCallBtn').style.display = 'none';

                loadMessages('groupMessages/' + id);
            }

            // Mark as read
            if (type !== 'public') {
                await db.ref('userConversations/' + currentUser.uid + '/' + id + '/unread').set(0);
            }

            // Update active state in sidebar
            document.querySelectorAll('.conv-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.id === id) item.classList.add('active');
            });

            // Mobile: close sidebar
            closeSidebar();
        }

        // ==================== MESSAGES ====================
        function loadMessages(path) {
            const container = document.getElementById('messagesContainer');

            const callback = snapshot => {
                const msg = snapshot.val();
                if (msg) displayMessage(msg);
            };

            db.ref(path).orderByChild('timestamp').limitToLast(100).on('child_added', callback);

            messageListeners[currentChat] = { path, callback };
        }

        function displayMessage(msg) {
            const container = document.getElementById('messagesContainer');
            const div = document.createElement('div');

            if (msg.type === 'system') {
                div.className = 'message-system ' + (msg.action || '');
                div.textContent = msg.text || `${msg.user} ${msg.action === 'join' ? 'a rejoint' : 'a quitt√©'}`;
            } else {
                const isOwn = msg.oderId === currentUser.uid || msg.oderId === currentUserProfile?.oderId;
                div.className = 'message' + (isOwn ? ' own' : '');

                const initial = (msg.user || '?').charAt(0).toUpperCase();
                const time = msg.timestamp ? formatTime(msg.timestamp) : '';

                div.innerHTML = `
                    <div class="message-avatar">${initial}</div>
                    <div class="message-content">
                        <div class="message-sender">${escapeHtml(msg.user || 'Anonyme')}</div>
                        <div class="message-text">${formatMessageText(msg)}</div>
                        <div class="message-time">${time}</div>
                    </div>
                `;
            }

            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function formatMessageText(msg) {
            if (msg.type === 'gif' && msg.url) {
                return `<img src="${escapeHtml(msg.url)}" alt="GIF" onerror="this.style.display='none'">`;
            }
            return escapeHtml(msg.text || '');
        }

        // ==================== SEND MESSAGE ====================
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();

            if (!text || !currentChat) return;

            let path;
            if (currentChatType === 'dm') {
                path = 'dmMessages/' + currentChat;
            } else if (currentChatType === 'group') {
                path = 'groupMessages/' + currentChat;
            }

            const message = {
                type: 'message',
                user: currentUserProfile.pseudo,
                oderId: currentUser.uid,
                text: text,
                timestamp: Date.now()
            };

            await db.ref(path).push(message);

            // Update last message in conversation
            if (currentChatType !== 'public') {
                const update = {
                    lastMessage: text.substring(0, 50),
                    lastTime: Date.now()
                };

                if (currentChatType === 'dm') {
                    const conv = conversations[currentChat];
                    if (conv) {
                        for (const oderId of conv.participants) {
                            await db.ref('userConversations/' + oderId + '/' + currentChat).update(update);

                            // Increment unread for other user
                            if (oderId !== currentUser.uid) {
                                await db.ref('userConversations/' + oderId + '/' + currentChat + '/unread').transaction(n => (n || 0) + 1);
                            }
                        }
                    }
                } else if (currentChatType === 'group') {
                    const groupSnap = await db.ref('groups/' + currentChat + '/members').once('value');
                    if (groupSnap.exists()) {
                        for (const oderId of Object.keys(groupSnap.val())) {
                            await db.ref('userConversations/' + oderId + '/' + currentChat).update(update);

                            if (oderId !== currentUser.uid) {
                                await db.ref('userConversations/' + oderId + '/' + currentChat + '/unread').transaction(n => (n || 0) + 1);
                            }
                        }
                    }
                }
            }

            input.value = '';
        }

        // ==================== CHAT INFO ====================
        async function openChatInfo() {
            const content = document.getElementById('chatInfoContent');

            if (currentChatType === 'dm') {
                const conv = conversations[currentChat];
                if (conv) {
                    const otherUserId = conv.participants ? conv.participants.find(p => p !== currentUser.uid) : null;
                    const otherPseudo = conv.otherPseudo || (otherUserId && contacts[otherUserId] && contacts[otherUserId].pseudo) || 'Utilisateur';

                    content.innerHTML = `
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div class="conv-avatar user" style="width: 80px; height: 80px; font-size: 2rem; margin: 0 auto 15px;">
                                ${otherPseudo.charAt(0).toUpperCase()}
                            </div>
                            <h3>${escapeHtml(otherPseudo)}</h3>
                            <p style="color: var(--text-secondary);">Message priv√©</p>
                        </div>
                    `;
                }
            } else if (currentChatType === 'group') {
                const groupSnap = await db.ref('groups/' + currentChat).once('value');
                const group = groupSnap.val();

                if (group) {
                    let membersHTML = '';
                    for (const [oderId, data] of Object.entries(group.members)) {
                        // Pseudo depuis contacts locaux ou profil courant
                        const pseudo = oderId === currentUser.uid
                            ? currentUserProfile.pseudo
                            : (contacts[oderId] && contacts[oderId].pseudo) || 'Utilisateur';
                        const role = data.role === 'admin' ? 'üëë Admin' : 'Membre';
                        membersHTML += `
                            <div class="user-item">
                                <div class="user-item-avatar">${pseudo.charAt(0).toUpperCase()}</div>
                                <div class="user-item-info">
                                    <div class="user-item-name">${escapeHtml(pseudo)}</div>
                                    <div class="user-item-status">${role}</div>
                                </div>
                            </div>
                        `;
                    }

                    content.innerHTML = `
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div class="conv-avatar group" style="width: 80px; height: 80px; font-size: 2rem; margin: 0 auto 15px;">
                                ${group.name.charAt(0).toUpperCase()}
                            </div>
                            <h3>${escapeHtml(group.name)}</h3>
                            <p style="color: var(--text-secondary);">${escapeHtml(group.description || 'Aucune description')}</p>
                        </div>
                        <h4 style="margin: 20px 0 10px; color: var(--cyan);">üë• Membres (${Object.keys(group.members).length})</h4>
                        ${membersHTML}
                    `;
                }
            }

            openModal('chatInfo');
        }

        async function leaveGroup() {
            if (!currentChat || currentChatType !== 'group') return;

            if (!confirm('Voulez-vous vraiment quitter ce groupe ?')) return;

            // Remove from group members
            await db.ref('groups/' + currentChat + '/members/' + currentUser.uid).remove();

            // Remove from user conversations
            await db.ref('userConversations/' + currentUser.uid + '/' + currentChat).remove();

            // System message
            await db.ref('groupMessages/' + currentChat).push({
                type: 'system',
                text: `${currentUserProfile.pseudo} a quitt√© le groupe`,
                timestamp: Date.now()
            });

            closeModal('chatInfo');
            currentChat = null;
            currentChatType = null;
            document.getElementById('noChat').style.display = 'flex';
            document.getElementById('activeChat').style.display = 'none';
        }

        // ==================== MODALS ====================
        function openModal(name) {
            document.getElementById('modal' + capitalize(name)).classList.add('active');
        }

        function closeModal(name) {
            document.getElementById('modal' + capitalize(name)).classList.remove('active');
        }

        // ==================== MOBILE ====================
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active', sidebar.classList.contains('open'));
        }

        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('sidebarOverlay').classList.remove('active');
        }

        // Gestion du clavier virtuel Android
        const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
        if (isMobile && window.visualViewport) {
            window.visualViewport.addEventListener('resize', () => {
                const container = document.getElementById('messagesContainer');
                if (container) {
                    setTimeout(() => container.scrollTop = container.scrollHeight, 100);
                }
            });

            const msgInput = document.getElementById('messageInput');
            if (msgInput) {
                msgInput.addEventListener('focus', () => {
                    setTimeout(() => {
                        const container = document.getElementById('messagesContainer');
                        if (container) container.scrollTop = container.scrollHeight;
                        msgInput.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                    }, 300);
                });
            }
        }

        // ==================== UTILITIES ====================
        // Charge depuis js/firebase-config.js

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();

            if (date.toDateString() === now.toDateString()) {
                return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            } else {
                return date.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' });
            }
        }

        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // ==================== VIDEO CALL PRIVE (DM) ====================
        function startVideoCall() {
            if (!currentChat || currentChatType !== 'dm') return;
            const conv = conversations[currentChat];
            if (!conv) return;
            const otherUserId = conv.participants ? conv.participants.find(p => p !== currentUser.uid) : null;
            const otherPseudo = conv.otherPseudo || (otherUserId && contacts[otherUserId] && contacts[otherUserId].pseudo) || 'Utilisateur';
            document.getElementById('vcCallName').textContent = otherPseudo;
            DMVideoChat.currentConvId = currentChat;
            openModal('videoCall');
        }

        const DMVideoChat = {
            joined: false,
            localStream: null,
            localVideoEl: null,
            peers: {},
            remoteStreams: {},
            myVideoId: null,
            currentConvId: null,
            roomRef: null,
            participantsRef: null,
            signalsRef: null,
            micEnabled: true,
            camEnabled: true,
            _qualityInterval: null,
            currentQuality: 'high',

            ICE_SERVERS: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: 'stun:stun2.l.google.com:19302' },
                    {
                        urls: 'turn:openrelay.metered.ca:80',
                        username: 'openrelayproject',
                        credential: 'openrelayproject'
                    },
                    {
                        urls: 'turn:openrelay.metered.ca:443',
                        username: 'openrelayproject',
                        credential: 'openrelayproject'
                    },
                    {
                        urls: 'turn:openrelay.metered.ca:443?transport=tcp',
                        username: 'openrelayproject',
                        credential: 'openrelayproject'
                    }
                ],
                iceCandidatePoolSize: 10
            },

            VIDEO_CONSTRAINTS: {
                high: { width: { ideal: 1280, max: 1920 }, height: { ideal: 720, max: 1080 }, frameRate: { ideal: 30 }, facingMode: 'user' },
                medium: { width: { ideal: 640, max: 1280 }, height: { ideal: 480, max: 720 }, frameRate: { ideal: 24 }, facingMode: 'user' },
                low: { width: { ideal: 320, max: 640 }, height: { ideal: 240, max: 480 }, frameRate: { ideal: 15 }, facingMode: 'user' }
            },

            AUDIO_CONSTRAINTS: {
                echoCancellation: true,
                noiseSuppression: true,
                autoGainControl: true,
                sampleRate: 48000,
                channelCount: 1
            },

            BITRATE: { videoMax: 1500, videoMin: 150, audioMax: 64 },

            async joinCall() {
                if (this.joined || !this.currentConvId) return;
                const joinBtn = document.getElementById('vcJoinBtn');
                joinBtn.disabled = true;
                joinBtn.textContent = 'Connexion...';

                if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                    alert('La vid√©o n√©cessite une connexion HTTPS s√©curis√©e.');
                    joinBtn.disabled = false;
                    joinBtn.textContent = 'üìπ Rejoindre l\'appel';
                    return;
                }

                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    alert('Votre navigateur ne supporte pas la vid√©o.');
                    joinBtn.disabled = false;
                    joinBtn.textContent = 'üìπ Rejoindre l\'appel';
                    return;
                }

                // Limite 2 participants pour DM
                try {
                    const snap = await db.ref('dmVideoRoom/' + this.currentConvId + '/participants').once('value');
                    if (snap.exists() && Object.keys(snap.val()).length >= 2) {
                        alert('L\'appel est d√©j√† en cours avec 2 participants.');
                        joinBtn.disabled = false;
                        joinBtn.textContent = 'üìπ Rejoindre l\'appel';
                        return;
                    }
                } catch (e) {}

                // Obtenir le flux media
                const qualities = ['high', 'medium', 'low'];
                let streamOk = false;
                for (const q of qualities) {
                    try {
                        this.localStream = await navigator.mediaDevices.getUserMedia({
                            video: this.VIDEO_CONSTRAINTS[q],
                            audio: this.AUDIO_CONSTRAINTS
                        });
                        this.currentQuality = q;
                        streamOk = true;
                        break;
                    } catch (err) {
                        console.warn('getUserMedia failed at', q, ':', err.name);
                    }
                }
                if (!streamOk) {
                    try {
                        this.localStream = await navigator.mediaDevices.getUserMedia({ video: false, audio: this.AUDIO_CONSTRAINTS });
                        this.camEnabled = false;
                        streamOk = true;
                    } catch (err2) {
                        let msg = 'Impossible d\'acc√©der √† la cam√©ra ou au micro.\n\n';
                        if (err2.name === 'NotAllowedError') msg += 'Autorisez l\'acc√®s dans les param√®tres de votre navigateur.';
                        else if (err2.name === 'NotFoundError') msg += 'Aucune cam√©ra ou micro d√©tect√©.';
                        else msg += 'Erreur : ' + (err2.message || err2.name);
                        alert(msg);
                        joinBtn.disabled = false;
                        joinBtn.textContent = 'üìπ Rejoindre l\'appel';
                        return;
                    }
                }

                this.joined = true;
                this.myVideoId = 'v_' + crypto.getRandomValues(new Uint32Array(1))[0].toString(36) + '_' + Date.now();

                // Afficher l'UI
                document.getElementById('vcJoinScreen').style.display = 'none';
                document.getElementById('vcControls').style.display = 'flex';

                const grid = document.getElementById('vcVideoGrid');
                grid.style.display = 'flex';
                grid.innerHTML = '';

                // Video locale
                this.addVideoCell(this.myVideoId, currentUserProfile.pseudo + ' (vous)', true);
                const localVideoEl = document.querySelector(`[data-peer="${this.myVideoId}"] video`);
                if (localVideoEl) {
                    localVideoEl.srcObject = this.localStream;
                    localVideoEl.muted = true;
                    this.playVideo(localVideoEl);
                }
                this.localVideoEl = localVideoEl;

                this.startQualityMonitor();

                // Firebase signaling par conversation
                this.roomRef = db.ref('dmVideoRoom/' + this.currentConvId);
                this.participantsRef = this.roomRef.child('participants');
                this.signalsRef = this.roomRef.child('signals');

                const myRef = this.participantsRef.child(this.myVideoId);
                myRef.set({
                    uid: currentUser.uid,
                    name: currentUserProfile.pseudo,
                    joinedAt: Date.now(),
                    mic: this.micEnabled,
                    cam: this.camEnabled
                });
                myRef.onDisconnect().remove();
                this.signalsRef.child(this.myVideoId).onDisconnect().remove();

                // Ecouter les participants
                this.participantsRef.on('child_added', snap => {
                    const peerId = snap.key;
                    if (peerId === this.myVideoId) return;
                    const data = snap.val();
                    this.addVideoCell(peerId, data.name, false);
                    this.updateParticipantCount();
                    if (this.myVideoId > peerId) {
                        this.createOffer(peerId);
                    }
                });

                this.participantsRef.on('child_removed', snap => {
                    const peerId = snap.key;
                    this.removePeer(peerId);
                    this.updateParticipantCount();
                });

                this.participantsRef.on('child_changed', snap => {
                    const peerId = snap.key;
                    if (peerId === this.myVideoId) return;
                    const data = snap.val();
                    const nameTag = document.querySelector(`[data-peer="${peerId}"] .vc-nametag`);
                    if (nameTag) {
                        nameTag.innerHTML = data.name + (!data.mic ? ' üîá' : '');
                    }
                });

                // Ecouter les signaux
                this.signalsRef.child(this.myVideoId).on('child_added', async snap => {
                    const signal = snap.val();
                    if (!signal) return;
                    try {
                        if (signal.type === 'offer') await this.handleOffer(signal.from, signal.sdp);
                        else if (signal.type === 'answer') await this.handleAnswer(signal.from, signal.sdp);
                        else if (signal.type === 'ice') await this.handleIce(signal.from, signal.candidate);
                    } catch (e) {
                        console.error('Signal error:', e);
                    }
                    snap.ref.remove();
                });

                this.updateParticipantCount();
            },

            async createOffer(peerId) {
                const pc = this.createPeerConnection(peerId);
                try {
                    const offer = await pc.createOffer();
                    await pc.setLocalDescription(offer);
                    await this.signalsRef.child(peerId).push({
                        type: 'offer', from: this.myVideoId, sdp: offer.sdp
                    });
                } catch (e) { console.error('Offer error:', e); }
            },

            async handleOffer(fromId, sdp) {
                const pc = this.createPeerConnection(fromId);
                try {
                    await pc.setRemoteDescription(new RTCSessionDescription({ type: 'offer', sdp }));
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);
                    await this.signalsRef.child(fromId).push({
                        type: 'answer', from: this.myVideoId, sdp: answer.sdp
                    });
                } catch (e) { console.error('Answer error:', e); }
            },

            async handleAnswer(fromId, sdp) {
                const pc = this.peers[fromId];
                if (pc && pc.signalingState !== 'stable') {
                    try { await pc.setRemoteDescription(new RTCSessionDescription({ type: 'answer', sdp })); }
                    catch (e) { console.error('Set answer error:', e); }
                }
            },

            async handleIce(fromId, candidate) {
                const pc = this.peers[fromId];
                if (pc && candidate) {
                    try { await pc.addIceCandidate(new RTCIceCandidate(candidate)); }
                    catch (e) { console.error('ICE error:', e); }
                }
            },

            createPeerConnection(peerId) {
                if (this.peers[peerId]) this.peers[peerId].close();
                const pc = new RTCPeerConnection(this.ICE_SERVERS);
                this.peers[peerId] = pc;

                if (this.localStream) {
                    this.localStream.getTracks().forEach(track => {
                        const sender = pc.addTrack(track, this.localStream);
                        if (track.kind === 'video') this.applyBitrateLimit(sender, 'video');
                        else if (track.kind === 'audio') this.applyBitrateLimit(sender, 'audio');
                    });
                }

                pc.onicecandidate = event => {
                    if (event.candidate) {
                        this.signalsRef.child(peerId).push({
                            type: 'ice', from: this.myVideoId, candidate: event.candidate.toJSON()
                        });
                    }
                };

                pc.ontrack = event => {
                    const stream = event.streams[0];
                    if (stream) {
                        this.remoteStreams[peerId] = stream;
                        const videoEl = document.querySelector(`[data-peer="${peerId}"] video`);
                        if (videoEl) {
                            videoEl.srcObject = stream;
                            this.playVideo(videoEl);
                        }
                    }
                };

                pc.onconnectionstatechange = () => {
                    if (pc.connectionState === 'failed') {
                        pc.close();
                        delete this.peers[peerId];
                        if (this.myVideoId > peerId) {
                            setTimeout(() => this.createOffer(peerId), 1000);
                        }
                    }
                };

                return pc;
            },

            async applyBitrateLimit(sender, kind) {
                try {
                    const params = sender.getParameters();
                    if (!params.encodings || params.encodings.length === 0) params.encodings = [{}];
                    if (kind === 'video') {
                        params.encodings[0].maxBitrate = this.BITRATE.videoMax * 1000;
                        params.degradationPreference = 'balanced';
                    } else {
                        params.encodings[0].maxBitrate = this.BITRATE.audioMax * 1000;
                    }
                    await sender.setParameters(params);
                } catch (e) {}
            },

            startQualityMonitor() {
                if (this._qualityInterval) clearInterval(this._qualityInterval);
                this._qualityInterval = setInterval(() => this.checkNetworkQuality(), 5000);
            },

            stopQualityMonitor() {
                if (this._qualityInterval) { clearInterval(this._qualityInterval); this._qualityInterval = null; }
            },

            async checkNetworkQuality() {
                for (const [peerId, pc] of Object.entries(this.peers)) {
                    try {
                        const stats = await pc.getStats();
                        stats.forEach(report => {
                            if (report.type === 'outbound-rtp' && report.kind === 'video') {
                                const lossRate = (report.packetsLost || 0) / ((report.packetsSent || 1) + (report.packetsLost || 0));
                                if (lossRate > 0.1 && this.currentQuality !== 'low') this.downgradeQuality();
                                else if (lossRate < 0.02 && this.currentQuality !== 'high') this.upgradeQuality();
                            }
                        });
                    } catch (e) {}
                }
            },

            async downgradeQuality() {
                const levels = ['high', 'medium', 'low'];
                const idx = levels.indexOf(this.currentQuality);
                if (idx < levels.length - 1) {
                    this.currentQuality = levels[idx + 1];
                    await this.applyVideoConstraints(this.currentQuality);
                }
            },

            async upgradeQuality() {
                const levels = ['high', 'medium', 'low'];
                const idx = levels.indexOf(this.currentQuality);
                if (idx > 0) {
                    this.currentQuality = levels[idx - 1];
                    await this.applyVideoConstraints(this.currentQuality);
                }
            },

            async applyVideoConstraints(quality) {
                if (!this.localStream) return;
                const videoTrack = this.localStream.getVideoTracks()[0];
                if (!videoTrack) return;
                try {
                    await videoTrack.applyConstraints(this.VIDEO_CONSTRAINTS[quality]);
                    const bitrateMap = { high: 1500, medium: 800, low: 300 };
                    for (const pc of Object.values(this.peers)) {
                        for (const sender of pc.getSenders()) {
                            if (sender.track && sender.track.kind === 'video') {
                                const params = sender.getParameters();
                                if (params.encodings && params.encodings.length > 0) {
                                    params.encodings[0].maxBitrate = (bitrateMap[quality] || 800) * 1000;
                                    await sender.setParameters(params);
                                }
                            }
                        }
                    }
                } catch (e) {}
            },

            playVideo(videoEl, retries = 5) {
                if (!videoEl) return;
                videoEl.controls = false;
                videoEl.playsInline = true;
                videoEl.setAttribute('playsinline', '');
                const attempt = () => {
                    const p = videoEl.play();
                    if (p && p.catch) {
                        p.catch(() => {
                            if (retries > 0) { retries--; setTimeout(attempt, 500); }
                        });
                    }
                };
                if (videoEl.readyState >= 2) attempt();
                else {
                    videoEl.addEventListener('loadedmetadata', () => attempt(), { once: true });
                    setTimeout(attempt, 1000);
                }
            },

            addVideoCell(peerId, name, isLocal) {
                const grid = document.getElementById('vcVideoGrid');
                if (grid.querySelector(`[data-peer="${peerId}"]`)) return;

                const cell = document.createElement('div');
                cell.className = 'vc-cell' + (isLocal ? ' local' : '');
                cell.dataset.peer = peerId;

                const video = document.createElement('video');
                video.autoplay = true;
                video.playsInline = true;
                video.setAttribute('playsinline', '');
                video.controls = false;
                if (isLocal) video.muted = true;
                cell.appendChild(video);

                const tag = document.createElement('div');
                tag.className = 'vc-nametag';
                tag.textContent = name || '?';
                cell.appendChild(tag);

                grid.appendChild(cell);
            },

            removePeer(peerId) {
                if (this.peers[peerId]) { this.peers[peerId].close(); delete this.peers[peerId]; }
                delete this.remoteStreams[peerId];
                const cell = document.querySelector(`[data-peer="${peerId}"]`);
                if (cell) cell.remove();
                if (this.signalsRef) this.signalsRef.child(peerId).child(this.myVideoId).remove();
            },

            updateParticipantCount() {
                if (!this.participantsRef) return;
                this.participantsRef.once('value', snap => {
                    const n = snap.numChildren();
                    document.getElementById('vcParticipantCount').textContent = n + ' en appel';
                });
            },

            toggleMic() {
                if (!this.localStream) return;
                this.micEnabled = !this.micEnabled;
                this.localStream.getAudioTracks().forEach(t => t.enabled = this.micEnabled);
                const btn = document.getElementById('vcMicBtn');
                btn.textContent = this.micEnabled ? 'üé§' : 'üîá';
                btn.classList.toggle('off', !this.micEnabled);
                if (this.participantsRef && this.myVideoId) {
                    this.participantsRef.child(this.myVideoId).update({ mic: this.micEnabled });
                }
            },

            toggleCam() {
                if (!this.localStream) return;
                const videoTracks = this.localStream.getVideoTracks();
                if (videoTracks.length === 0) return;
                this.camEnabled = !this.camEnabled;
                videoTracks.forEach(t => t.enabled = this.camEnabled);
                const btn = document.getElementById('vcCamBtn');
                btn.textContent = this.camEnabled ? 'üìπ' : 'üì∑';
                btn.classList.toggle('off', !this.camEnabled);
                if (this.participantsRef && this.myVideoId) {
                    this.participantsRef.child(this.myVideoId).update({ cam: this.camEnabled });
                }
            },

            leaveCall() {
                this.joined = false;
                this.stopQualityMonitor();

                Object.keys(this.peers).forEach(id => { this.peers[id].close(); });
                this.peers = {};
                this.remoteStreams = {};

                if (this.localStream) {
                    this.localStream.getTracks().forEach(t => t.stop());
                    this.localStream = null;
                }

                if (this.participantsRef && this.myVideoId) this.participantsRef.child(this.myVideoId).remove();
                if (this.signalsRef && this.myVideoId) this.signalsRef.child(this.myVideoId).remove();

                if (this.participantsRef) this.participantsRef.off();
                if (this.signalsRef && this.myVideoId) this.signalsRef.child(this.myVideoId).off();

                if (this.localVideoEl) { this.localVideoEl.srcObject = null; this.localVideoEl = null; }
                document.getElementById('vcVideoGrid').innerHTML = '';
                document.getElementById('vcVideoGrid').style.display = 'none';
                document.getElementById('vcControls').style.display = 'none';
                document.getElementById('vcJoinScreen').style.display = 'block';

                const joinBtn = document.getElementById('vcJoinBtn');
                joinBtn.disabled = false;
                joinBtn.textContent = 'üìπ Rejoindre l\'appel';

                this.micEnabled = true;
                this.camEnabled = true;
                document.getElementById('vcMicBtn').textContent = 'üé§';
                document.getElementById('vcMicBtn').classList.remove('off');
                document.getElementById('vcCamBtn').textContent = 'üìπ';
                document.getElementById('vcCamBtn').classList.remove('off');

                closeModal('videoCall');
            }
        };

        // Cleanup video a la fermeture
        window.addEventListener('beforeunload', () => {
            if (DMVideoChat.joined) DMVideoChat.leaveCall();
        });
    </script>
</body>
</html>
