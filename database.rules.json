{
  "rules": {

    // ==================== REGLE PAR DEFAUT ====================
    // Tout ce qui n'est pas explicitement autorise est interdit
    ".read": false,
    ".write": false,

    // ==================== UTILISATEURS ====================
    "users": {
      "$uid": {
        ".read": "auth != null && auth.uid == $uid",
        ".write": "auth != null && auth.uid == $uid",
        ".validate": "newData.hasChildren(['email', 'pseudo', 'createdAt'])"
      }
    },

    // ==================== PSEUDOS (unicite) ====================
    "pseudos": {
      ".read": true,
      "$pseudo": {
        ".write": "auth != null && (!data.exists() || data.val() == auth.uid)",
        ".validate": "newData.val() == auth.uid"
      }
    },

    // ==================== COMPTEURS ====================
    "counters": {
      "visits": {
        ".read": true,
        ".write": true,
        ".validate": "newData.isNumber()"
      },
      "subscribers": {
        ".read": true,
        ".write": "auth != null",
        ".validate": "newData.isNumber()"
      },
      "iotQuestions": {
        ".read": true,
        ".write": "auth != null",
        ".validate": "newData.isNumber()"
      }
    },

    // ==================== CONTACT ====================
    // Les messages de contact sont en ecriture publique (formulaire anonyme)
    // mais en lecture uniquement pour l'admin
    "contactMessages": {
      ".read": "auth != null && auth.token.email === 'martialfabrice@tino-le-doc.com'",
      ".write": true,
      ".indexOn": ["timestamp"],
      "$msgId": {
        ".validate": "newData.hasChildren(['name', 'email', 'message', 'timestamp'])"
      }
    },

    // ==================== TCHAT PUBLIC ====================
    "chatMessages": {
      ".read": true,
      ".write": "auth != null",
      ".indexOn": ["timestamp"],
      "$msgId": {
        ".validate": "newData.hasChildren(['text', 'pseudo', 'timestamp']) && newData.child('text').isString() && newData.child('text').val().length <= 1000"
      }
    },

    "chatUsers": {
      ".read": true,
      "$userId": {
        ".write": "auth != null && auth.uid == $userId"
      }
    },

    "chatTyping": {
      ".read": true,
      "$userId": {
        ".write": "auth != null && auth.uid == $userId"
      }
    },

    // ==================== AVIS ====================
    "reviews": {
      ".read": true,
      ".write": "auth != null",
      ".indexOn": ["timestamp"],
      "$reviewId": {
        ".validate": "newData.hasChildren(['text', 'rating', 'timestamp']) && newData.child('rating').isNumber() && newData.child('rating').val() >= 1 && newData.child('rating').val() <= 5 && newData.child('text').isString() && newData.child('text').val().length <= 2000"
      }
    },

    // ==================== CONTACTS & AMIS ====================
    "contacts": {
      "$userId": {
        ".read": "auth != null && auth.uid == $userId",
        ".write": "auth != null && auth.uid == $userId"
      }
    },

    "friendRequests": {
      "$userId": {
        ".read": "auth != null && auth.uid == $userId",
        ".write": "auth != null"
      }
    },

    // ==================== MESSAGERIE PRIVEE ====================
    "userConversations": {
      "$userId": {
        ".read": "auth != null && auth.uid == $userId",
        ".write": "auth != null"
      }
    },

    "dmMessages": {
      "$convId": {
        ".read": "auth != null",
        ".write": "auth != null",
        ".indexOn": ["timestamp"],
        "$msgId": {
          ".validate": "newData.hasChildren(['text', 'senderId', 'timestamp']) && newData.child('text').isString() && newData.child('text').val().length <= 5000"
        }
      }
    },

    "groups": {
      "$groupId": {
        ".read": "auth != null",
        ".write": "auth != null"
      }
    },

    "groupMessages": {
      "$groupId": {
        ".read": "auth != null",
        ".write": "auth != null",
        ".indexOn": ["timestamp"]
      }
    },

    "dmVideoRoom": {
      "$convId": {
        ".read": "auth != null",
        ".write": "auth != null"
      }
    },

    "groupVideoRoom": {
      "$groupId": {
        ".read": "auth != null",
        ".write": "auth != null"
      }
    },

    // ==================== APPELS ENTRANTS ====================
    "incomingCalls": {
      "$userId": {
        ".read": "auth != null && auth.uid == $userId",
        ".write": "auth != null"
      }
    },

    // ==================== QUIZ ====================
    "quizScores": {
      ".read": true,
      ".write": "auth != null",
      ".indexOn": ["accuracy", "timestamp"],
      "$scoreId": {
        ".validate": "newData.hasChildren(['pseudo', 'accuracy', 'timestamp']) && newData.child('accuracy').isNumber()"
      }
    },

    // ==================== SONDAGES ====================
    "polls": {
      ".read": true,
      "$pollId": {
        ".write": "auth != null",
        "votes": {
          "$optionId": {
            ".write": "auth != null"
          }
        },
        "totalVotes": {
          ".write": "auth != null"
        }
      }
    },

    "dailyVotes": {
      ".read": true,
      "$date": {
        ".write": "auth != null"
      }
    },

    // ==================== DEBATS ====================
    "debates": {
      ".read": true,
      "$date": {
        ".write": "auth != null",
        "pour": {
          ".write": "auth != null"
        },
        "contre": {
          ".write": "auth != null"
        }
      }
    },

    "debateArguments": {
      ".read": true,
      "$date": {
        ".write": "auth != null",
        ".indexOn": ["likes", "timestamp"],
        "$argId": {
          ".write": "auth != null",
          "likes": {
            ".write": "auth != null"
          }
        }
      }
    },

    // ==================== FORUM ====================
    // Groupes de discussion publics/prives
    "forumGroups": {
      ".read": "auth != null",
      ".indexOn": ["category", "createdAt", "memberCount", "isPublic"],
      "$groupId": {
        ".write": "auth != null"
      }
    },

    // Membres des groupes forum
    "forumMembers": {
      "$groupId": {
        ".read": "auth != null",
        "$userId": {
          ".write": "auth != null"
        }
      }
    },

    // Messages des groupes forum
    "forumMessages": {
      "$groupId": {
        ".read": "auth != null",
        ".write": "auth != null",
        ".indexOn": ["timestamp", "isPinned"]
      }
    },

    // Invitations forum (groupes prives)
    "forumInvites": {
      "$userId": {
        ".read": "auth != null && auth.uid == $userId",
        ".write": "auth != null",
        ".indexOn": ["timestamp"]
      }
    },

    // ==================== VEILLE TECHNOLOGIQUE ====================
    // Seul l'admin peut creer/modifier/supprimer des articles
    // Les utilisateurs connectes peuvent liker
    "veilleArticles": {
      ".read": true,
      ".indexOn": ["timestamp", "likesCount", "category"],
      ".write": "auth != null && auth.token.email === 'martialfabrice@tino-le-doc.com'",
      "$articleId": {
        "likes": {
          "$uid": {
            ".write": "auth != null && auth.uid === $uid"
          }
        },
        "likesCount": {
          ".write": "auth != null"
        }
      }
    }
  }
}
